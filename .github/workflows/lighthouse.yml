name: Lighthouse Badges

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun --collect.settings.chromeFlags="--no-sandbox" || echo "Lighthouse finished with potential errors"

      - name: Generate Badges JSON
        id: lighthouse_badges
        run: |
          # Extract scores from the manifest file generated by LHCI
          # We need to find the manifest file first
          MANIFEST_PATH=$(find .lighthouseci -name "manifest.json" | head -n 1)
          
          if [ -f "$MANIFEST_PATH" ]; then
            echo "Found manifest at $MANIFEST_PATH"
            
            # Calculate average scores
            PERF=$(jq '[.[] | .summary.performance] | add / length * 100 | round' $MANIFEST_PATH)
            ACC=$(jq '[.[] | .summary.accessibility] | add / length * 100 | round' $MANIFEST_PATH)
            BP=$(jq '[.[] | .summary."best-practices"] | add / length * 100 | round' $MANIFEST_PATH)
            SEO=$(jq '[.[] | .summary.seo] | add / length * 100 | round' $MANIFEST_PATH)
            
            echo "Scores: Perf=$PERF, Acc=$ACC, BP=$BP, SEO=$SEO"
            
            # Create badge JSONs
            mkdir -p badges
            
            # Performance
            COLOR="red"
            if (( $(echo "$PERF >= 90" | bc -l) )); then COLOR="brightgreen"; elif (( $(echo "$PERF >= 50" | bc -l) )); then COLOR="orange"; fi
            echo "{ \"schemaVersion\": 1, \"label\": \"Performance\", \"message\": \"$PERF%\", \"color\": \"$COLOR\", \"namedLogo\": \"lighthouse\" }" > badges/performance.json
            
            # Accessibility
            COLOR="red"
            if (( $(echo "$ACC >= 90" | bc -l) )); then COLOR="brightgreen"; elif (( $(echo "$ACC >= 50" | bc -l) )); then COLOR="orange"; fi
            echo "{ \"schemaVersion\": 1, \"label\": \"Accessibility\", \"message\": \"$ACC%\", \"color\": \"$COLOR\", \"namedLogo\": \"lighthouse\" }" > badges/accessibility.json
            
            # Best Practices
            COLOR="red"
            if (( $(echo "$BP >= 90" | bc -l) )); then COLOR="brightgreen"; elif (( $(echo "$BP >= 50" | bc -l) )); then COLOR="orange"; fi
            echo "{ \"schemaVersion\": 1, \"label\": \"Best Practices\", \"message\": \"$BP%\", \"color\": \"$COLOR\", \"namedLogo\": \"lighthouse\" }" > badges/best-practices.json
            
            # SEO
            COLOR="red"
            if (( $(echo "$SEO >= 90" | bc -l) )); then COLOR="brightgreen"; elif (( $(echo "$SEO >= 50" | bc -l) )); then COLOR="orange"; fi
            echo "{ \"schemaVersion\": 1, \"label\": \"SEO\", \"message\": \"$SEO%\", \"color\": \"$COLOR\", \"namedLogo\": \"lighthouse\" }" > badges/seo.json
            
          else
            echo "Manifest not found!"
            exit 1
          fi

      - name: Deploy Badges
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./badges
          publish_branch: badges
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
