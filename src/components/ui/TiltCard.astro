---
interface Props {
  class?: string;
  maxTilt?: number;
  scale?: number;
  perspective?: number;
}

const {
  class: className = "",
  maxTilt = 10,
  scale = 1.02,
  perspective = 1000,
} = Astro.props;
---

<div
  class:list={["tilt-card", className]}
  data-max-tilt={maxTilt}
  data-scale={scale}
  data-perspective={perspective}
>
  <div class="tilt-shine"></div>
  <slot />
</div>

<script>
  /**
   * ⚡ Bolt: TiltCard performance optimization
   * Caches DOM references and pre-calculates values to reduce overhead
   * during frequent mousemove events.
   */
  function initTiltCards() {
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    const cards = document.querySelectorAll(
      ".tilt-card:not(.tilt-initialized)",
    );

    cards.forEach((card) => {
      const el = card as HTMLElement;
      const maxTilt = Number(el.dataset.maxTilt) || 10;

      card.classList.add("tilt-initialized");

      // ⚡ Cache the style object reference to avoid repeated lookups
      const cardStyle = el.style;

      card.addEventListener("mousemove", (e) => {
        const event = e as MouseEvent;
        const rect = (card as Element).getBoundingClientRect();

        // ⚡ Pre-calculate center coordinates
        const centerX = rect.width * 0.5;
        const centerY = rect.height * 0.5;

        // ⚡ Calculate relative position
        const relativeX = event.clientX - rect.left - centerX;
        const relativeY = event.clientY - rect.top - centerY;

        // ⚡ Calculate rotation with division by center values
        const rotateX = (relativeY / centerY) * -maxTilt;
        const rotateY = (relativeX / centerX) * maxTilt;

        // ⚡ Set CSS custom properties using cached style reference
        cardStyle.setProperty("--rotate-x", `${rotateX}deg`);
        cardStyle.setProperty("--rotate-y", `${rotateY}deg`);
      });

      card.addEventListener("mouseleave", () => {
        // ⚡ Use cached style reference
        cardStyle.setProperty("--rotate-x", "0deg");
        cardStyle.setProperty("--rotate-y", "0deg");
      });
    });
  }

  // Run on initial load
  initTiltCards();

  // Re-run on page transitions
  document.addEventListener("astro:page-load", initTiltCards);
</script>
