---
import { Icon } from "astro-icon/components";
---

<button
  type="button"
  class="theme-toggle-btn group relative ml-4 flex h-9 w-9 items-center justify-center rounded-lg bg-pacamara-primary/5 text-pacamara-secondary transition-all hover:bg-pacamara-accent hover:text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 dark:bg-pacamara-white/10 dark:text-pacamara-accent dark:hover:bg-pacamara-accent dark:hover:text-white"
  aria-label="Activer le mode sombre"
  title="Activer le mode sombre"
>
  <Icon
    name="mdi:weather-sunny"
    class="h-5 w-5 rotate-0 scale-100 transition-all duration-300 dark:-rotate-90 dark:scale-0"
  />
  <Icon
    name="mdi:weather-night"
    class="absolute h-5 w-5 rotate-90 scale-0 transition-all duration-300 dark:rotate-0 dark:scale-100"
  />
  <span class="sr-only">Activer le mode sombre</span>
</button>

<script>
  /**
   * ðŸŽ¨ Palette: Theme Switcher UX Improvement
   * - Uses class selector to support multiple instances (desktop/mobile)
   * - Dynamic aria-label and title for better accessibility
   * - Handles View Transitions properly
   */
  function initThemeToggle() {
    const buttons = document.querySelectorAll(".theme-toggle-btn");

    const updateLabels = (isDark: boolean) => {
      const label = isDark ? "Activer le mode clair" : "Activer le mode sombre";
      buttons.forEach((btn) => {
        btn.setAttribute("aria-label", label);
        btn.setAttribute("title", label);
        const span = btn.querySelector(".sr-only");
        if (span) span.textContent = label;
      });
    };

    // Initialize state
    const isDark = document.documentElement.classList.contains("dark");
    updateLabels(isDark);

    buttons.forEach((btn) => {
      // âš¡ Prevent duplicate listeners
      if ((btn as HTMLElement).dataset.initialized === "true") return;
      (btn as HTMLElement).dataset.initialized = "true";

      btn.addEventListener("click", () => {
        const element = document.documentElement;
        element.classList.toggle("dark");

        const isDarkNow = element.classList.contains("dark");
        localStorage.setItem("theme", isDarkNow ? "dark" : "light");
        updateLabels(isDarkNow);
      });
    });
  }

  // Initialize on load
  initThemeToggle();

  // Re-initialize after view transitions
  document.addEventListener("astro:after-swap", initThemeToggle);
</script>
