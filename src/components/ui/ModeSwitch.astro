<button
  class="group mode-switch-btn"
  title="Changer de mode"
  aria-label="Activer le mode sombre"
  aria-pressed="false"
>
  <svg
    height="512"
    viewBox="0 0 24 24"
    width="512"
    xmlns="http://www.w3.org/2000/svg"
    class="w-8 h-auto fill-pacamara-secondary transition-all duration-300 hover:fill-pacamara-accent dark:fill-white dark:hover:fill-pacamara-accent"
    aria-hidden="true"
  >
    <path
      d="m12 18a6 6 0 1 1 6-6 6 6 0 0 1 -6 6zm0-10a4 4 0 1 0 4 4 4 4 0 0 0 -4-4z"
    ></path><path d="m12 15a1 1 0 0 1 -1-1v-4a1 1 0 0 1 1-1 3 3 0 0 1 0 6z"
    ></path><path d="m12 5a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1z"
    ></path><path
      d="m17.66 7.34a1 1 0 0 1 -.66-.29 1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1 -.75.29z"
    ></path><path d="m21 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2z"></path><path
      d="m18.36 19.36a1 1 0 0 1 -.7-.29l-.66-.71a1 1 0 0 1 1.36-1.36l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.24z"
    ></path><path d="m12 22a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1z"
    ></path><path
      d="m5.64 19.36a1 1 0 0 1 -.71-.29 1 1 0 0 1 0-1.41l.71-.66a1 1 0 0 1 1.41 1.41l-.71.71a1 1 0 0 1 -.7.24z"
    ></path><path d="m4 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2z"></path><path
      d="m6.34 7.34a1 1 0 0 1 -.7-.29l-.71-.71a1 1 0 0 1 1.41-1.41l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.29z"
    ></path></svg
  >
</button>

<script is:inline>
  // Encapsulation pour éviter les conflits de déclaration
  (function () {
    // Fonction pour synchroniser l'état ARIA
    const updateAriaState = (isDark) => {
      const buttons = document.querySelectorAll(".mode-switch-btn");
      buttons.forEach((btn) => {
        btn.setAttribute("aria-pressed", isDark ? "true" : "false");
        btn.setAttribute(
          "aria-label",
          isDark ? "Désactiver le mode sombre" : "Activer le mode sombre",
        );
      });
    };

    // Fonction pour initialiser le thème
    const initTheme = () => {
      const isDark =
        localStorage.darkMode === "true" ||
        (!("darkMode" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches);

      if (isDark) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      updateAriaState(isDark);
    };

    // Initialisation immédiate pour éviter le flash
    initTheme();

    // Gestion du bouton
    const setDarkModeButton = () => {
      const buttons = document.querySelectorAll(".mode-switch-btn");

      buttons.forEach((button) => {
        // Cloner le bouton pour supprimer les écouteurs d'événements existants (utile avec View Transitions)
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener("click", function () {
          document.documentElement.classList.toggle("dark");
          const isDark = document.documentElement.classList.contains("dark");

          if (isDark) {
            localStorage.darkMode = "true";
          } else {
            localStorage.darkMode = "false";
          }
          updateAriaState(isDark);
        });
      });
    };

    // Exécuter au chargement initial
    setDarkModeButton();

    // Ré-exécuter après chaque navigation (View Transitions)
    document.addEventListener("astro:after-swap", () => {
      initTheme();
      setDarkModeButton();
    });
  })();
</script>
