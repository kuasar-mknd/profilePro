<button
  id="menu_toggle"
  class="block md:hidden text-white group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 rounded-lg p-1"
  type="button"
  aria-controls="navigation_wrapper"
  aria-expanded="false"
  aria-label="Ouvrir le menu"
  title="Ouvrir le menu"
>
  <div
    class="relative w-8 h-6 flex flex-col justify-between items-center group-hover:scale-105 transition-transform duration-300"
  >
    <span
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:rotate-45 group-aria-expanded:translate-x-1"
    ></span>
    <span
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 group-aria-expanded:opacity-0"
    ></span>
    <span
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:-rotate-45 group-aria-expanded:translate-x-1"
    ></span>
  </div>
</button>

<script>
  /**
   * ⚡ Bolt: HamburgerButton Performance Optimization
   * Added initialization guard to prevent duplicate observers and handlers
   */
  let menuObserver: MutationObserver | null = null;

  function menuToggle() {
    const button = document.querySelector("#menu_toggle");
    const nav = document.querySelector("#navigation_wrapper");

    // ⚡ Early return guards
    if (!button || !nav) return;
    if ((button as HTMLElement).dataset.initialized === "true") return;
    (button as HTMLElement).dataset.initialized = "true";

    button.addEventListener("click", function () {
      const isExpanded = button.getAttribute("aria-expanded") === "true";
      const newIsExpanded = !isExpanded;
      button.setAttribute("aria-expanded", String(newIsExpanded));
      button.setAttribute(
        "aria-label",
        newIsExpanded ? "Fermer le menu" : "Ouvrir le menu",
      );
      button.setAttribute(
        "title",
        newIsExpanded ? "Fermer le menu" : "Ouvrir le menu",
      );
      document.documentElement.classList.toggle("overflow-hidden");
      nav.classList.toggle("translate-x-full");
      nav.classList.toggle("translate-x-0");
    });

    nav.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        document.documentElement.classList.remove("overflow-hidden");
        button.setAttribute("aria-expanded", "false");
        button.setAttribute("aria-label", "Ouvrir le menu");
        button.setAttribute("title", "Ouvrir le menu");
        nav.classList.add("translate-x-full");
        nav.classList.remove("translate-x-0");
      });
    });

    // ⚡ Reuse observer if already created
    if (!menuObserver) {
      menuObserver = new MutationObserver((mutations) => {
        const btn = document.querySelector("#menu_toggle");
        const navEl = document.querySelector("#navigation_wrapper");
        if (!btn || !navEl) return;

        mutations.forEach((mutation) => {
          if (mutation.attributeName === "class") {
            const isMenuOpen =
              document.documentElement.classList.contains("overflow-hidden");
            btn.setAttribute("aria-expanded", String(isMenuOpen));

            if (isMenuOpen) {
              navEl.classList.remove("translate-x-full");
              navEl.classList.add("translate-x-0");
            } else {
              navEl.classList.add("translate-x-full");
              navEl.classList.remove("translate-x-0");
            }
          }
        });
      });
    }

    // ⚡ Always ensure observer is connected to current documentElement
    menuObserver.disconnect(); // Safety disconnect before reconnect
    menuObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }

  menuToggle();
  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", menuToggle);
</script>
