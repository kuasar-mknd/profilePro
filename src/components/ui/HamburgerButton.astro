<button
  id="menu_toggle"
  class="block md:hidden text-white group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 rounded-lg p-1"
  type="button"
  aria-controls="navigation_wrapper"
  aria-expanded="false"
  aria-label="Ouvrir le menu"
  title="Ouvrir le menu"
>
  <div
    class="relative w-8 h-6 flex flex-col justify-between items-center group-hover:scale-105 group-focus-visible:scale-105 transition-transform duration-300"
  >
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:rotate-45 group-aria-expanded:translate-x-1"
    ></span>
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 group-aria-expanded:opacity-0"
    ></span>
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:-rotate-45 group-aria-expanded:translate-x-1"
    ></span>
  </div>
  <span class="sr-only" aria-live="polite" id="menu-live-region"></span>
</button>

<script>
  /**
   * âš¡ Bolt: HamburgerButton Performance Optimization
   * Added initialization guard to prevent duplicate observers and handlers
   */
  let menuObserver: MutationObserver | null = null;
  // âš¡ Bolt: Module-scoped references for stable event handlers
  let menuButton: HTMLElement | null = null;
  let menuNav: HTMLElement | null = null;

  // ðŸŽ¨ Palette: Encapsulated close logic for reusability
  const closeMenu = () => {
    if (!menuButton || !menuNav) return;

    document.documentElement.classList.remove("overflow-hidden");
    menuButton.setAttribute("aria-expanded", "false");
    menuButton.setAttribute("aria-label", "Ouvrir le menu");
    menuButton.setAttribute("title", "Ouvrir le menu");
    menuButton.removeAttribute("aria-keyshortcuts");
    menuNav.classList.add("translate-x-full");
    menuNav.classList.remove("translate-x-0");

    // âš¡ Bolt: Wait for transition to finish before hiding (approx 300ms)
    setTimeout(() => {
      if (menuButton && menuButton.getAttribute("aria-expanded") === "false") {
        menuNav?.classList.add("invisible");
        // âš¡ Bolt: Remove GPU layer promotion to free memory
        if (menuNav) (menuNav as HTMLElement).style.willChange = "auto";
      }
    }, 300);
  };

  const openMenu = () => {
    if (!menuButton || !menuNav) return;

    // âš¡ Bolt: Make visible immediately so transition can be seen
    menuNav.classList.remove("invisible");

    // âš¡ Bolt: Promote layer for smooth animation
    (menuNav as HTMLElement).style.willChange = "transform";

    // Force reflow to ensure transition triggers
    void (menuNav as HTMLElement).offsetWidth;

    document.documentElement.classList.add("overflow-hidden");
    menuButton.setAttribute("aria-expanded", "true");
    menuButton.setAttribute("aria-label", "Fermer le menu");
    menuButton.setAttribute("title", "Fermer le menu");
    menuButton.setAttribute("aria-keyshortcuts", "Escape");
    menuNav.classList.remove("translate-x-full");
    menuNav.classList.add("translate-x-0");
  };

  // âš¡ Bolt: Module-scoped keydown handler
  const handleEscapeKey = (e: KeyboardEvent) => {
    if (
      e.key === "Escape" &&
      menuButton &&
      menuButton.getAttribute("aria-expanded") === "true"
    ) {
      closeMenu();
      // Return focus to the toggle button
      menuButton.focus();
    }
  };

  // âš¡ Bolt: Module-scoped click handler
  const handleMenuClick = () => {
    if (!menuButton) return;
    const isExpanded = menuButton.getAttribute("aria-expanded") === "true";

    // ðŸŽ¨ Palette: Announce menu state change to screen readers
    const liveRegion = document.getElementById("menu-live-region");

    if (isExpanded) {
      closeMenu();
      if (liveRegion) liveRegion.textContent = "Menu fermÃ©";
    } else {
      openMenu();
      if (liveRegion) liveRegion.textContent = "Menu ouvert";
    }
  };

  function menuToggle() {
    menuButton = document.querySelector("#menu_toggle");
    menuNav = document.querySelector("#navigation_wrapper");

    // âš¡ Early return guards
    if (!menuButton || !menuNav) return;

    // Check initialization on the button element itself to avoid double-binding
    if (menuButton.dataset.initialized === "true") return;
    menuButton.dataset.initialized = "true";

    // âš¡ Bolt: Cleanup and Re-bind Listeners
    menuButton.removeEventListener("click", handleMenuClick);
    menuButton.addEventListener("click", handleMenuClick);

    menuNav.querySelectorAll("a").forEach((link) => {
      // It's safe to add this multiple times as the function reference is stable,
      // but 'once: true' or removing it would be cleaner if links change.
      // However, link refs change on swap, so we just add to new links.
      link.addEventListener("click", closeMenu);
    });

    // ðŸŽ¨ Palette: Close menu on Escape key for accessibility
    // âš¡ Bolt: Use stable reference and remove before adding
    document.removeEventListener("keydown", handleEscapeKey);
    document.addEventListener("keydown", handleEscapeKey);

    // âš¡ Reuse observer if already created
    if (!menuObserver) {
      menuObserver = new MutationObserver((mutations) => {
        // We need to re-query here inside the callback or use module-scoped vars.
        // Module scoped vars are updated in menuToggle(), so they should be fresh.
        if (!menuButton || !menuNav) return;

        mutations.forEach((mutation) => {
          if (mutation.attributeName === "class") {
            const isMenuOpen =
              document.documentElement.classList.contains("overflow-hidden");
            menuButton?.setAttribute("aria-expanded", String(isMenuOpen));

            if (isMenuOpen) {
              // âš¡ Bolt: Handle external triggers (like resizing or other scripts)
              menuNav?.classList.remove("invisible");
              menuNav?.classList.remove("translate-x-full");
              menuNav?.classList.add("translate-x-0");
            } else {
              menuNav?.classList.add("translate-x-full");
              menuNav?.classList.remove("translate-x-0");
              // âš¡ Bolt: We can't guarantee a transition here easily, so we rely on the click handlers usually.
              // But if closed externally, ensure hidden eventually.
              if (
                menuNav?.classList.contains("translate-x-full") &&
                !menuNav?.classList.contains("transitioning")
              ) {
                // navEl.classList.add("invisible"); // Might cut off animation if triggered during anim.
              }
            }
          }
        });
      });
    }

    // âš¡ Always ensure observer is connected to current documentElement
    menuObserver.disconnect(); // Safety disconnect before reconnect
    menuObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }

  menuToggle();
  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", menuToggle);
</script>
