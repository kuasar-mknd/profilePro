<button
  id="menu_toggle"
  class="block md:hidden text-white group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 rounded-lg p-1"
  type="button"
  aria-controls="navigation_wrapper"
  aria-expanded="false"
  aria-label="Ouvrir le menu"
  title="Ouvrir le menu"
>
  <div
    class="relative w-8 h-6 flex flex-col justify-between items-center group-hover:scale-105 group-focus-visible:scale-105 transition-transform duration-300"
  >
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:rotate-45 group-aria-expanded:translate-x-1"
    ></span>
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 group-aria-expanded:opacity-0"
    ></span>
    <span
      aria-hidden="true"
      class="w-full h-0.5 bg-pacamara-dark dark:bg-pacamara-accent rounded-full transition-all duration-300 origin-left group-aria-expanded:-rotate-45 group-aria-expanded:translate-x-1"
    ></span>
  </div>
  <span class="sr-only" aria-live="polite" id="menu-live-region"></span>
</button>

<script>
  /**
   * âš¡ Bolt: HamburgerButton Performance Optimization
   * Added initialization guard to prevent duplicate observers and handlers
   */
  let cleanupMenu: (() => void) | null = null;

  function initMenu() {
    // âš¡ Bolt: Cleanup previous listeners to prevent memory leaks on navigation
    if (cleanupMenu) {
      cleanupMenu();
      cleanupMenu = null;
    }

    const button = document.querySelector("#menu_toggle");
    const nav = document.querySelector("#navigation_wrapper");

    // âš¡ Early return guards
    if (!button || !nav) return;
    if ((button as HTMLElement).dataset.initialized === "true") return;
    (button as HTMLElement).dataset.initialized = "true";

    // ðŸŽ¨ Palette: Encapsulated close logic for reusability
    const closeMenu = () => {
      document.documentElement.classList.remove("overflow-hidden");
      button.setAttribute("aria-expanded", "false");
      button.setAttribute("aria-label", "Ouvrir le menu");
      button.setAttribute("title", "Ouvrir le menu");
      button.removeAttribute("aria-keyshortcuts");
      nav.classList.add("translate-x-full");
      nav.classList.remove("translate-x-0");

      // âš¡ Bolt: Wait for transition to finish before hiding (approx 300ms)
      setTimeout(() => {
        if (button.getAttribute("aria-expanded") === "false") {
          nav.classList.add("invisible");
          // âš¡ Bolt: Remove GPU layer promotion to free memory
          (nav as HTMLElement).style.willChange = "auto";
        }
      }, 300);
    };

    const openMenu = () => {
      // âš¡ Bolt: Make visible immediately so transition can be seen
      nav.classList.remove("invisible");

      // âš¡ Bolt: Promote layer for smooth animation
      (nav as HTMLElement).style.willChange = "transform";

      // Force reflow to ensure transition triggers
      void (nav as HTMLElement).offsetWidth;

      document.documentElement.classList.add("overflow-hidden");
      button.setAttribute("aria-expanded", "true");
      button.setAttribute("aria-label", "Fermer le menu");
      button.setAttribute("title", "Fermer le menu (Esc)");
      button.setAttribute("aria-keyshortcuts", "Escape");
      nav.classList.remove("translate-x-full");
      nav.classList.add("translate-x-0");
    };

    button.addEventListener("click", function () {
      const isExpanded = button.getAttribute("aria-expanded") === "true";

      // ðŸŽ¨ Palette: Announce menu state change to screen readers
      const liveRegion = document.getElementById("menu-live-region");

      if (isExpanded) {
        closeMenu();
        if (liveRegion) liveRegion.textContent = "Menu fermÃ©";
      } else {
        openMenu();
        if (liveRegion) liveRegion.textContent = "Menu ouvert";
      }
    });

    nav.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", closeMenu);
    });

    // ðŸŽ¨ Palette: Close menu on Escape key for accessibility
    // Users expect Escape to close overlays/modals
    const handleEscape = (e: KeyboardEvent) => {
      if (
        e.key === "Escape" &&
        button.getAttribute("aria-expanded") === "true"
      ) {
        closeMenu();
        // Return focus to the toggle button
        (button as HTMLElement).focus();
      }
    };

    document.addEventListener("keydown", handleEscape);

    // âš¡ Bolt: Create a new observer for each page load to capture current elements
    const menuObserver = new MutationObserver((mutations) => {
      // âš¡ Bolt: We can either reuse the closure-captured `button`/`nav` (which are fresh for this call)
      // or look them up again. Since initMenu runs fresh, `button` and `nav` are correct.
      // But we must check if they are still connected to DOM (they should be unless swapped out)

      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class") {
          const isMenuOpen =
            document.documentElement.classList.contains("overflow-hidden");

          // Update aria-expanded if state changed externally
          if (button.getAttribute("aria-expanded") !== String(isMenuOpen)) {
            button.setAttribute("aria-expanded", String(isMenuOpen));
          }

          if (isMenuOpen) {
            // âš¡ Bolt: Handle external triggers (like resizing or other scripts)
            nav.classList.remove("invisible");
            nav.classList.remove("translate-x-full");
            nav.classList.add("translate-x-0");
          } else {
            nav.classList.add("translate-x-full");
            nav.classList.remove("translate-x-0");
            if (
              nav.classList.contains("translate-x-full") &&
              !nav.classList.contains("transitioning")
            ) {
              // nav.classList.add("invisible"); // Might cut off animation if triggered during anim.
            }
          }
        }
      });
    });

    menuObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    // âš¡ Register cleanup
    cleanupMenu = () => {
      document.removeEventListener("keydown", handleEscape);
      menuObserver.disconnect();
    };
  }

  // Use astro:page-load for initial load and subsequent navigations
  document.addEventListener("astro:page-load", initMenu);
</script>
