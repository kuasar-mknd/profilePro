---
/**
 * Lightbox.astro - Modal plein écran pour visualiser les images
 *
 * Fonctionnalités:
 * - Navigation clavier (←/→/Escape)
 * - Swipe tactile
 * - Compteur d'images
 * - Animation smooth
 */
---

<div
  id="lightbox"
  class="lightbox"
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
  aria-label="Galerie photos en plein écran"
>
  <div class="lightbox-backdrop"></div>

  <button
    type="button"
    class="lightbox-close"
    aria-label="Fermer"
    title="Fermer (Esc)"
    aria-keyshortcuts="Escape"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <button
    type="button"
    class="lightbox-nav lightbox-prev"
    aria-label="Image précédente"
    title="Image précédente (←)"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="32"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>

  <div class="lightbox-content">
    <img src="" alt="" class="lightbox-image" />
  </div>

  <div class="lightbox-loader" aria-hidden="true">
    <div class="spinner"></div>
  </div>

  <button
    type="button"
    class="lightbox-nav lightbox-next"
    aria-label="Image suivante"
    title="Image suivante (→)"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="32"
      height="32"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>

  <div class="lightbox-counter" aria-live="polite" aria-atomic="true">
    <span class="sr-only">Image </span>
    <span class="lightbox-current">1</span>
    <span aria-hidden="true"> / </span>
    <span class="sr-only"> sur </span>
    <span class="lightbox-total">1</span>
  </div>
</div>

<style>
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }

  .lightbox[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .lightbox-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 10;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .lightbox-content {
    position: relative;
    z-index: 5;
    max-width: 90vw;
    max-height: 85vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 85vh;
    object-fit: contain;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    opacity: 0;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
  }

  .lightbox[aria-hidden="false"] .lightbox-image {
    transform: scale(1);
    opacity: 1;
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-prev {
    left: 1.5rem;
  }

  .lightbox-next {
    right: 1.5rem;
  }

  .lightbox-counter {
    position: absolute;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 9999px;
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .lightbox-nav {
      padding: 0.75rem;
    }

    .lightbox-prev {
      left: 0.5rem;
    }

    .lightbox-next {
      right: 0.5rem;
    }

    .lightbox-close {
      top: 1rem;
      right: 1rem;
    }
  }

  .lightbox-loader {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .lightbox.loading .lightbox-loader {
    opacity: 1;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  class Lightbox {
    private lightbox: HTMLElement;
    private image: HTMLImageElement;
    private currentSpan: HTMLElement;
    private totalSpan: HTMLElement;
    private images: { src: string; alt: string }[] = [];
    private currentIndex: number = 0;
    private touchStartX: number = 0;
    private touchEndX: number = 0;
    private focusableElements: HTMLElement[] = [];
    private firstFocusableElement: HTMLElement | null = null;
    private lastFocusableElement: HTMLElement | null = null;
    private boundKeyHandler: (e: KeyboardEvent) => void;

    constructor() {
      this.boundKeyHandler = this.handleKeyboard.bind(this);
      this.lightbox = document.getElementById("lightbox")!;
      this.image = this.lightbox.querySelector(
        ".lightbox-image",
      ) as HTMLImageElement;
      this.currentSpan = this.lightbox.querySelector(".lightbox-current")!;
      this.totalSpan = this.lightbox.querySelector(".lightbox-total")!;

      // Identify focusable elements
      const focusableSelector =
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      this.focusableElements = Array.from(
        this.lightbox.querySelectorAll(focusableSelector),
      ) as HTMLElement[];
      this.firstFocusableElement = this.focusableElements[0];
      this.lastFocusableElement =
        this.focusableElements[this.focusableElements.length - 1];

      this.init();
    }

    private init() {
      // Close button
      this.lightbox
        .querySelector(".lightbox-close")
        ?.addEventListener("click", () => this.close());

      // Backdrop click
      this.lightbox
        .querySelector(".lightbox-backdrop")
        ?.addEventListener("click", () => this.close());

      // Navigation
      this.lightbox
        .querySelector(".lightbox-prev")
        ?.addEventListener("click", () => this.prev());
      this.lightbox
        .querySelector(".lightbox-next")
        ?.addEventListener("click", () => this.next());

      // Keyboard
      document.addEventListener("keydown", this.boundKeyHandler);

      // Touch events for swipe
      this.lightbox.addEventListener(
        "touchstart",
        (e) => this.handleTouchStart(e),
        { passive: true },
      );
      this.lightbox.addEventListener(
        "touchend",
        (e) => this.handleTouchEnd(e),
        { passive: true },
      );

      // Gallery image clicks
      document
        .querySelectorAll("[data-gallery-image]")
        .forEach((img, index) => {
          img.addEventListener("click", () => {
            this.collectImages();
            this.open(index, img as HTMLElement);
          });
          img.addEventListener("keydown", (e) => {
            const key = (e as KeyboardEvent).key;
            if (key === "Enter" || key === " ") {
              e.preventDefault();
              this.collectImages();
              this.open(index, img as HTMLElement);
            }
          });
        });
    }

    private collectImages() {
      const elements = document.querySelectorAll("[data-gallery-image]");

      this.images = Array.from(elements).map((element) => {
        const img = element as HTMLImageElement;
        // currentSrc is the actual URL the browser loaded
        const url = img.currentSrc || img.src;
        const alt = img.alt || "";
        return { src: url, alt };
      });
    }

    private triggerElement: HTMLElement | null = null;

    public open(index: number, trigger?: HTMLElement) {
      if (trigger) this.triggerElement = trigger;
      this.currentIndex = index;
      this.updateImage();
      this.lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      // Move focus to close button
      setTimeout(() => {
        const closeBtn = this.lightbox.querySelector(
          ".lightbox-close",
        ) as HTMLElement;
        closeBtn?.focus();
      }, 100);
    }

    public close() {
      this.lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      // Return focus to trigger
      if (this.triggerElement) {
        this.triggerElement.focus();
        this.triggerElement = null;
      }
    }

    public next() {
      this.currentIndex = (this.currentIndex + 1) % this.images.length;
      this.updateImage();
    }

    public prev() {
      this.currentIndex =
        (this.currentIndex - 1 + this.images.length) % this.images.length;
      this.updateImage();
    }

    private updateImage() {
      const currentImage = this.images[this.currentIndex];
      this.image.src = currentImage.src;
      this.image.alt = currentImage.alt || `Image ${this.currentIndex + 1}`;
      this.currentSpan.textContent = String(this.currentIndex + 1);
      this.totalSpan.textContent = String(this.images.length);

      // Loading state
      this.lightbox.classList.add("loading");
      this.image.style.opacity = "0";

      this.image.onload = () => {
        this.lightbox.classList.remove("loading");
        this.image.style.opacity = "1";
      };
    }

    private handleKeyboard(e: KeyboardEvent) {
      if (this.lightbox.getAttribute("aria-hidden") === "true") return;

      // Focus trap
      if (e.key === "Tab") {
        if (e.shiftKey) {
          if (document.activeElement === this.firstFocusableElement) {
            e.preventDefault();
            this.lastFocusableElement?.focus();
          }
        } else {
          if (document.activeElement === this.lastFocusableElement) {
            e.preventDefault();
            this.firstFocusableElement?.focus();
          }
        }
      }

      switch (e.key) {
        case "Escape":
          this.close();
          break;
        case "ArrowLeft":
          this.prev();
          break;
        case "ArrowRight":
          this.next();
          break;
      }
    }

    private handleTouchStart(e: TouchEvent) {
      this.touchStartX = e.changedTouches[0].screenX;
    }

    private handleTouchEnd(e: TouchEvent) {
      this.touchEndX = e.changedTouches[0].screenX;
      this.handleSwipe();
    }

    private handleSwipe() {
      const threshold = 50;
      const diff = this.touchStartX - this.touchEndX;

      if (Math.abs(diff) > threshold) {
        if (diff > 0) {
          this.next();
        } else {
          this.prev();
        }
      }
    }

    public destroy() {
      document.removeEventListener("keydown", this.boundKeyHandler);
    }
  }

  let lightboxInstance: Lightbox | null = null;

  function initLightbox() {
    if (lightboxInstance) {
      lightboxInstance.destroy();
    }
    lightboxInstance = new Lightbox();
  }

  // Initialize on page load (covers both initial load and view transitions)
  document.addEventListener("astro:page-load", initLightbox);
</script>
