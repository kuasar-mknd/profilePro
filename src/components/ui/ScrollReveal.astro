---
interface Props {
  direction?: "up" | "left" | "right" | "scale";
  delay?: number;
  threshold?: number;
  class?: string;
}

const {
  direction = "up",
  delay = 0,
  threshold = 0.1,
  class: className = "",
} = Astro.props;

const directionClass = {
  up: "will-change-transform",
  left: "from-left will-change-transform",
  right: "from-right will-change-transform",
  scale: "scale-in will-change-transform",
}[direction];

const staggerClass =
  delay > 0 ? `stagger-${Math.min(Math.ceil(delay * 10), 6)}` : "";
---

<div
  class:list={["reveal-on-scroll", directionClass, staggerClass, className]}
  data-threshold={threshold}
>
  <slot />
</div>

<script>
  /**
   * ⚡ Bolt: Cached IntersectionObserver singleton
   * Reuses a single observer across page transitions to reduce memory usage
   * and avoid creating multiple observers for the same purpose.
   */
  let cachedScrollRevealObserver: IntersectionObserver | null = null;

  function getScrollRevealObserver(): IntersectionObserver {
    // ⚡ Reuse existing observer instance
    if (cachedScrollRevealObserver) {
      return cachedScrollRevealObserver;
    }

    cachedScrollRevealObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add("visible");
            cachedScrollRevealObserver?.unobserve(entry.target);
          }
        });
      },
      {
        threshold: 0.1,
        rootMargin: "0px 0px -50px 0px",
      },
    );

    return cachedScrollRevealObserver;
  }

  function initScrollReveal() {
    const elements = document.querySelectorAll(
      ".reveal-on-scroll:not(.initialized)",
    );

    // Early return if no elements to process
    if (elements.length === 0) return;

    // Respect reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;

    if (prefersReducedMotion) {
      elements.forEach((el) => {
        el.classList.add("visible", "initialized");
        // Force immediate visibility styles
        (el as HTMLElement).style.opacity = "1";
        (el as HTMLElement).style.transform = "none";
      });
      return;
    }

    // ⚡ Get or create the singleton observer
    const observer = getScrollRevealObserver();

    elements.forEach((el) => {
      el.classList.add("initialized");
      observer.observe(el);
    });
  }

  // Run on initial load
  initScrollReveal();

  // Re-run on page transitions (Astro View Transitions)
  document.addEventListener("astro:page-load", initScrollReveal);
</script>
