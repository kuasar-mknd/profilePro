---
/**
 * ImageGallery.astro - Universal Image Gallery
 *
 * Usage:
 * 1. Automatic loading from folder: <ImageGallery folder="my-project" />
 * 2. Explicit image array: <ImageGallery images={myImagesArray} />
 */
import { Picture, getImage } from "astro:assets";
import { Icon } from "astro-icon/components";
import Skeleton from "./Skeleton.astro";
import EmptyState from "./EmptyState.astro";
import { limitConcurrency } from "../../utils/async";

interface Props {
  folder?: string;
  images?: ImageMetadata[];
  columns?: 2 | 3 | 4;
  excludePatterns?: string[];
  priorityCount?: number;
}

const {
  folder,
  images: explicitImages,
  columns = 3,
  excludePatterns = [],
  priorityCount = 0,
} = Astro.props;

let galleryImages: { src: ImageMetadata; filename: string; alt?: string }[] =
  [];

if (explicitImages && explicitImages.length > 0) {
  // Use explicit images if provided
  galleryImages = explicitImages.map((img, index) => ({
    src: img,
    filename: `image-${index}`,
    alt: `Photo ${index + 1}`,
  }));
} else if (folder) {
  // Load from folder
  const allImages = import.meta.glob<{ default: ImageMetadata }>(
    "../../assets/**/*.{avif,png,jpg,jpeg,webp,JPEG,PNG,JPG}",
    { eager: true },
  );

  galleryImages = Object.entries(allImages)
    .filter(([path]) => {
      const folderMatch = path.includes(`/${folder}/`);
      if (!folderMatch) return false;

      const isInSubfolder = path.split(`/${folder}/`)[1]?.includes("/");
      if (isInSubfolder) return false;

      for (const pattern of excludePatterns) {
        if (path.includes(pattern)) return false;
      }
      return true;
    })
    .map(([path, module]) => ({
      src: module.default,
      filename: path.split("/").pop() || "",
      alt: `Photo - ${folder}`,
    }))
    .sort((a, b) => a.filename.localeCompare(b.filename));
}

// âš¡ Bolt: Pre-generate optimized full-size images for Lightbox
// Serves 1600px WebP (Q80) instead of massive original uploads (often 5MB+) or tiny thumbnails
// âš¡ Bolt: Limit concurrency to 5 images to prevent build OOM
const optimizedImages = await limitConcurrency(
  galleryImages,
  5,
  async (img) => {
    const optimized = await getImage({
      src: img.src,
      width: 1600,
      format: "webp",
      quality: 80,
    });
    return {
      ...img,
      lightboxSrc: optimized.src,
    };
  },
);

// Column class mapping
const columnClasses = {
  2: "gallery-cols-2",
  3: "gallery-cols-3",
  4: "gallery-cols-4",
};
---

{
  optimizedImages.length > 0 ? (
    <div
      class={`image-gallery ${columnClasses[columns]}`}
      data-gallery-container
    >
      {optimizedImages.map((image, index) => (
        <figure class="gallery-item group relative cursor-pointer">
          <Skeleton class="absolute inset-0 z-10 transition-opacity duration-500" />
          {/* âš¡ Bolt: Smart Loading - Eager load priority images, lazy load the rest */}
          <Picture
            src={image.src}
            widths={[400, 800]}
            sizes="(max-width: 480px) 100vw, (max-width: 768px) 50vw, 33vw"
            formats={["avif", "webp"]}
            fallbackFormat="webp"
            alt={image.alt || `Photo ${index + 1}`}
            class="gallery-image focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
            data-gallery-image
            data-lightbox-src={image.lightboxSrc}
            tabindex="0"
            role="button"
            aria-haspopup="dialog"
            aria-label={`Ouvrir la photo ${index + 1} en plein Ã©cran`}
            title="Agrandir l'image"
            loading={index < priorityCount ? "eager" : "lazy"}
            decoding="async"
            fetchpriority={index < priorityCount ? "high" : "low"}
          />
          {/* ðŸŽ¨ Palette: Zoom Affordance Overlay - Visible on Hover AND Focus */}
          <div
            class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-300 bg-black/20 pointer-events-none z-20"
            aria-hidden="true"
          >
            <div class="bg-white/90 dark:bg-pacamara-dark/90 text-pacamara-primary dark:text-white p-3 rounded-full shadow-lg transform scale-75 group-hover:scale-100 group-focus-within:scale-100 group-hover:rotate-90 transition-all duration-300">
              <Icon name="mdi:magnify-plus-outline" class="w-6 h-6" />
            </div>
          </div>
        </figure>
      ))}
    </div>
  ) : (
    <EmptyState
      icon="mdi:image-off"
      message={
        folder
          ? `Aucune image trouvÃ©e dans le dossier "${folder}"`
          : "Aucune image Ã  afficher."
      }
    />
  )
}

<style>
  .image-gallery {
    column-gap: 1rem;
  }

  .gallery-cols-2 {
    column-count: 2;
  }

  .gallery-cols-3 {
    column-count: 3;
  }

  .gallery-cols-4 {
    column-count: 4;
  }

  .gallery-item {
    margin: 0;
    margin-bottom: 1rem;
    break-inside: avoid;
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
  }

  .gallery-image {
    width: 100%;
    display: block;
    cursor: pointer;
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
  }

  .gallery-item:hover .gallery-image,
  .gallery-item:focus-within .gallery-image {
    transform: scale(1.02);
  }

  .gallery-item::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.1) 0%, transparent 30%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 0.75rem;
  }

  .gallery-item:hover::after {
    opacity: 1;
  }

  /* Responsive columns */
  @media (max-width: 480px) {
    .gallery-cols-2,
    .gallery-cols-3,
    .gallery-cols-4 {
      column-count: 1;
    }

    /* âš¡ Bolt: Mobile Rendering Optimization
       On mobile (single column), we can safely skip rendering off-screen items
       without breaking masonry layout flow. This significantly reduces main-thread
       work during scrolling on lower-end devices.
    */
  }

  /* âš¡ Bolt: Universal Content Visibility
     Applied to all breakpoints to improve rendering performance of large galleries.
     The auto-sizing prevents scroll jumping.
  */
  .gallery-item {
    content-visibility: auto;
    contain-intrinsic-size: auto 300px; /* Approximate height of a gallery item */
    contain: layout; /* âš¡ Bolt: Isolate hover reflows */
  }
</style>

<script>
  /**
   * âš¡ Bolt: Event delegation optimization
   * Removed redundant keyboard listeners per gallery.
   * Interaction is now handled globally by Lightbox.astro via delegation.
   */
  function initGallery() {
    const galleries = document.querySelectorAll(
      "[data-gallery-container]:not(.gallery-initialized)",
    );

    galleries.forEach((gallery) => {
      // âš¡ Bolt: Initialize Skeleton loaders using event delegation (capture phase)
      // This reduces listener count from N (images) to 1 (container)
      const removeSkeleton = (img: HTMLImageElement) => {
        const figure = img.closest("figure");
        const skeleton = figure?.querySelector(".skeleton");
        if (skeleton) {
          skeleton.classList.add("opacity-0");
          setTimeout(() => skeleton.remove(), 500);
        }
      };

      // Check already loaded images
      const images = gallery.querySelectorAll(
        "img[data-gallery-image]",
      ) as NodeListOf<HTMLImageElement>;

      images.forEach((img) => {
        if (img.complete) {
          removeSkeleton(img);
        }
      });

      // Capture 'load' events for lazy-loaded images
      // Note: 'load' does not bubble, but it DOES capture.
      gallery.addEventListener(
        "load",
        (e: Event) => {
          const target = e.target as HTMLElement;
          if (target.matches("img[data-gallery-image]")) {
            removeSkeleton(target as HTMLImageElement);
          }
        },
        true, // Use capture phase
      );

      gallery.classList.add("gallery-initialized");
    });
  }

  // âš¡ Bolt: Singleton Listener Pattern for View Transitions
  function setupGalleryListeners() {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const win = window as any;

    if (win.__galleryInitHandler) {
      document.removeEventListener("astro:page-load", win.__galleryInitHandler);
    }

    win.__galleryInitHandler = initGallery;
    document.addEventListener("astro:page-load", initGallery);

    // Run immediately for current execution
    initGallery();
  }

  setupGalleryListeners();
</script>
