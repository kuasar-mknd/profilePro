---
/**
 * ImageGallery.astro - Universal Image Gallery
 *
 * Usage:
 * 1. Automatic loading from folder: <ImageGallery folder="my-project" />
 * 2. Explicit image array: <ImageGallery images={myImagesArray} />
 */
import { Picture } from "astro:assets";

interface Props {
  folder?: string;
  images?: ImageMetadata[];
  columns?: 2 | 3 | 4;
  excludePatterns?: string[];
}

const {
  folder,
  images: explicitImages,
  columns = 3,
  excludePatterns = [],
} = Astro.props;

let galleryImages: { src: ImageMetadata; filename: string; alt?: string }[] =
  [];

if (explicitImages && explicitImages.length > 0) {
  // Use explicit images if provided
  galleryImages = explicitImages.map((img, index) => ({
    src: img,
    filename: `image-${index}`,
    alt: `Photo ${index + 1}`,
  }));
} else if (folder) {
  // Load from folder
  const allImages = import.meta.glob<{ default: ImageMetadata }>(
    "../../assets/**/*.{avif,png,jpg,jpeg,webp,JPEG,PNG,JPG}",
    { eager: true },
  );

  galleryImages = Object.entries(allImages)
    .filter(([path]) => {
      const folderMatch = path.includes(`/${folder}/`);
      if (!folderMatch) return false;

      const isInSubfolder = path.split(`/${folder}/`)[1]?.includes("/");
      if (isInSubfolder) return false;

      for (const pattern of excludePatterns) {
        if (path.includes(pattern)) return false;
      }
      return true;
    })
    .map(([path, module]) => ({
      src: module.default,
      filename: path.split("/").pop() || "",
      alt: `Photo - ${folder}`,
    }))
    .sort((a, b) => a.filename.localeCompare(b.filename));
}

// Column class mapping
const columnClasses = {
  2: "gallery-cols-2",
  3: "gallery-cols-3",
  4: "gallery-cols-4",
};
---

{
  galleryImages.length > 0 ? (
    <div class={`image-gallery ${columnClasses[columns]}`}>
      {galleryImages.map((image, index) => (
        <figure class="gallery-item">
          <Picture
            src={image.src}
            widths={[400, 800]}
            sizes="(max-width: 480px) 100vw, (max-width: 768px) 50vw, 33vw"
            formats={["avif"]}
            fallbackFormat="avif"
            alt={image.alt || `Photo ${index + 1}`}
            class="gallery-image"
            data-gallery-image
            tabindex="0"
            role="button"
            aria-label={`Ouvrir la photo ${index + 1} en plein écran`}
          />
        </figure>
      ))}
    </div>
  ) : (
    <p class="text-pacamara-primary/50 dark:text-white/50 text-center py-8">
      {folder
        ? `Aucune image trouvée dans le dossier "${folder}"`
        : "Aucune image à afficher."}
    </p>
  )
}

<style>
  .image-gallery {
    column-gap: 1rem;
  }

  .gallery-cols-2 {
    column-count: 2;
  }

  .gallery-cols-3 {
    column-count: 3;
  }

  .gallery-cols-4 {
    column-count: 4;
  }

  .gallery-item {
    margin: 0;
    margin-bottom: 1rem;
    break-inside: avoid;
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
  }

  .gallery-image {
    width: 100%;
    display: block;
    cursor: pointer;
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
  }

  .gallery-item:hover .gallery-image {
    transform: scale(1.02);
  }

  .gallery-item::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.1) 0%, transparent 30%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 0.75rem;
  }

  .gallery-item:hover::after {
    opacity: 1;
  }

  /* Responsive columns */
  @media (max-width: 480px) {
    .gallery-cols-2,
    .gallery-cols-3,
    .gallery-cols-4 {
      column-count: 1;
    }
  }
</style>

<script>
  function initGalleryKeyboard() {
    const images = document.querySelectorAll("[data-gallery-image]");
    images.forEach((img) => {
      img.addEventListener("keydown", (e) => {
        if (
          (e as KeyboardEvent).key === "Enter" ||
          (e as KeyboardEvent).key === " "
        ) {
          e.preventDefault();
          (img as HTMLElement).click();
        }
      });
    });
  }

  // Initialize
  initGalleryKeyboard();
  document.addEventListener("astro:page-load", initGalleryKeyboard);
</script>
