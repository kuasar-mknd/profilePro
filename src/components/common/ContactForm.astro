---
import { Icon } from "astro-icon/components";

const PUBLIC_WEB3FORMS_ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
---

<form
  action="https://api.web3forms.com/submit"
  method="POST"
  class="w-full max-w-lg mx-auto bg-white/80 dark:bg-pacamara-dark/60 backdrop-blur-xl p-8 md:p-10 rounded-3xl border border-pacamara-secondary/10 dark:border-white/10 shadow-2xl relative overflow-hidden"
  id="contact-form"
>
  <!-- Form Success Message -->
  <div
    id="form-success-message"
    class="hidden absolute inset-0 z-20 items-center justify-center bg-white/80 dark:bg-pacamara-dark/60 backdrop-blur-xl p-8 text-center"
    role="status"
    aria-live="polite"
  >
    <div class="space-y-4">
      <Icon name="mdi:check-circle" class="w-16 h-16 text-green-500 mx-auto" />
      <h3 class="text-2xl font-bold text-pacamara-primary dark:text-white">
        Message envoyé !
      </h3>
      <p class="text-pacamara-primary/80 dark:text-white/80">
        Merci de m'avoir contacté. Je vous répondrai dans les plus brefs délais.
      </p>
      <button
        type="button"
        class="reset-form-btn mt-6 px-6 py-3 bg-pacamara-secondary/10 dark:bg-white/10 hover:bg-pacamara-secondary/20 dark:hover:bg-white/20 text-pacamara-primary dark:text-white font-medium rounded-xl transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
      >
        Envoyer un autre message
      </button>
    </div>
  </div>

  <!-- Decorative gradient corner -->
  <div
    class="absolute -top-20 -right-20 w-40 h-40 bg-linear-to-br from-pacamara-secondary/20 to-pacamara-accent/20 rounded-full blur-2xl pointer-events-none"
  >
  </div>

  <!-- Access Key -->
  <input type="hidden" name="access_key" value={PUBLIC_WEB3FORMS_ACCESS_KEY} />

  <!-- Optional: Subject -->
  <input type="hidden" name="subject" value="Nouveau message du Portfolio" />

  <!-- Optional: Honeypot -->
  <input
    type="checkbox"
    name="botcheck"
    class="hidden"
    style="display: none;"
  />

  <div class="space-y-6 relative z-10">
    <!-- Name Field -->
    <div class="form-group">
      <label
        for="name"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white"
      >
        Nom complet <span class="text-pacamara-accent">*</span>
      </label>
      <div class="relative">
        <input
          type="text"
          name="name"
          id="name"
          autocomplete="name"
          required
          maxlength="100"
          minlength="2"
          inputmode="text"
          class="form-input w-full px-5 py-4 rounded-xl bg-white dark:bg-pacamara-dark border-2 border-pacamara-secondary/10 focus:border-pacamara-accent focus:ring-4 focus:ring-pacamara-accent/10 outline-none transition-all duration-300 dark:text-white text-base"
          placeholder="Votre nom"
        />
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none"
        >
        </div>
      </div>
    </div>

    <!-- Email Field -->
    <div class="form-group">
      <label
        for="email"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white"
      >
        Email <span class="text-pacamara-accent">*</span>
      </label>
      <div class="relative">
        <input
          type="email"
          name="email"
          id="email"
          autocomplete="email"
          required
          maxlength="254"
          inputmode="email"
          spellcheck="false"
          class="form-input w-full px-5 py-4 rounded-xl bg-white dark:bg-pacamara-dark border-2 border-pacamara-secondary/10 focus:border-pacamara-accent focus:ring-4 focus:ring-pacamara-accent/10 outline-none transition-all duration-300 dark:text-white text-base"
          placeholder="votre@email.com"
        />
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none"
        >
        </div>
      </div>
    </div>

    <!-- Message Field -->
    <div class="form-group">
      <label
        for="message"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white"
      >
        Message <span class="text-pacamara-accent">*</span>
      </label>
      <div class="relative">
        <textarea
          name="message"
          id="message"
          rows="4"
          required
          maxlength="5000"
          minlength="10"
          class="w-full px-4 py-3 rounded-lg bg-white/50 dark:bg-pacamara-dark/50 border border-pacamara-secondary/20 dark:border-white/10 focus:border-pacamara-secondary focus:ring-2 focus:ring-pacamara-secondary/20 outline-none transition-all duration-300 placeholder:text-pacamara-primary/40 dark:placeholder:text-white/30"
          placeholder="Parlez-moi de votre projet..."></textarea>
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none"
        >
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="submit-btn w-full py-4 px-6 bg-pacamara-accent hover:bg-pacamara-secondary text-white font-bold rounded-xl transition-all duration-300 shadow-lg hover:shadow-glow-accent hover:-translate-y-1 flex items-center justify-center gap-3 text-lg relative overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
      aria-live="polite"
    >
      <span class="btn-text relative z-10">Envoyer le message</span>
      <Icon
        name="mdi:send"
        class="w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"
        aria-hidden="true"
      />
      <span
        class="btn-loading hidden absolute inset-0 items-center justify-center"
        aria-label="Envoi en cours..."
      >
        <svg
          class="animate-spin h-6 w-6 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </span>
      <span
        class="btn-success hidden absolute inset-0 items-center justify-center gap-2"
        aria-label="Message envoyé avec succès"
      >
        <Icon name="mdi:check-circle" class="w-6 h-6" aria-hidden="true" />
        <span>Message envoyé !</span>
      </span>
      <!-- Ripple effect container -->
      <div class="btn-ripple absolute inset-0 pointer-events-none"></div>
    </button>

    <!-- Inline Error Message -->
    <div
      id="form-error-message"
      class="hidden mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-600 dark:text-red-400 text-sm text-center focus:outline-none focus:ring-2 focus:ring-red-500/80 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-pacamara-dark"
      role="alert"
      aria-live="assertive"
      tabindex="-1"
    >
      <p id="error-text">Une erreur est survenue. Veuillez réessayer.</p>
      <button
        type="button"
        id="reset-error-btn"
        class="mt-4 px-4 py-2 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-800 dark:text-red-300 font-medium rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500"
      >
        Réessayer
      </button>
    </div>
  </div>

  <p
    class="text-xs text-center mt-6 text-pacamara-primary/50 dark:text-white/50"
  >
    Les champs marqués d'un <span class="text-pacamara-accent">*</span> sont obligatoires.
  </p>
  <p
    class="text-xs text-center mt-2 text-pacamara-primary/50 dark:text-white/50"
  >
    Powered by Web3Forms
  </p>
</form>

<style>
  /* Input glow effect on focus */
  .form-input:focus + .input-glow {
    opacity: 1;
    box-shadow: 0 0 20px rgba(190, 18, 60, 0.15);
  }

  /* Button states */
  .submit-btn.loading .btn-text,
  .submit-btn.loading svg:not(.animate-spin) {
    display: none;
  }
  .submit-btn.loading .btn-loading {
    display: flex;
  }

  .submit-btn.success {
    background-color: #10b981;
  }
  .submit-btn.success .btn-text,
  .submit-btn.success svg:not(.animate-spin):first-of-type {
    display: none;
  }
  .submit-btn.success .btn-success {
    display: flex;
  }

  /* Ripple effect */
  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  .ripple-circle {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    animation: ripple 0.6s linear;
    pointer-events: none;
  }

  /* Focus Visible Enhancement */
  .form-input:focus-visible {
    outline: 2px solid var(--color-pacamara-accent);
    outline-offset: 2px;
  }

  /* Invalid Input Styling */
  [aria-invalid="true"] {
    border-color: #ef4444; /* red-500 */
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
  }
</style>

<script>
  /**
   * ⚡ Bolt: ContactForm Performance Optimization
   * Uses early return pattern and initialization guard to prevent duplicate bindings.
   */
  function initContactForm() {
    const form = document.getElementById("contact-form") as HTMLFormElement;

    // ⚡ Early return if form doesn't exist or already initialized
    if (!form || form.dataset.initialized === "true") return;
    form.dataset.initialized = "true";

    const submitButton = form.querySelector(".submit-btn") as HTMLButtonElement;
    const resetBtn = form.querySelector(".reset-form-btn") as HTMLButtonElement;
    const errorResetBtn = form.querySelector(
      "#reset-error-btn",
    ) as HTMLButtonElement;
    const errorMessage = form.querySelector(
      "#form-error-message",
    ) as HTMLElement;
    const errorText = form.querySelector("#error-text") as HTMLParagraphElement;

    // Reset form from success message
    resetBtn?.addEventListener("click", () => {
      const successMessage = form.querySelector("#form-success-message");
      successMessage?.classList.add("hidden");
      successMessage?.classList.remove("flex");
      form.reset();
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.classList.remove("loading");
      }
      (form.querySelector("input") as HTMLInputElement)?.focus();
    });

    // Reset form from error message
    errorResetBtn?.addEventListener("click", () => {
      errorMessage?.classList.add("hidden");
      if (submitButton) {
        submitButton.disabled = false;
      }
      (form.querySelector("input") as HTMLInputElement)?.focus();
    });

    // Ripple effect
    submitButton?.addEventListener("click", (e) => {
      if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
      const rect = submitButton.getBoundingClientRect();
      const ripple = document.createElement("span");
      ripple.className = "ripple-circle";
      ripple.style.width =
        ripple.style.height = `${Math.max(rect.width, rect.height)}px`;
      ripple.style.left = `${e.clientX - rect.left - rect.width / 2}px`;
      ripple.style.top = `${e.clientY - rect.top - rect.height / 2}px`;
      submitButton.querySelector(".btn-ripple")?.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
    });

    // Helper to display errors
    function showError(message: string) {
      if (errorMessage && errorText) {
        errorText.textContent = message;
        errorMessage.classList.remove("hidden");
        errorMessage.focus();
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const emailInput = form.querySelector(
        'input[name="email"]',
      ) as HTMLInputElement;
      const emailPattern =
        /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z]{2,}$/;

      if (emailInput && !emailPattern.test(emailInput.value)) {
        showError("Veuillez entrer une adresse email valide.");
        return;
      }

      const lastSubmission = localStorage.getItem(
        "contact_form_last_submission",
      );
      if (
        lastSubmission &&
        Date.now() - parseInt(lastSubmission, 10) < 120000
      ) {
        showError(
          "Veuillez attendre quelques minutes avant de renvoyer un message.",
        );
        return;
      }

      if (submitButton) {
        submitButton.classList.add("loading");
        submitButton.disabled = true;
      }

      try {
        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(Object.fromEntries(new FormData(form))),
        });

        const result = await response.json();

        if (result.success) {
          errorMessage?.classList.add("hidden");
          form.removeAttribute("aria-describedby");
          const successMessage = form.querySelector("#form-success-message");
          if (successMessage) {
            successMessage.classList.remove("hidden");
            successMessage.classList.add("flex");
          }
          localStorage.setItem(
            "contact_form_last_submission",
            Date.now().toString(),
          );
          form.reset();
        } else {
          throw new Error(result.message || "Submission failed");
        }
      } catch (error) {
        console.error(
          "Form submission failed:",
          "An unexpected error occurred. See network tab for details.",
        );
        if (submitButton) {
          submitButton.classList.remove("loading");
        }
        showError("Une erreur est survenue. Veuillez réessayer plus tard.");
        form.setAttribute("aria-describedby", "form-error-message");
      }
    });
  }

  initContactForm();
  document.addEventListener("astro:page-load", initContactForm);
</script>
