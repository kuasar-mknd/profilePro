---
import { Icon } from "astro-icon/components";

const PUBLIC_WEB3FORMS_ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
---

{
  /* ‚ö° Bolt: Performance Optimization - content-visibility skips rendering when off-screen */
}
<form
  action="https://api.web3forms.com/submit"
  method="POST"
  class="contact-form-section w-full max-w-lg mx-auto bg-white/80 dark:bg-pacamara-dark/60 backdrop-blur-xl p-8 md:p-10 rounded-3xl border border-pacamara-secondary/10 dark:border-white/10 shadow-2xl relative overflow-hidden [content-visibility:auto] [contain-intrinsic-size:auto_600px] contain-layout-paint"
  id="contact-form"
>
  <!-- Form Success Message -->
  <div
    id="form-success-message"
    class="hidden absolute inset-0 z-20 items-center justify-center bg-white/80 dark:bg-pacamara-dark/60 backdrop-blur-xl p-8 text-center focus:outline-none"
    role="status"
    aria-live="polite"
    tabindex="-1"
  >
    <div class="space-y-4 animate-fade-in-up">
      <Icon name="mdi:check-circle" class="w-16 h-16 text-green-500 mx-auto" />
      <h3 class="text-2xl font-bold text-pacamara-primary dark:text-white">
        Message envoy√© !
      </h3>
      <p class="text-pacamara-primary/80 dark:text-white/80">
        Merci de m'avoir contact√©. Je vous r√©pondrai dans les plus brefs d√©lais.
      </p>
      <button
        type="button"
        class="reset-form-btn mt-6 px-6 py-3 bg-pacamara-secondary/10 dark:bg-white/10 hover:bg-pacamara-secondary/20 dark:hover:bg-white/20 text-pacamara-primary dark:text-white font-medium rounded-xl transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 cursor-pointer"
      >
        Envoyer un autre message
      </button>
    </div>
  </div>

  <!-- Decorative gradient corner -->
  <div
    class="absolute -top-20 -right-20 w-40 h-40 bg-linear-to-br from-pacamara-secondary/20 to-pacamara-accent/20 rounded-full blur-2xl pointer-events-none"
  >
  </div>

  <!-- Access Key -->
  <input type="hidden" name="access_key" value={PUBLIC_WEB3FORMS_ACCESS_KEY} />

  <!-- Optional: Subject -->
  <input type="hidden" name="subject" value="Nouveau message du Portfolio" />

  <!-- üõ°Ô∏è Sentinel: Hardened honeypot to prevent autofill and screen reader access -->
  <input
    type="checkbox"
    name="botcheck"
    class="hidden"
    tabindex="-1"
    autocomplete="off"
    aria-hidden="true"
  />

  <!-- üõ°Ô∏è Sentinel: Timestamp trap to prevent spam -->
  <input
    type="hidden"
    name="form-load-timestamp"
    id="form-load-timestamp"
    value=""
  />

  <div class="space-y-6 relative z-10">
    <!-- Name Field -->
    <div class="form-group group">
      <label
        for="name"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white group-focus-within:text-pacamara-accent transition-colors duration-300"
      >
        Nom complet <span class="sr-only">(obligatoire)</span><span
          aria-hidden="true"
          class="text-pacamara-accent">*</span
        >
      </label>
      <div class="relative">
        <input
          type="text"
          name="name"
          id="name"
          autocomplete="name"
          required
          maxlength="100"
          minlength="2"
          inputmode="text"
          class="form-input w-full pl-5 pr-12 py-4 rounded-xl bg-white dark:bg-pacamara-dark border-2 border-pacamara-secondary/10 focus:border-pacamara-accent focus:ring-4 focus:ring-pacamara-accent/10 outline-none transition-all duration-300 dark:text-white text-base placeholder:text-pacamara-primary/40 dark:placeholder:text-white/30"
          placeholder="Votre nom"
        />
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
          aria-hidden="true"
        >
        </div>
        <!-- üé® Palette: Validation Icon -->
        <div
          class="validation-icon absolute right-4 top-1/2 -translate-y-1/2 text-green-500 opacity-0 scale-50 transition-all duration-300 pointer-events-none data-[visible=true]:opacity-100 data-[visible=true]:scale-100"
          aria-hidden="true"
        >
          <Icon name="mdi:check-circle" class="w-6 h-6" />
        </div>
      </div>
    </div>

    <!-- Email Field -->
    <div class="form-group group">
      <label
        for="email"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white group-focus-within:text-pacamara-accent transition-colors duration-300"
      >
        Email <span class="sr-only">(obligatoire)</span><span
          aria-hidden="true"
          class="text-pacamara-accent">*</span
        >
      </label>
      <div class="relative">
        <input
          type="email"
          name="email"
          id="email"
          autocomplete="email"
          required
          maxlength="254"
          inputmode="email"
          spellcheck="false"
          class="form-input w-full pl-5 pr-12 py-4 rounded-xl bg-white dark:bg-pacamara-dark border-2 border-pacamara-secondary/10 focus:border-pacamara-accent focus:ring-4 focus:ring-pacamara-accent/10 outline-none transition-all duration-300 dark:text-white text-base placeholder:text-pacamara-primary/40 dark:placeholder:text-white/30"
          placeholder="votre@email.com"
        />
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none transition-opacity duration-300"
        >
        </div>
        <!-- üé® Palette: Validation Icon -->
        <div
          class="validation-icon absolute right-4 top-1/2 -translate-y-1/2 text-green-500 opacity-0 scale-50 transition-all duration-300 pointer-events-none data-[visible=true]:opacity-100 data-[visible=true]:scale-100"
          aria-hidden="true"
        >
          <Icon name="mdi:check-circle" class="w-6 h-6" />
        </div>
      </div>
    </div>

    <!-- Message Field -->
    <div class="form-group group">
      <label
        for="message"
        class="block mb-2 text-sm font-medium text-pacamara-primary dark:text-white group-focus-within:text-pacamara-accent transition-colors duration-300"
      >
        Message <span class="sr-only">(obligatoire)</span><span
          aria-hidden="true"
          class="text-pacamara-accent">*</span
        >
      </label>
      <div class="relative">
        <textarea
          name="message"
          id="message"
          rows="4"
          required
          maxlength="5000"
          minlength="10"
          autocomplete="off"
          class="form-input w-full pl-5 pr-12 py-4 rounded-xl bg-white dark:bg-pacamara-dark border-2 border-pacamara-secondary/10 focus:border-pacamara-accent focus:ring-4 focus:ring-pacamara-accent/10 outline-none transition-colors transition-shadow duration-300 dark:text-white text-base placeholder:text-pacamara-primary/40 dark:placeholder:text-white/30 resize-none overflow-hidden"
          placeholder="Parlez-moi de votre projet..."></textarea>
        <div
          class="input-glow absolute inset-0 rounded-xl opacity-0 pointer-events-none"
          aria-hidden="true"
        >
        </div>
        <!-- üé® Palette: Validation Icon (Top Right for Textarea) -->
        <div
          class="validation-icon absolute right-4 top-4 text-green-500 opacity-0 scale-50 transition-all duration-300 pointer-events-none data-[visible=true]:opacity-100 data-[visible=true]:scale-100"
          aria-hidden="true"
        >
          <Icon name="mdi:check-circle" class="w-6 h-6" />
        </div>
      </div>
      <!-- üé® Palette: Character counter -->
      <div class="flex justify-end mt-1 gap-2">
        <div
          id="message-counter"
          class="text-xs text-pacamara-primary/60 dark:text-white/60 font-medium transition-colors duration-300"
        >
          0 / 5000
        </div>
        <!-- Accessible announcer for thresholds -->
        <div id="message-counter-sr" class="sr-only" aria-live="polite"></div>
      </div>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="submit-btn w-full py-4 px-6 bg-pacamara-accent hover:bg-pacamara-secondary text-white font-bold rounded-xl transition-all duration-300 shadow-lg hover:shadow-glow-accent hover:-translate-y-1 focus-visible:-translate-y-1 flex items-center justify-center gap-3 text-lg relative overflow-hidden group focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 cursor-pointer"
      aria-live="polite"
    >
      <span class="btn-text relative z-10">Envoyer le message</span>
      <Icon
        name="mdi:send"
        class="w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"
        aria-hidden="true"
      />
      <span
        class="btn-loading hidden absolute inset-0 items-center justify-center"
        aria-label="Envoi en cours..."
      >
        <svg
          class="animate-spin h-6 w-6 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </span>
      <span
        class="btn-success hidden absolute inset-0 items-center justify-center gap-2"
        aria-label="Message envoy√© avec succ√®s"
      >
        <Icon name="mdi:check-circle" class="w-6 h-6" aria-hidden="true" />
        <span>Message envoy√© !</span>
      </span>
      <!-- Ripple effect container -->
      <div class="btn-ripple absolute inset-0 pointer-events-none"></div>
    </button>

    <!-- Inline Error Message -->
    <div
      id="form-error-message"
      class="hidden mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-600 dark:text-red-400 text-sm text-center focus:outline-none focus:ring-2 focus:ring-red-500/80 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-pacamara-dark"
      role="alert"
      aria-live="assertive"
      tabindex="-1"
    >
      <p id="error-text">Une erreur est survenue. Veuillez r√©essayer.</p>
      <button
        type="button"
        id="reset-error-btn"
        class="mt-4 px-4 py-2 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-800 dark:text-red-300 font-medium rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 cursor-pointer"
      >
        R√©essayer
      </button>
    </div>
  </div>

  <p
    class="text-xs text-center mt-6 text-pacamara-primary/50 dark:text-white/50"
  >
    Les champs marqu√©s d'un <span class="sr-only">ast√©risque</span><span
      class="text-pacamara-accent"
      aria-hidden="true">*</span
    > sont obligatoires.
  </p>
  <p
    class="text-xs text-center mt-2 text-pacamara-primary/50 dark:text-white/50"
  >
    Powered by Web3Forms
  </p>
</form>

<style>
  .input-glow {
    box-shadow: 0 0 20px rgba(190, 18, 60, 0.15);
  }

  .form-input:focus ~ .input-glow {
    opacity: 1;
  }

  .submit-btn.loading .btn-text,
  .submit-btn.loading svg:not(.animate-spin) {
    display: none;
  }
  .submit-btn.loading .btn-loading {
    display: flex;
  }

  .submit-btn.success {
    background-color: #10b981;
  }
  .submit-btn.success .btn-text,
  .submit-btn.success svg:not(.animate-spin):first-of-type {
    display: none;
  }
  .submit-btn.success .btn-success {
    display: flex;
  }

  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  .ripple-circle {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
  }

  .form-input:focus-visible {
    outline: 2px solid var(--color-pacamara-accent);
    outline-offset: 2px;
  }

  [aria-invalid="true"] {
    border-color: #ef4444;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.4s ease-out forwards;
  }
</style>

<script>
  import { sanitizeInput, isValidEmail } from "../../utils/security";

  function initContactForm() {
    const form = document.getElementById("contact-form") as HTMLFormElement;

    if (!form || form.dataset.initialized === "true") return;
    form.dataset.initialized = "true";

    form.setAttribute("novalidate", "true");

    const timestampInput = form.querySelector(
      "#form-load-timestamp",
    ) as HTMLInputElement;
    if (timestampInput) {
      timestampInput.value = Date.now().toString();
    }

    const submitButton = form.querySelector(".submit-btn") as HTMLButtonElement;
    const resetBtn = form.querySelector(".reset-form-btn") as HTMLButtonElement;
    const errorResetBtn = form.querySelector(
      "#reset-error-btn",
    ) as HTMLButtonElement;
    const errorMessage = form.querySelector(
      "#form-error-message",
    ) as HTMLElement;
    const errorText = form.querySelector("#error-text") as HTMLParagraphElement;
    const nameInput = form.querySelector(
      'input[name="name"]',
    ) as HTMLInputElement;
    const emailInput = form.querySelector(
      'input[name="email"]',
    ) as HTMLInputElement;
    const messageInput = form.querySelector(
      'textarea[name="message"]',
    ) as HTMLTextAreaElement;
    const messageCounter = form.querySelector(
      "#message-counter",
    ) as HTMLElement;
    const messageCounterSr = form.querySelector(
      "#message-counter-sr",
    ) as HTMLElement;

    if (messageInput && messageCounter) {
      const maxLength = messageInput.getAttribute("maxlength") || "5000";
      const max = parseInt(maxLength, 10);

      // üé® Palette: Auto-resize textarea logic
      const autoResizeTextarea = () => {
        messageInput.style.height = "auto";
        messageInput.style.height = `${messageInput.scrollHeight}px`;
      };

      const updateCounter = () => {
        const currentLength = messageInput.value.length;
        const remaining = max - currentLength;
        messageCounter.textContent = `${currentLength} / ${max}`;

        if (currentLength >= max) {
          messageCounter.classList.add("text-red-500", "dark:text-red-400");
          messageCounter.classList.remove(
            "text-orange-600",
            "dark:text-orange-400",
            "text-pacamara-primary/60",
            "dark:text-white/60",
          );
          if (messageCounterSr)
            messageCounterSr.textContent =
              "Limite de caract√®res atteinte. 0 caract√®res restants.";
        } else if (currentLength >= max * 0.9) {
          messageCounter.classList.add(
            "text-orange-600",
            "dark:text-orange-400",
          );
          messageCounter.classList.remove(
            "text-red-500",
            "dark:text-red-400",
            "text-pacamara-primary/60",
            "dark:text-white/60",
          );
          if (messageCounterSr && remaining % 20 === 0) {
            messageCounterSr.textContent = `Attention, plus que ${remaining} caract√®res.`;
          }
        } else {
          messageCounter.classList.add(
            "text-pacamara-primary/60",
            "dark:text-white/60",
          );
          messageCounter.classList.remove(
            "text-red-500",
            "dark:text-red-400",
            "text-orange-600",
            "dark:text-orange-400",
          );
          if (messageCounterSr) messageCounterSr.textContent = "";
        }
      };

      messageInput.addEventListener("input", () => {
        updateCounter();
        autoResizeTextarea();
      });
      updateCounter();
      // Initialize resize
      autoResizeTextarea();
    }

    resetBtn?.addEventListener("click", () => {
      const successMessage = form.querySelector("#form-success-message");
      successMessage?.classList.add("hidden");
      successMessage?.classList.remove("flex");
      form.reset();
      if (messageCounter && messageInput) {
        messageCounter.textContent = `0 / ${messageInput.getAttribute("maxlength") || "5000"}`;
        messageCounter.classList.remove(
          "text-red-500",
          "dark:text-red-400",
          "text-orange-600",
          "dark:text-orange-400",
        );
        messageCounter.classList.add(
          "text-pacamara-primary/60",
          "dark:text-white/60",
        );
      }
      form.querySelectorAll(".validation-icon").forEach((el) => {
        (el as HTMLElement).dataset.visible = "false";
      });

      if (submitButton) {
        submitButton.disabled = false;
        submitButton.classList.remove("loading");
      }
      (form.querySelector("input") as HTMLInputElement)?.focus();
    });

    errorResetBtn?.addEventListener("click", () => {
      errorMessage?.classList.add("hidden");
      if (submitButton) {
        submitButton.disabled = false;
      }
      submitButton?.focus();
    });

    submitButton?.addEventListener("click", (e) => {
      if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;
      const rect = submitButton.getBoundingClientRect();
      const ripple = document.createElement("span");
      ripple.className = "ripple-circle";
      ripple.style.width =
        ripple.style.height = `${Math.max(rect.width, rect.height)}px`;
      ripple.style.left = `${e.clientX - rect.left - rect.width / 2}px`;
      ripple.style.top = `${e.clientY - rect.top - rect.height / 2}px`;
      submitButton.querySelector(".btn-ripple")?.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
    });

    function hideErrorIfFormIsValid() {
      if (
        nameInput?.value.trim().length >= 2 &&
        isValidEmail(emailInput?.value || "") &&
        messageInput?.value.trim().length >= 10
      ) {
        errorMessage?.classList.add("hidden");
      }
    }

    function updateValidationIcon(
      input: HTMLInputElement | HTMLTextAreaElement,
      isValid: boolean,
    ) {
      const iconWrapper = input.parentNode?.querySelector(
        ".validation-icon",
      ) as HTMLElement;
      if (iconWrapper) {
        iconWrapper.dataset.visible = isValid ? "true" : "false";
      }
    }

    nameInput?.addEventListener("input", () => {
      const isValid = nameInput.value.trim().length >= 2;
      updateValidationIcon(nameInput, isValid);

      if (nameInput.hasAttribute("aria-invalid") && isValid) {
        nameInput.removeAttribute("aria-invalid");
        hideErrorIfFormIsValid();
      }
    });

    emailInput?.addEventListener("input", () => {
      if (
        emailInput.hasAttribute("aria-invalid") &&
        isValidEmail(emailInput.value)
      ) {
        emailInput.removeAttribute("aria-invalid");
        hideErrorIfFormIsValid();
      }
    });

    messageInput?.addEventListener("input", () => {
      const isValid = messageInput.value.trim().length >= 10;
      updateValidationIcon(messageInput, isValid);

      if (messageInput.hasAttribute("aria-invalid") && isValid) {
        messageInput.removeAttribute("aria-invalid");
        hideErrorIfFormIsValid();
      }
    });

    function showError(message: string, fieldToFocus?: HTMLElement) {
      if (errorMessage && errorText) {
        errorText.textContent = message;
        errorMessage.classList.remove("hidden");
        if (fieldToFocus) {
          fieldToFocus.focus();
        } else {
          errorMessage.focus();
        }
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      form
        .querySelectorAll("[aria-invalid]")
        .forEach((el) => el.removeAttribute("aria-invalid"));
      errorMessage?.classList.add("hidden");

      if (nameInput && nameInput.value.trim().length < 2) {
        nameInput.setAttribute("aria-invalid", "true");
        nameInput.setAttribute("aria-describedby", "form-error-message");
        showError(
          "Veuillez entrer votre nom (minimum 2 caract√®res).",
          nameInput,
        );
        return;
      }

      if (emailInput && !isValidEmail(emailInput.value)) {
        emailInput.setAttribute("aria-invalid", "true");
        emailInput.setAttribute("aria-describedby", "form-error-message");
        showError("Veuillez entrer une adresse email valide.", emailInput);
        return;
      }

      if (messageInput && messageInput.value.trim().length < 10) {
        messageInput.setAttribute("aria-invalid", "true");
        messageInput.setAttribute("aria-describedby", "form-error-message");
        showError(
          "Veuillez entrer un message d'au moins 10 caract√®res.",
          messageInput,
        );
        return;
      }

      const loadTimestamp = parseInt(timestampInput.value, 10);
      const submitTimestamp = Date.now();
      if (submitTimestamp - loadTimestamp < 2000) {
        showError(
          "Le formulaire a √©t√© soumis trop rapidement. Veuillez r√©essayer.",
        );
        return;
      }

      const lastSubmission = localStorage.getItem(
        "contact_form_last_submission",
      );
      if (
        lastSubmission &&
        Date.now() - parseInt(lastSubmission, 10) < 120000
      ) {
        showError(
          "Veuillez attendre quelques minutes avant de renvoyer un message.",
        );
        return;
      }

      if (submitButton) {
        submitButton.classList.add("loading");
        submitButton.disabled = true;
      }

      try {
        const formData = new FormData(form);
        const data: Record<string, string> = {};
        const allowedFields = new Set([
          "name",
          "email",
          "message",
          "access_key",
          "subject",
          "botcheck",
          "form-load-timestamp",
        ]);

        formData.forEach((value, key) => {
          if (allowedFields.has(key) && typeof value === "string") {
            if (key === "email") {
              data[key] = value;
            } else {
              data[key] = sanitizeInput(value);
            }
          }
        });

        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          errorMessage?.classList.add("hidden");
          form.removeAttribute("aria-describedby");
          const successMessage = form.querySelector(
            "#form-success-message",
          ) as HTMLElement;
          if (successMessage) {
            successMessage.classList.remove("hidden");
            successMessage.classList.add("flex");
            setTimeout(() => successMessage.focus(), 100);
          }
          localStorage.setItem(
            "contact_form_last_submission",
            Date.now().toString(),
          );
          form.reset();
        } else {
          throw new Error(result.message || "Submission failed");
        }
      } catch (error) {
        if (import.meta.env.DEV) {
          // eslint-disable-next-line no-console
          console.error("Form submission failed:", error);
        }

        if (submitButton) {
          submitButton.classList.remove("loading");
        }
        showError("Une erreur est survenue. Veuillez r√©essayer plus tard.");
        form.setAttribute("aria-describedby", "form-error-message");
      }
    });
  }

  initContactForm();
  document.addEventListener("astro:page-load", initContactForm);
</script>
