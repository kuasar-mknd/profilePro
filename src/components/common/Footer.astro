---
import config from "../../config.mjs";
import SocialIcon from "../ui/SocialIcon.astro";
---

{
  /* ‚ö° Bolt: Performance Optimization - content-visibility skips rendering when off-screen */
}
<footer
  id="main-footer"
  class="relative bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-md border-t border-pacamara-secondary/20 font-outfit [content-visibility:auto] [contain-intrinsic-size:auto_400px]"
>
  <div
    class="container mx-auto max-w-7xl px-7 py-12 grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-8 items-start"
  >
    <!-- Column 1: Identity & Mission -->
    <div
      class="flex flex-col items-center lg:items-start text-center lg:text-left space-y-4"
    >
      <a
        href="/"
        aria-current={Astro.url.pathname === "/" ? "page" : undefined}
        aria-label="Retour √† l'accueil"
        class="font-bold font-pacamara-space text-2xl text-pacamara-primary dark:text-white hover:text-pacamara-accent transition-colors duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent rounded-lg p-2 -m-2"
      >
        Samuel Dulex
      </a>
      <p
        class="text-pacamara-primary/80 dark:text-white/80 text-sm max-w-sm leading-relaxed"
      >
        Connecter, Communiquer, Captiver. <br />
        Cr√©ateur de contenu visuel et digital.
      </p>
      <div class="flex items-center gap-2 text-sm text-pacamara-accent">
        <span class="text-lg">üìç</span>
        <span class="font-medium">Lausanne, Suisse romande</span>
      </div>
    </div>

    <!-- Column 2: Socials & Copyright (Centered) -->
    <div class="flex flex-col items-center justify-center space-y-6">
      <ul class="flex flex-wrap justify-center gap-4">
        {
          config?.social?.github && (
            <li>
              <SocialIcon
                url={config.social.github}
                icon="mdi:github"
                label="GitHub"
              />
            </li>
          )
        }
        {
          config?.social?.instagram && (
            <li>
              <SocialIcon
                url={config.social.instagram}
                icon="mdi:instagram"
                label="Instagram"
              />
            </li>
          )
        }

        {
          config?.social?.youtube && (
            <li>
              <SocialIcon
                url={config.social.youtube}
                icon="mdi:youtube"
                label="YouTube"
              />
            </li>
          )
        }
      </ul>
      <div
        class="text-sm text-pacamara-primary/80 dark:text-white/80 text-center"
      >
        &copy; {new Date().getFullYear()} Samuel Dulex. <br
          class="visible sm:hidden"
        /> Tous droits r√©serv√©s.
      </div>
    </div>

    <!-- Column 3: Badge & Credits (Right Aligned) -->
    <div
      class="flex flex-col items-center lg:items-end text-center lg:text-right space-y-4"
    >
      <!-- Website Carbon Badge -->
      <div
        id="wcb"
        class="carbonbadge wcb-d min-h-[60px] flex items-center justify-center lg:justify-end"
      >
        <!-- Badge injected by script -->
      </div>

      <span class="text-sm text-pacamara-primary/80 dark:text-white/80">
        Fait avec <span
          class="text-red-500 animate-pulse motion-reduce:animate-none inline-block align-middle"
          role="img"
          aria-label="amour">&#9829;</span
        > et <a
          href="https://astro.build"
          target="_blank"
          rel="noopener noreferrer"
          class="font-medium hover:text-pacamara-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent rounded-lg p-2 -m-2"
          aria-label="Astro (ouvre un nouvel onglet)"
          title="Astro (ouvre un nouvel onglet)">Astro</a
        >
      </span>
    </div>
  </div>

  <script>
    /**
     * ‚ö° Bolt: Custom Website Carbon Badge Implementation
     * Re-implemented locally to avoid global scope pollution issues with external script
     * during View Transitions (SPAs).
     */
    function initCarbonBadge() {
      const isProduction =
        !["localhost", "127.0.0.1", "0.0.0.0", "::1"].includes(
          window.location.hostname,
        ) && !window.location.hostname.startsWith("192.168.");

      const wcb = document.getElementById("wcb");
      if (!wcb) return;

      if (!isProduction) {
        wcb.textContent = "";
        const devBadge = document.createElement("div");
        devBadge.className =
          "text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded";
        devBadge.textContent = "Carbon Badge (Dev)";
        wcb.appendChild(devBadge);
        return;
      }

      const wcU = encodeURIComponent(window.location.href);
      const cacheKey = "wcb_" + wcU;

      // Render function
      const render = (data) => {
        if (!wcb) return;
        wcb.replaceChildren(); // Clear loading state

        const wrapper = document.createElement("div");
        wrapper.id = "wcb_p";
        wrapper.className = "flex flex-col items-center gap-2";

        const badgeContainer = document.createElement("div");
        badgeContainer.className =
          "flex items-stretch rounded-lg overflow-hidden border border-pacamara-secondary/30 dark:border-white/20 shadow-sm";

        const scoreSpan = document.createElement("span");
        scoreSpan.id = "wcb_g";
        scoreSpan.className =
          "bg-white dark:bg-pacamara-dark px-3 py-2 text-sm font-medium text-pacamara-primary dark:text-white flex items-center";

        // Safe text content construction
        const co2Text = document.createTextNode(data.c + "g of CO");
        const sub = document.createElement("sub");
        sub.textContent = "2";
        const viewText = document.createTextNode("/view");

        scoreSpan.appendChild(co2Text);
        scoreSpan.appendChild(sub);
        scoreSpan.appendChild(viewText);

        const link = document.createElement("a");
        link.id = "wcb_a";
        link.target = "_blank";
        // ‚ö° Bolt: Security & Accessibility
        link.rel = "noopener noreferrer";
        link.href = "https://websitecarbon.com";
        link.className =
          "bg-pacamara-secondary text-white px-3 py-2 text-sm font-bold hover:bg-pacamara-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-pacamara-accent";
        link.textContent = "Website Carbon";

        const warning = " (ouvre un nouvel onglet)";
        link.setAttribute("aria-label", "Website Carbon" + warning);
        link.setAttribute("title", "Website Carbon" + warning);

        badgeContainer.appendChild(scoreSpan);
        badgeContainer.appendChild(link);

        const percentSpan = document.createElement("span");
        percentSpan.id = "wcb_2";
        percentSpan.className =
          "text-xs text-pacamara-primary/60 dark:text-white/60 font-outfit";
        percentSpan.textContent =
          "Cleaner than " + data.p + "% of pages tested";

        wrapper.appendChild(badgeContainer);
        wrapper.appendChild(percentSpan);

        wcb.appendChild(wrapper);
      };

      // Fetch logic
      const fetchData = () => {
        wcb.textContent = "";
        const loading = document.createElement("div");
        loading.className =
          "animate-pulse text-xs text-pacamara-primary/60 dark:text-white/60";
        loading.textContent = "Measuring CO2...";
        // Use sub for the '2'
        const sub = document.createElement("sub");
        sub.textContent = "2";
        // To reconstruct "CO<sub>2</sub>...", we need to append nodes manually or use a different structure.
        // Let's just use "Measuring CO2..." as text for simplicity and security, or append correctly.
        loading.textContent = "Measuring CO";
        loading.appendChild(sub);
        loading.append("...");
        wcb.appendChild(loading);

        fetch("https://api.websitecarbon.com/b?url=" + wcU)
          .then((r) => {
            if (!r.ok) throw new Error("Network error");
            return r.json();
          })
          .then((data) => {
            render(data);
            data.t = new Date().getTime();
            localStorage.setItem(cacheKey, JSON.stringify(data));
          })
          .catch((e) => {
            // üõ°Ô∏è Sentinel: Dev-only logging
            if (
              ["localhost", "127.0.0.1", "0.0.0.0", "::1"].includes(
                window.location.hostname,
              )
            ) {
              console.error(
                "Carbon Badge update failed:",
                e instanceof Error ? e.message : "Unknown error",
              );
            }
            wcb.textContent = "No Result";
            localStorage.removeItem(cacheKey);
          });
      };

      // Cache Check
      const cached = localStorage.getItem(cacheKey);
      let isValidCache = false;

      if (cached) {
        const data = JSON.parse(cached);
        const now = new Date().getTime();
        // Cache validity: 1 day (86400000 ms)
        if (now - data.t < 86400000) {
          render(data);
          isValidCache = true;
        }
      }

      // ‚ö° Bolt: Lazy load if not cached or expired to save initial bandwidth
      if (!isValidCache) {
        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting) {
              fetchData();
              observer.disconnect();
            }
          },
          { rootMargin: "200px" },
        );
        observer.observe(wcb);
      }
    }

    // Initialize on initial load and every view transition
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initCarbonBadge);
    } else {
      // Small timeout to ensure DOM is fully ready and painted
      setTimeout(initCarbonBadge, 0);
    }
    document.addEventListener("astro:page-load", initCarbonBadge);
  </script>
  <style is:global>
    /* Custom styles for the badge to match theme */
    #wcb_g {
      color: var(--color-pacamara-primary);
    }
  </style>
</footer>
