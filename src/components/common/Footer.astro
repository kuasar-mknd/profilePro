---
import config from "../../config.mjs";
import SocialIcon from "../ui/SocialIcon.astro";
---

<footer
  class="relative bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-md border-t border-pacamara-secondary/20 font-outfit"
>
  <div
    class="container mx-auto max-w-7xl px-7 py-12 grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-8 items-start"
  >
    <!-- Column 1: Identity & Mission -->
    <div
      class="flex flex-col items-center lg:items-start text-center lg:text-left space-y-4"
    >
      <a
        href="/"
        aria-current={Astro.url.pathname === "/" ? "page" : undefined}
        class="font-bold font-pacamara-space text-2xl text-pacamara-primary dark:text-white hover:text-pacamara-accent transition-colors duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent rounded-lg p-1 -m-1"
      >
        Samuel Dulex
      </a>
      <p
        class="text-pacamara-primary/80 dark:text-white/80 text-sm max-w-sm leading-relaxed"
      >
        Connecter, Communiquer, Captiver. <br />
        Cr√©ateur de contenu visuel et digital.
      </p>
      <div class="flex items-center gap-2 text-sm text-pacamara-accent">
        <span class="text-lg">üìç</span>
        <span class="font-medium">Lausanne, Suisse romande</span>
      </div>
    </div>

    <!-- Column 2: Socials & Copyright (Centered) -->
    <div class="flex flex-col items-center justify-center space-y-6">
      <ul class="flex flex-wrap justify-center gap-4">
        {
          config?.social?.github && (
            <li>
              <SocialIcon
                url={config.social.github}
                icon="mdi:github"
                label="GitHub"
              />
            </li>
          )
        }
        {
          config?.social?.instagram && (
            <li>
              <SocialIcon
                url={config.social.instagram}
                icon="mdi:instagram"
                label="Instagram"
              />
            </li>
          )
        }

        {
          config?.social?.youtube && (
            <li>
              <SocialIcon
                url={config.social.youtube}
                icon="mdi:youtube"
                label="YouTube"
              />
            </li>
          )
        }
      </ul>
      <div
        class="text-sm text-pacamara-primary/80 dark:text-white/80 text-center"
      >
        &copy; {new Date().getFullYear()} Samuel Dulex. <br
          class="visible sm:hidden"
        /> Tous droits r√©serv√©s.
      </div>
    </div>

    <!-- Column 3: Badge & Credits (Right Aligned) -->
    <div
      class="flex flex-col items-center lg:items-end text-center lg:text-right space-y-4"
    >
      <!-- Website Carbon Badge -->
      <div id="wcb" class="carbonbadge wcb-d" aria-label="Website Carbon Badge">
        <!-- Badge injected by script -->
      </div>

      <span class="text-sm text-pacamara-primary/80 dark:text-white/80">
        Fait avec <span
          class="text-red-500 animate-pulse motion-reduce:animate-none inline-block align-middle"
          >&#9829;</span
        > et <a
          href="https://astro.build"
          target="_blank"
          rel="noopener noreferrer"
          class="font-medium hover:text-pacamara-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent rounded-sm px-1 -mx-1"
          >Astro</a
        >
      </span>
    </div>
  </div>

  <script is:inline>
    /**
     * ‚ö° Bolt: Custom Website Carbon Badge Implementation
     * Re-implemented locally to avoid global scope pollution issues with external script
     * during View Transitions (SPAs).
     */
    function initCarbonBadge() {
      const isProduction =
        window.location.hostname !== "localhost" &&
        window.location.hostname !== "127.0.0.1";

      const wcb = document.getElementById("wcb");
      if (!wcb) return;

      if (!isProduction) {
        wcb.innerHTML =
          '<div class="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded">Carbon Badge (Dev)</div>';
        return;
      }

      const wcU = encodeURIComponent(window.location.href);
      const cacheKey = "wcb_" + wcU;

      // Render function
      const render = (data) => {
        if (!wcb) return;
        wcb.innerHTML = ""; // Clear loading state

        const wrapper = document.createElement("div");
        wrapper.id = "wcb_p";
        wrapper.className = "flex items-center text-[15px] leading-[1.15]";

        const scoreSpan = document.createElement("span");
        scoreSpan.id = "wcb_g";
        scoreSpan.className =
          "bg-white border-r-0 border border-[#00ffbc] py-[0.3em] px-[0.5em] rounded-l-[0.3em] min-w-[8.2em] text-[#0e11a8] text-center";
        // Safe text content
        scoreSpan.textContent = data.c + "g of CO";
        // Append subscribe element manually to avoid innerHTML for it if needed, or just text.
        // But wait, the original had <sub>2</sub>.
        // Let's do it safely.
        const sub = document.createElement("sub");
        sub.textContent = "2";
        scoreSpan.appendChild(sub);
        scoreSpan.append("/view");

        // Reset textContent to handle the mix correctly if I want to be super strict,
        // or effectively just build the nodes.
        // Let's rebuild properly:
        scoreSpan.textContent = "";
        scoreSpan.append(data.c + "g of CO", sub, "/view");

        const link = document.createElement("a");
        link.id = "wcb_a";
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.href = "https://websitecarbon.com";
        link.className =
          "bg-[#0e11a8] text-white font-bold border border-[#0e11a8] py-[0.3em] px-[0.5em] rounded-r-[0.3em] hover:opacity-90 transition-opacity focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0e11a8]";
        link.textContent = "Website Carbon";

        wrapper.appendChild(scoreSpan);
        wrapper.appendChild(link);

        const percentSpan = document.createElement("span");
        percentSpan.id = "wcb_2";
        percentSpan.className =
          "block text-center text-sm mt-1 text-[#0e11a8] dark:text-white/80";
        percentSpan.textContent =
          "Cleaner than " + data.p + "% of pages tested";

        wcb.appendChild(wrapper);
        wcb.appendChild(percentSpan);
      };

      // Styles are handled by global CSS or Tailwind, but we add structure above.
      // Fetch logic
      const fetchData = () => {
        wcb.innerHTML =
          '<div class="animate-pulse text-xs text-pacamara-primary/60 dark:text-white/60">Measuring CO<sub>2</sub>...</div>';

        fetch("https://api.websitecarbon.com/b?url=" + wcU)
          .then((r) => {
            if (!r.ok) throw new Error("Network error");
            return r.json();
          })
          .then((data) => {
            render(data);
            data.t = new Date().getTime();
            localStorage.setItem(cacheKey, JSON.stringify(data));
          })
          .catch((e) => {
            console.error(
              "Carbon Badge update failed:",
              e instanceof Error ? e.message : "Unknown error",
            );
            wcb.innerHTML = "No Result";
            localStorage.removeItem(cacheKey);
          });
      };

      // Cache Check
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const data = JSON.parse(cached);
        const now = new Date().getTime();
        // Cache validity: 1 day (86400000 ms)
        if (now - data.t < 86400000) {
          render(data);
        } else {
          fetchData();
        }
      } else {
        fetchData();
      }
    }

    // Initialize on initial load and every view transition
    document.addEventListener("astro:page-load", initCarbonBadge);
  </script>
  <style is:global>
    /* Custom styles for the badge to match theme */
    #wcb_g {
      color: var(--color-pacamara-primary);
    }
  </style>
</footer>
