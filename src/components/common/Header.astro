---
import Navigation from "./Navigation.astro";
import ModeSwitch from "../ui/ModeSwitch.astro";
import HamburgerButton from "../ui/HamburgerButton.astro";
import { getImage } from "astro:assets";
import logo from "../../assets/logo.avif";

// âš¡ Bolt: Optimize logo loading with explicit dimensions for LCP/CLS
// Generating 1x and 2x assets ensures crisp rendering on high-DPI screens without the overhead of <Picture>
const logo1x = await getImage({
  src: logo,
  width: 40,
  height: 40,
  format: "avif",
});
const logo2x = await getImage({
  src: logo,
  width: 80,
  height: 80,
  format: "avif",
});
---

<header
  style="contain: layout;"
  id="main-header"
  class="fixed w-full top-0 z-50 transition-colors duration-300 bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-md border-b border-white/20 dark:border-white/5"
>
  <div class="container mx-auto px-7 h-20 flex items-center justify-between">
    <a
      href="/"
      class="flex items-center gap-3 group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 rounded-xl p-2 -m-2"
      aria-current={Astro.url.pathname === "/" ? "page" : undefined}
      aria-label="Samuel Dulex - Retour Ã  l'accueil"
      title="Samuel Dulex - Accueil"
    >
      <div
        class="w-10 h-10 rounded-full overflow-hidden border border-pacamara-secondary/20 group-hover:border-pacamara-accent transition-colors contain-layout"
      >
        <!-- âš¡ Bolt: Optimized Header Logo
             Replaced <Picture> with <img> + srcset to reduce DOM size and improve parsing speed for this tiny 40px asset.
             Uses AVIF which matches the Hero logo format.
             âš¡ Bolt: Changed to decoding="async" and removed high priority to prioritize the LCP Hero image.
        -->
        <img
          src={logo1x.src}
          srcset={`${logo1x.src} 1x, ${logo2x.src} 2x`}
          alt=""
          width="40"
          height="40"
          class="w-10 h-10 rounded-full object-cover"
          loading="eager"
          decoding="async"
        />
      </div>
      <span
        class="font-pacamara-space font-bold text-lg text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors"
        >Samuel Dulex</span
      >
    </a>

    <div class="hidden md:flex items-center gap-8">
      <Navigation />
      <ModeSwitch />
    </div>

    <div class="md:hidden flex items-center gap-4 relative z-50">
      <ModeSwitch />
      <HamburgerButton />
    </div>
  </div>

  <!-- Mobile Menu -->
  <nav
    id="navigation_wrapper"
    aria-label="Menu mobile"
    class="fixed inset-0 bg-white dark:bg-pacamara-dark z-40 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center h-screen invisible"
  >
    <Navigation />
  </nav>
</header>

<style is:global>
  /* Fix for mobile menu scroll */
  html.overflow-hidden #main-header {
    position: fixed !important;
    width: 100%;
    top: 0;
    z-index: 50;
  }

  html.overflow-hidden #navigation_wrapper {
    transform: translateX(0);
  }

  /* âš¡ Bolt: Promote layer for large animation */
  /* Moved will-change to JS to avoid permanent GPU memory usage */
</style>

<script>
  import { createFocusTrap, watchMenuState } from "../../utils/a11y";
  import type { FocusTrap } from "../../utils/a11y";

  // âš¡ Bolt: Singleton Pattern for Header Observer & Focus Trap
  let headerObserver: MutationObserver | null = null;
  let focusTrap: FocusTrap | null = null;

  function initMobileMenuAccessibility() {
    // âš¡ Bolt: Cleanup previous instances to prevent stacking and memory leaks
    if (headerObserver) {
      headerObserver.disconnect();
      headerObserver = null;
    }

    if (focusTrap) {
      focusTrap.deactivate();
      focusTrap = null;
    }

    const navWrapper = document.getElementById("navigation_wrapper");
    if (!navWrapper) return;

    // ðŸŽ¨ Palette: Initialize focus trap for the mobile menu
    focusTrap = createFocusTrap(navWrapper);

    // ðŸŽ¨ Palette: Observer to detect when menu is opened/closed
    headerObserver = watchMenuState((isOpen) => {
      if (isOpen) {
        focusTrap?.activate();
      } else {
        focusTrap?.deactivate();
      }
    });
  }

  // âš¡ Bolt: Lifecycle Management
  document.addEventListener("astro:page-load", initMobileMenuAccessibility);

  // âš¡ Bolt: Ensure cleanup on navigation to prevent stale references
  document.addEventListener("astro:before-swap", () => {
    if (headerObserver) {
      headerObserver.disconnect();
      headerObserver = null;
    }
    if (focusTrap) {
      focusTrap.deactivate();
      focusTrap = null;
    }
  });
</script>
