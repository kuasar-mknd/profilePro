---
import Navigation from "./Navigation.astro";
import ModeSwitch from "../ui/ModeSwitch.astro";
import HamburgerButton from "../ui/HamburgerButton.astro";
import { getImage } from "astro:assets";
import logo from "../../assets/logo.avif";

// ⚡ Bolt: Optimize logo loading with explicit dimensions for LCP/CLS
// Generating 1x and 2x assets ensures crisp rendering on high-DPI screens without the overhead of <Picture>
const logo1x = await getImage({
  src: logo,
  width: 40,
  height: 40,
  format: "avif",
});
const logo2x = await getImage({
  src: logo,
  width: 80,
  height: 80,
  format: "avif",
});
---

<header
  id="main-header"
  class="fixed w-full top-0 z-50 transition-colors duration-300 bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-md border-b border-white/20 dark:border-white/5"
>
  <div class="container mx-auto px-7 h-20 flex items-center justify-between">
    <a
      href="/"
      class="flex items-center gap-3 group focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 rounded-xl p-2 -m-2"
      aria-current={Astro.url.pathname === "/" ? "page" : undefined}
      aria-label="Samuel Dulex - Retour à l'accueil"
      title="Samuel Dulex - Accueil"
    >
      <div
        class="w-10 h-10 rounded-full overflow-hidden border border-pacamara-secondary/20 group-hover:border-pacamara-accent transition-colors"
        style="contain: layout;"
      >
        <!-- ⚡ Bolt: Optimized Header Logo
             Replaced <Picture> with <img> + srcset to reduce DOM size and improve parsing speed for this tiny 40px asset.
             Uses AVIF which matches the Hero logo format.
             ⚡ Bolt: Changed to decoding="async" and removed high priority to prioritize the LCP Hero image.
        -->
        <img
          src={logo1x.src}
          srcset={`${logo1x.src} 1x, ${logo2x.src} 2x`}
          alt=""
          width="40"
          height="40"
          class="w-10 h-10 rounded-full object-cover"
          loading="eager"
          decoding="async"
        />
      </div>
      <span
        class="font-pacamara-space font-bold text-lg text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors"
        >Samuel Dulex</span
      >
    </a>

    <div class="hidden md:flex items-center gap-8">
      <Navigation />
      <ModeSwitch />
    </div>

    <div class="md:hidden flex items-center gap-4 relative z-50">
      <ModeSwitch />
      <HamburgerButton />
    </div>
  </div>

  <!-- Mobile Menu -->
  <nav
    id="navigation_wrapper"
    aria-label="Menu mobile"
    class="fixed inset-0 bg-white dark:bg-pacamara-dark z-40 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center h-screen"
  >
    <Navigation />
  </nav>
</header>

<style is:global>
  /* Fix for mobile menu scroll */
  html.overflow-hidden #main-header {
    position: fixed !important;
    width: 100%;
    top: 0;
    z-index: 50;
  }

  html.overflow-hidden #navigation_wrapper {
    transform: translateX(0);
  }

  /* ⚡ Bolt: Promote layer for large animation */
  #navigation_wrapper {
    will-change: transform;
  }
</style>

<script>
  // ⚡ Bolt: Singleton Pattern for Header Observer
  let headerObserver: MutationObserver | null = null;
  let cleanupTrap: (() => void) | null = null;

  function initMobileMenuAccessibility() {
    // ⚡ Bolt: Cleanup previous observer to prevent stacking and memory leaks
    if (headerObserver) {
      headerObserver.disconnect();
      headerObserver = null;
    }

    // ⚡ Bolt: Ensure previous focus trap listeners are removed if they were active
    if (cleanupTrap) {
      cleanupTrap();
      cleanupTrap = null;
    }

    const navWrapper = document.getElementById("navigation_wrapper");
    const html = document.documentElement;

    // Guard clause if header elements aren't found
    if (!navWrapper) return;

    // ⚡ Bolt: Track state to avoid redundant operations
    let wasOpen = html.classList.contains("overflow-hidden");

    // Observer to detect when menu is opened (via class change on html)
    headerObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class") {
          const isOpen = html.classList.contains("overflow-hidden");

          // ⚡ Bolt: Only toggle trap if state actually changed
          // Prevents re-running setup logic on unrelated class changes (e.g. theme toggle)
          if (isOpen !== wasOpen) {
            wasOpen = isOpen;
            if (isOpen) {
              setupFocusTrap();
            } else {
              removeFocusTrap();
            }
          }
        }
      });
    });

    headerObserver.observe(html, {
      attributes: true,
      attributeFilter: ["class"],
    });

    function handleEscape(e: KeyboardEvent) {
      if (e.key === "Escape" && html.classList.contains("overflow-hidden")) {
        // Find and click the hamburger button to close
        const btn = document.querySelector(
          'button[aria-controls="navigation_wrapper"]',
        );
        if (btn instanceof HTMLElement) btn.click();
      }
    }

    function handleTab(e: KeyboardEvent) {
      if (e.key !== "Tab" || !navWrapper) return;

      const focusableElements = navWrapper.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      );
      const firstElement = focusableElements[0] as HTMLElement;
      const lastElement = focusableElements[
        focusableElements.length - 1
      ] as HTMLElement;

      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          lastElement.focus();
          e.preventDefault();
        }
      } else {
        if (document.activeElement === lastElement) {
          firstElement.focus();
          e.preventDefault();
        }
      }
    }

    function setupFocusTrap() {
      document.addEventListener("keydown", handleEscape);
      navWrapper?.addEventListener("keydown", handleTab);
      // Focus first element
      const firstLink = navWrapper?.querySelector("a");
      if (firstLink instanceof HTMLElement)
        setTimeout(() => firstLink.focus(), 100);

      // ⚡ Bolt: Register cleanup function for this specific instance
      cleanupTrap = removeFocusTrap;
    }

    function removeFocusTrap() {
      document.removeEventListener("keydown", handleEscape);
      navWrapper?.removeEventListener("keydown", handleTab);
      cleanupTrap = null;
    }
  }

  // Initialize only via event listener to avoid double execution on initial load
  document.addEventListener("astro:page-load", initMobileMenuAccessibility);
</script>
