---
import Navigation from "./Navigation.astro";
import ModeSwitch from "../ui/ModeSwitch.astro";
import HamburgerButton from "../ui/HamburgerButton.astro";
import { Image, Picture } from "astro:assets";
import logo from "../../assets/logo.avif";
---

<header
  id="main-header"
  class="fixed w-full top-0 z-50 transition-all duration-300 bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-md border-b border-white/20 dark:border-white/5"
>
  <div class="container mx-auto px-7 h-20 flex items-center justify-between">
    <a
      href="/"
      class="flex items-center gap-3 group"
      aria-current={Astro.url.pathname === "/" ? "page" : undefined}
    >
      <div
        class="w-10 h-10 rounded-full overflow-hidden border border-pacamara-secondary/20 group-hover:border-pacamara-accent transition-colors"
      >
        <Picture
          src={logo}
          width={40}
          height={40}
          widths={[40, 80]}
          sizes="(min-resolution: 2dppx) 80px, 40px"
          formats={["avif", "webp"]}
          fallbackFormat="avif"
          alt=""
          class="w-10 h-10 rounded-full object-cover"
          loading="eager"
        />
      </div>
      <span
        class="font-pacamara-space font-bold text-lg text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors"
        >Samuel Dulex</span
      >
    </a>

    <div class="hidden md:flex items-center gap-8">
      <Navigation />
      <ModeSwitch />
    </div>

    <div class="md:hidden flex items-center gap-4 relative z-50">
      <ModeSwitch />
      <HamburgerButton />
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    id="navigation_wrapper"
    class="fixed inset-0 bg-white dark:bg-pacamara-dark z-40 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center h-screen"
  >
    <Navigation />
  </div>
</header>

<style is:global>
  /* Fix for mobile menu scroll */
  html.overflow-hidden #main-header {
    position: fixed !important;
    width: 100%;
    top: 0;
    z-index: 50;
  }

  html.overflow-hidden #navigation_wrapper {
    transform: translateX(0);
  }
</style>

<script>
  function initMobileMenuAccessibility() {
    const navWrapper = document.getElementById("navigation_wrapper");
    const html = document.documentElement;

    // Observer to detect when menu is opened (via class change on html)
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === "class") {
          const isOpen = html.classList.contains("overflow-hidden");
          if (isOpen) {
            setupFocusTrap();
          } else {
            removeFocusTrap();
          }
        }
      });
    });

    observer.observe(html, { attributes: true });

    function handleEscape(e: KeyboardEvent) {
      if (e.key === "Escape" && html.classList.contains("overflow-hidden")) {
        // Find and click the hamburger button to close
        const btn = document.querySelector(
          'button[aria-controls="navigation_wrapper"]',
        );
        if (btn instanceof HTMLElement) btn.click();
      }
    }

    function handleTab(e: KeyboardEvent) {
      if (e.key !== "Tab" || !navWrapper) return;

      const focusableElements = navWrapper.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
      );
      const firstElement = focusableElements[0] as HTMLElement;
      const lastElement = focusableElements[
        focusableElements.length - 1
      ] as HTMLElement;

      if (e.shiftKey) {
        if (document.activeElement === firstElement) {
          lastElement.focus();
          e.preventDefault();
        }
      } else {
        if (document.activeElement === lastElement) {
          firstElement.focus();
          e.preventDefault();
        }
      }
    }

    function setupFocusTrap() {
      document.addEventListener("keydown", handleEscape);
      navWrapper?.addEventListener("keydown", handleTab);
      // Focus first element
      const firstLink = navWrapper?.querySelector("a");
      if (firstLink instanceof HTMLElement)
        setTimeout(() => firstLink.focus(), 100);
    }

    function removeFocusTrap() {
      document.removeEventListener("keydown", handleEscape);
      navWrapper?.removeEventListener("keydown", handleTab);
    }
  }

  // Initialize
  initMobileMenuAccessibility();
  document.addEventListener("astro:page-load", initMobileMenuAccessibility);
</script>
