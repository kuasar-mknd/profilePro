---
const { videoUrl, poster } = Astro.props;

// Extract video ID and provider
const getVideoDetails = (url) => {
  if (!url) return { id: null, provider: null };

  // YouTube
  const youtubeRegExp =
    /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const youtubeMatch = url.match(youtubeRegExp);
  if (youtubeMatch && youtubeMatch[2].length === 11) {
    return { id: youtubeMatch[2], hash: null, provider: "youtube" };
  }

  // Vimeo
  const vimeoRegExp =
    /^(http\:\/\/|https\:\/\/)?(www\.)?(vimeo\.com\/)([0-9]+)(?:\/([a-z0-9]+))?$/;
  const vimeoMatch = url.match(vimeoRegExp);
  if (vimeoMatch && vimeoMatch[4]) {
    return { id: vimeoMatch[4], hash: vimeoMatch[5], provider: "vimeo" };
  }

  return { id: null, hash: null, provider: null };
};

const { id: videoId, hash, provider } = getVideoDetails(videoUrl);

let posterUrl: string | null = null;

if (provider === "youtube" && videoId) {
  posterUrl = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
} else if (provider === "vimeo" && videoId) {
  try {
    const response = await fetch(
      `https://vimeo.com/api/oembed.json?url=${encodeURIComponent(videoUrl)}`,
    );
    const data = await response.json();
    posterUrl = data.thumbnail_url;
  } catch (e) {
    console.error(`Failed to fetch Vimeo thumbnail for ${videoId}:`, e);
  }
}

// Fallback to custom poster if provider thumbnail unavailable
if (!posterUrl && poster) {
  posterUrl = poster;
}
---

<div
  class="video-player-wrapper w-full aspect-video rounded-xl overflow-hidden shadow-xl bg-black relative group"
  style="contain: layout style;"
>
  {
    videoId ? (
      <>
        <div
          class="absolute inset-0 bg-cover bg-center z-10 transition-opacity duration-500"
          style={`background-image: url(${posterUrl})`}
          id={`poster-${videoId}`}
        >
          <button
            class="absolute inset-0 w-full h-full bg-black/20 group-hover:bg-black/40 transition-colors duration-300 flex items-center justify-center cursor-pointer border-none outline-none focus-visible:bg-black/40"
            id={`play-btn-${videoId}`}
            aria-label="Lire la vidéo"
            title="Lire la vidéo"
            type="button"
          >
            <div
              class="group-focus-visible:scale-110 group-focus-visible:ring-4 group-focus-visible:ring-pacamara-accent/50 w-20 h-20 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-lg group-hover:scale-110 transition-transform duration-300 relative"
              role="presentation"
            >
              <div
                class="absolute inset-0 rounded-full border-t-2 border-white animate-spin opacity-0 transition-opacity duration-300 motion-reduce:animate-none"
                id={`spinner-${videoId}`}
              />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="w-10 h-10 text-white ml-1 transition-opacity duration-300"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </button>
        </div>
        {provider === "vimeo" ? (
          <div id={`player-${videoId}`} class="plyr__video-embed w-full h-full">
            <iframe
              src={`https://player.vimeo.com/video/${videoId}${hash ? `?h=${hash}` : ""}`}
              allow="autoplay; fullscreen; picture-in-picture"
              sandbox="allow-scripts allow-same-origin allow-presentation"
              allowfullscreen
              class="w-full h-full"
              title="Lecteur vidéo Vimeo"
            />
          </div>
        ) : (
          <div
            id={`player-${videoId}`}
            class="plyr__video-embed w-full h-full"
            data-plyr-provider={provider}
            data-plyr-embed-id={videoId}
          />
        )}
      </>
    ) : (
      <div class="flex items-center justify-center h-full text-white/50">
        Vidéo non disponible
      </div>
    )
  }
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const wrappers = document.querySelectorAll(".video-player-wrapper");

    wrappers.forEach((wrapper) => {
      const playBtn = wrapper.querySelector("[id^='play-btn-']");
      const poster = wrapper.querySelector("[id^='poster-']");
      const playerDiv = wrapper.querySelector("[id^='player-']");

      if (playBtn && playerDiv && poster) {
        playBtn.addEventListener("click", async () => {
          // Show spinner
          const spinner = wrapper.querySelector(
            `[id^='spinner-']`,
          ) as HTMLElement;
          const svgIcon = playBtn.querySelector("svg");

          if (spinner) spinner.style.opacity = "1";
          if (svgIcon) svgIcon.style.opacity = "0";

          // Dynamically import Plyr and its CSS only when needed
          // @ts-ignore
          await import("plyr/dist/plyr.css");
          // @ts-ignore
          const { default: Plyr } = await import("plyr");

          // Initialize Plyr only on click
          // eslint-disable-next-line @typescript-eslint/no-unused-vars
          const player = new Plyr(playerDiv as HTMLElement, {
            autoplay: true,
            controls: [
              "play-large",
              "play",
              "progress",
              "current-time",
              "mute",
              "volume",
              "captions",
              "settings",
              "pip",
              "airplay",
              "fullscreen",
            ],
          });

          // Hide poster
          (poster as HTMLElement).style.opacity = "0";
          setTimeout(() => {
            (poster as HTMLElement).style.display = "none";
          }, 500);
        });
      }
    });
  });
</script>

<style>
  /* Custom Plyr Styles to match theme */
  :global(.plyr) {
    --plyr-color-main: var(--color-pacamara-accent);
    height: 100%;
    border-radius: 0.75rem;
  }
  :global(.plyr__video-wrapper) {
    height: 100%;
  }
</style>
