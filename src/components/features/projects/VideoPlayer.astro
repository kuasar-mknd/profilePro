---
const { videoUrl, poster, videoTitle = "la vid√©o" } = Astro.props;
import Skeleton from "../../ui/Skeleton.astro";
import {
  isValidUrl,
  YOUTUBE_ID_REGEX,
  VIMEO_ID_REGEX,
} from "../../../utils/security";

// Extract video ID and provider
const getVideoDetails = (url: string) => {
  if (!url) return { id: null, provider: null };

  // YouTube
  // üõ°Ô∏è Sentinel: Optimized regex to prevent ReDoS (removed leading ^.* and trailing .*)
  const youtubeMatch = url.match(YOUTUBE_ID_REGEX);
  // üõ°Ô∏è Sentinel: Strict input validation for YouTube IDs (allowlist: alphanumeric + _ -)
  if (
    youtubeMatch &&
    youtubeMatch[1].length === 11 &&
    /^[a-zA-Z0-9_-]{11}$/.test(youtubeMatch[1])
  ) {
    return { id: youtubeMatch[1], hash: null, provider: "youtube" };
  }

  // Vimeo
  // üõ°Ô∏è Sentinel: Safe regex avoiding nested quantifiers
  const vimeoMatch = url.match(VIMEO_ID_REGEX);
  if (vimeoMatch && vimeoMatch[1]) {
    // üõ°Ô∏è Sentinel: Vimeo IDs are numeric, hash is alphanumeric (already enforced by regex but good to be explicit in comments)
    return { id: vimeoMatch[1], hash: vimeoMatch[2], provider: "vimeo" };
  }

  return { id: null, hash: null, provider: null };
};

const { id: videoId, hash, provider } = getVideoDetails(videoUrl);

let posterUrl: string | null = null;

// ‚ö° Bolt: Prioritize custom poster (likely optimized local asset)
// This avoids external requests to YouTube/Vimeo APIs during build and improves privacy/performance
if (poster) {
  // üõ°Ô∏è Sentinel: Validate poster URL to prevent XSS (javascript: URI)
  // Allow http, https, and relative paths (starting with /)
  if (isValidUrl(poster)) {
    posterUrl = poster;
  }
}

if (!posterUrl && provider === "youtube" && videoId) {
  posterUrl = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
} else if (!posterUrl && provider === "vimeo" && videoId) {
  try {
    const response = await fetch(
      `https://vimeo.com/api/oembed.json?url=${encodeURIComponent(videoUrl)}`,
    );
    const data = await response.json();
    posterUrl = data.thumbnail_url;
  } catch (e) {
    // üõ°Ô∏è Sentinel: Silence detailed error logging in production
    if (import.meta.env.DEV) {
      console.error(
        `Failed to fetch Vimeo thumbnail for ${videoId}:`,
        e instanceof Error ? e.message : "Unknown error",
      );
    }
  }
}

// ‚ö° Bolt: Construct embed ID with hash for Vimeo privacy support
const embedId = provider === "vimeo" && hash ? `${videoId}?h=${hash}` : videoId;
---

<div
  class="video-player-wrapper w-full aspect-video rounded-xl overflow-hidden shadow-xl bg-black relative group contain-layout-style"
  data-poster-url={posterUrl}
>
  <Skeleton class="absolute inset-0 z-0" />
  {
    videoId ? (
      <>
        <div
          class="absolute inset-0 z-10 transition-opacity duration-500"
          id={`poster-${videoId}`}
        >
          {/* ‚ö° Bolt: Using <img> tag instead of background-image for better LCP/loading performance */}
          <img
            src={posterUrl}
            alt={`Aper√ßu de ${videoTitle}`}
            class="absolute inset-0 w-full h-full object-cover"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="1280"
            height="720"
          />
          <button
            class="absolute inset-0 w-full h-full bg-black/20 group-hover:bg-black/40 transition-colors duration-300 flex items-center justify-center cursor-pointer border-none outline-none focus-visible:bg-black/40 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-pacamara-accent focus-visible:ring-inset"
            id={`play-btn-${videoId}`}
            aria-label={`Lire ${videoTitle}`}
            title={`Lire ${videoTitle}`}
            type="button"
          >
            <div
              class="group-focus-visible:scale-110 group-focus-visible:ring-4 group-focus-visible:ring-pacamara-accent/50 w-20 h-20 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 shadow-lg group-hover:scale-110 transition-transform duration-300 relative"
              role="presentation"
            >
              <div
                class="absolute inset-0 rounded-full border-t-2 border-white animate-spin opacity-0 transition-opacity duration-300 motion-reduce:animate-none"
                id={`spinner-${videoId}`}
                style="contain: strict;"
              />
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="w-10 h-10 text-white ml-1 transition-opacity duration-300"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </button>
        </div>
        {/* ‚ö° Bolt: Removed eager iframe for Vimeo. Both providers now use data attributes to defer loading until interaction. */}
        <div
          id={`player-${videoId}`}
          class="plyr__video-embed w-full h-full"
          data-plyr-provider={provider}
          data-plyr-embed-id={embedId}
        />
      </>
    ) : (
      <div class="flex items-center justify-center h-full text-white/50">
        Vid√©o non disponible
      </div>
    )
  }
</div>

<script>
  // ‚ö° Bolt: Event Delegation for Video Players
  // Reduces listener count from N (videos) to 1 (document)
  // Handles initializing new players on interaction instead of on load

  async function handleVideoClick(e: MouseEvent) {
    const target = e.target as HTMLElement;
    const playBtn = target.closest("button[id^='play-btn-']");

    if (!playBtn) return;

    const wrapper = playBtn.closest(".video-player-wrapper") as HTMLElement;
    if (!wrapper) return;

    // Prevent double initialization
    if (wrapper.dataset.playing === "true") return;
    wrapper.dataset.playing = "true";

    const poster = wrapper.querySelector("[id^='poster-']");
    const playerDiv = wrapper.querySelector("[id^='player-']");

    if (!playerDiv || !poster) return;

    // Show spinner
    const spinner = wrapper.querySelector(`[id^='spinner-']`) as HTMLElement;
    const svgIcon = playBtn.querySelector("svg");

    // Indicate busy state to AT
    wrapper.setAttribute("aria-busy", "true");

    if (spinner) spinner.style.opacity = "1";
    if (svgIcon) svgIcon.style.opacity = "0";

    // Dynamically import Plyr and its CSS only when needed
    // @ts-ignore
    await import("plyr/dist/plyr.css");
    // @ts-ignore
    const { default: Plyr } = await import("plyr");

    // Initialize Plyr only on click
    new Plyr(playerDiv as HTMLElement, {
      autoplay: true,
      controls: [
        "play-large",
        "play",
        "progress",
        "current-time",
        "mute",
        "volume",
        "captions",
        "settings",
        "pip",
        "airplay",
        "fullscreen",
      ],
      // üõ°Ô∏è Sentinel: Privacy enhancements
      youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3 },
      vimeo: { dnt: true, title: 0, byline: 0, portrait: 0 },
    });

    // Hide poster
    (poster as HTMLElement).style.opacity = "0";
    setTimeout(() => {
      (poster as HTMLElement).style.display = "none";
      wrapper.removeAttribute("aria-busy");
    }, 500);
  }

  // ‚ö° Bolt: Singleton event listener
  document.removeEventListener("click", handleVideoClick);
  document.addEventListener("click", handleVideoClick);

  // ‚ö° Bolt: Prefetch Plyr resources on hover/focus to improve perceived performance
  // This eliminates the network delay (~200ms+ depending on connection) when the user clicks play
  function initVideoPrefetch() {
    // Check if already prefetched this session (global flag)
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    if ((window as any)._plyrPrefetched) return;

    const wrappers = document.querySelectorAll(".video-player-wrapper");
    if (wrappers.length === 0) return;

    const prefetch = () => {
      // Double check inside the handler in case it fired multiple times quickly
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      if ((window as any)._plyrPrefetched) return;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      (window as any)._plyrPrefetched = true;

      // Start fetching chunks in background
      // The browser dedupes these requests automatically
      // When the user clicks, the 'await import' in handleVideoClick will resolve instantly from cache
      try {
        // @ts-ignore
        import("plyr/dist/plyr.css");
        // @ts-ignore
        import("plyr");
      } catch {
        // Silent failure is acceptable for prefetch
      }

      // Cleanup listeners globally since we only need to fetch once
      wrappers.forEach((w) => {
        w.removeEventListener("mouseenter", prefetch);
        w.removeEventListener("touchstart", prefetch);
        w.removeEventListener("focusin", prefetch);
      });
    };

    // Attach passive listeners to all video wrappers
    wrappers.forEach((wrapper) => {
      wrapper.addEventListener("mouseenter", prefetch, { passive: true });
      wrapper.addEventListener("touchstart", prefetch, { passive: true });
      wrapper.addEventListener("focusin", prefetch, { passive: true });
    });
  }

  // ‚ö° Bolt: Initialize Skeletons (must be per-element as it depends on individual load)
  document.addEventListener("astro:page-load", () => {
    initVideoPrefetch();

    const wrappers = document.querySelectorAll(".video-player-wrapper");
    wrappers.forEach((wrapper) => {
      const posterImg = wrapper.querySelector("img");
      const skeleton = wrapper.querySelector(".skeleton");
      if (posterImg && skeleton) {
        const removeSkeleton = () => {
          skeleton.classList.add("opacity-0");
          setTimeout(() => skeleton.remove(), 500);
        };
        if (posterImg.complete) {
          removeSkeleton();
        } else {
          posterImg.addEventListener("load", removeSkeleton, { once: true });
        }
      }
    });
  });
</script>

<style>
  /* Custom Plyr Styles to match theme */
  :global(.plyr) {
    --plyr-color-main: var(--color-pacamara-accent);
    height: 100%;
    border-radius: 0.75rem;
  }
  :global(.plyr__video-wrapper) {
    height: 100%;
  }
</style>
