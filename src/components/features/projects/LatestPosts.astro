---
import { getCollection } from "astro:content";
import Post from "./Post.astro";
import config from "../../../config.mjs";
import ScrollReveal from "../../ui/ScrollReveal.astro";
import { Icon } from "astro-icon/components";
import EmptyState from "../../ui/EmptyState.astro";

const {
  postLimit = config.latestPosts,
  skipPost = "",
  title = "Projets",
  subtitle = "Découvrez mes dernières réalisations en production vidéo, photographie et développement web.",
} = Astro.props;

const posts = (
  await getCollection("project", ({ data }) => {
    return !(data.title == skipPost);
  })
)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, postLimit);

// Determine bento grid sizes based on index
const getBentoClass = (index: number) => {
  if (index === 0) return "bento-item-large";
  if (index === 3) return "bento-item-wide";
  return "";
};

// Get total project count for the CTA
const allPosts = await getCollection("project");
const remainingCount = allPosts.length - postLimit;
---

<section class="container mx-auto max-w-7xl px-7 py-16">
  <ScrollReveal class="text-center mb-12">
    <h2
      class="text-3xl md:text-4xl font-pacamara-space font-bold mb-4 text-pacamara-dark dark:text-white"
    >
      {
        title === "Projets" ? (
          <>
            Projets <span class="text-shimmer">Récents</span>
          </>
        ) : (
          title
        )
      }
    </h2>
    <p
      class="text-lg text-pacamara-primary/70 dark:text-white/70 font-outfit max-w-2xl mx-auto"
    >
      {subtitle}
    </p>
  </ScrollReveal>

  {
    /* ⚡ Bolt: Performance Optimization - content-visibility skips rendering when off-screen */
  }
  <div
    class="bento-grid [content-visibility:auto] [contain-intrinsic-size:auto_800px]"
  >
    {
      posts.length === 0 && (
        <EmptyState message="Aucun projet ne correspond à ces critères pour le moment." />
      )
    }

    {
      posts.map((post, index) => {
        const bentoClass = getBentoClass(index);
        return (
          <ScrollReveal delay={0.1 * index} class={bentoClass}>
            <Post
              postData={post}
              num={index}
              bentoSize={bentoClass}
              priority={index < 2}
            />
          </ScrollReveal>
        );
      })
    }

    <!-- CTA Card to view all projects -->
    <ScrollReveal delay={0.1 * posts.length}>
      <a
        href="/project"
        class="group relative h-full min-h-[280px] rounded-2xl overflow-hidden flex flex-col items-center justify-center p-8 text-center bg-linear-to-br from-pacamara-secondary/10 via-pacamara-accent/10 to-pacamara-secondary/10 dark:from-pacamara-secondary/20 dark:via-pacamara-accent/20 dark:to-pacamara-secondary/20 border-2 border-dashed border-pacamara-secondary/30 dark:border-white/20 hover:border-pacamara-accent hover:bg-pacamara-accent/5 transition-all duration-500 card-glow focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
      >
        <div
          class="absolute inset-0 bg-linear-to-br from-pacamara-accent/0 to-pacamara-secondary/0 group-hover:from-pacamara-accent/10 group-hover:to-pacamara-secondary/10 transition-all duration-500"
        >
        </div>

        <div class="relative z-10">
          <div
            class="w-16 h-16 mx-auto mb-4 rounded-full bg-pacamara-accent/10 flex items-center justify-center group-hover:scale-110 group-hover:rotate-12 group-hover:bg-pacamara-accent/20 transition-all duration-300"
          >
            <Icon
              name="mdi:folder-multiple-image"
              class="w-8 h-8 text-pacamara-accent"
            />
          </div>

          <h3
            class="text-xl font-pacamara-space font-bold mb-2 text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors"
          >
            Voir tous les projets
          </h3>

          {
            remainingCount > 0 && (
              <p class="text-sm text-pacamara-primary/60 dark:text-white/60 font-outfit mb-4">
                +{remainingCount} autres réalisations
              </p>
            )
          }

          <div
            class="inline-flex items-center gap-2 text-pacamara-accent font-bold group-hover:gap-3 transition-all duration-300"
          >
            <span>Explorer</span>
            <Icon
              name="mdi:arrow-right"
              class="w-5 h-5 group-hover:translate-x-1 transition-transform"
            />
          </div>
        </div>
      </a>
    </ScrollReveal>
  </div>
</section>
