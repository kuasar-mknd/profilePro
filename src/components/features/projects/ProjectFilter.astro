---
import type { CollectionEntry } from "astro:content";

interface Props {
  tags: string[];
  activeTag?: string;
  allProjects?: CollectionEntry<"project">[];
}

const { tags, activeTag, allProjects } = Astro.props;

// Calculate counts if allProjects is provided
const counts: Record<string, number> = {};
let totalCount = 0;

if (allProjects) {
  totalCount = allProjects.length;
  allProjects.forEach((project) => {
    const projectTags = Array.isArray(project.data.tag)
      ? project.data.tag
      : [project.data.tag];
    projectTags.forEach((tag) => {
      counts[tag] = (counts[tag] || 0) + 1;
    });
  });
}
---

<nav
  aria-label="Filtres de projets"
  class="flex flex-wrap justify-center gap-4 my-8"
  style="contain: layout;"
>
  <a
    href="/project"
    class={`px-4 py-2 rounded-full transition-all duration-300 border border-pacamara-secondary/30 backdrop-blur-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 flex items-center gap-2
        ${!activeTag ? "bg-pacamara-accent text-white shadow-lg" : "bg-white/10 hover:bg-pacamara-accent/20 text-pacamara-primary dark:text-white"}`}
    aria-current={!activeTag ? "page" : undefined}
    aria-label={!activeTag
      ? `Filtre actif : Afficher tous les projets (${totalCount})`
      : `Afficher tous les projets (${totalCount})`}
    title={!activeTag
      ? "Filtre actif : Afficher tous les projets"
      : "Afficher tous les projets"}
  >
    <span>Tous</span>
    {
      totalCount > 0 && (
        <span class="text-xs opacity-60 font-mono bg-black/10 dark:bg-white/10 px-1.5 py-0.5 rounded-full min-w-[20px] text-center">
          {totalCount}
        </span>
      )
    }
  </a>
  {
    tags.map((tag: string) => {
      const count = counts[tag] || 0;
      return (
        <a
          href={`/project/tag/${encodeURIComponent(tag)}`}
          class={`px-4 py-2 rounded-full transition-all duration-300 border border-pacamara-secondary/30 backdrop-blur-md capitalize focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 flex items-center gap-2
            ${activeTag === tag ? "bg-pacamara-accent text-white shadow-lg" : "bg-white/10 hover:bg-pacamara-accent/20 text-pacamara-primary dark:text-white"}`}
          aria-current={activeTag === tag ? "page" : undefined}
          aria-label={
            activeTag === tag
              ? `Filtre actif : ${tag} (${count} projets)`
              : `Filtrer par catégorie : ${tag} (${count} projets)`
          }
          title={
            activeTag === tag
              ? `Filtre actif : ${tag}`
              : `Filtrer par catégorie : ${tag}`
          }
        >
          <span>{tag}</span>
          {count > 0 && (
            <span class="text-xs opacity-60 font-mono bg-black/10 dark:bg-white/10 px-1.5 py-0.5 rounded-full min-w-[20px] text-center">
              {count}
            </span>
          )}
        </a>
      );
    })
  }
</nav>
