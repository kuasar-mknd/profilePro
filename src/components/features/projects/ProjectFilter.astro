---
import { getCollection } from "astro:content";

const { tags, activeTag } = Astro.props;

// ðŸŽ¨ Palette: Fetch all projects to calculate counts for each tag
const allProjects = await getCollection("project");

// âš¡ Bolt: O(N) single-pass tag counting instead of O(N*M) nested loops
const tagCounts: Record<string, number> = {};
for (const tag of tags) {
  tagCounts[tag] = 0;
}

for (let i = 0; i < allProjects.length; i++) {
  const projectTags = allProjects[i].data.tag;
  if (Array.isArray(projectTags)) {
    for (let j = 0; j < projectTags.length; j++) {
      const tag = projectTags[j];
      if (tagCounts[tag] !== undefined) {
        tagCounts[tag]++;
      }
    }
  } else if (tagCounts[projectTags as string] !== undefined) {
    tagCounts[projectTags as string]++;
  }
}

const totalCount = allProjects.length;
---

<nav
  aria-label="Filtres de projets"
  class="flex flex-wrap justify-center gap-4 my-8"
  style="contain: layout;"
>
  <a
    href="/project"
    class={`px-4 py-2 rounded-full transition-all duration-300 border border-pacamara-secondary/30 backdrop-blur-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2
        ${!activeTag ? "bg-pacamara-accent text-white shadow-lg" : "bg-white/10 hover:bg-pacamara-accent/20 text-pacamara-primary dark:text-white"}`}
    aria-current={!activeTag ? "page" : undefined}
    aria-label={!activeTag
      ? `Filtre actif : Afficher tous les projets (${totalCount})`
      : `Afficher tous les projets (${totalCount})`}
    title={!activeTag
      ? `Filtre actif : Afficher tous les projets (${totalCount})`
      : `Afficher tous les projets (${totalCount})`}
  >
    Tous ({totalCount})
  </a>
  {
    tags.map((tag: string) => (
      <a
        href={`/project/tag/${encodeURIComponent(tag)}`}
        class={`px-4 py-2 rounded-full transition-all duration-300 border border-pacamara-secondary/30 backdrop-blur-md capitalize focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2
            ${activeTag === tag ? "bg-pacamara-accent text-white shadow-lg" : "bg-white/10 hover:bg-pacamara-accent/20 text-pacamara-primary dark:text-white"}`}
        aria-current={activeTag === tag ? "page" : undefined}
        aria-label={
          activeTag === tag
            ? `Filtre actif : ${tag} (${tagCounts[tag]})`
            : `Filtrer par catÃ©gorie : ${tag} (${tagCounts[tag]})`
        }
        title={
          activeTag === tag
            ? `Filtre actif : ${tag} (${tagCounts[tag]})`
            : `Filtrer par catÃ©gorie : ${tag} (${tagCounts[tag]})`
        }
      >
        {tag} ({tagCounts[tag]})
      </a>
    ))
  }
</nav>
