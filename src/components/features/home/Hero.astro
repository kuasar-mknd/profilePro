---
import { Image, Picture } from "astro:assets";
import { getCollection } from "astro:content";
import logo from "../../../assets/logo.avif";
import BackgroundAnimation from "./BackgroundAnimation.astro";

// Fetch all project images
const projects = await getCollection("project");
const projectImages = projects.map((p) => ({
  src: p.data.image,
  alt: p.data.title,
}));

// Shuffle images function
function shuffle(array: any[]) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

const slides = shuffle([...projectImages]);
// Ensure we have enough slides for the loop (duplicate if needed)
const allSlides = [...slides, ...slides];
---

<section
  class="relative overflow-hidden min-h-[90vh] flex flex-col justify-center items-center pt-20 pb-10"
>
  <!-- Background Glows -->
  <BackgroundAnimation />

  <div class="container mx-auto px-7 text-center z-10">
    {/* ⚡ LCP Image - decoding="sync" ensures immediate display after load */}
    <div class="mb-8 hero-logo">
      <Picture
        src={logo}
        width={360}
        widths={[180, 360]}
        sizes="180px"
        formats={["avif"]}
        fallbackFormat="avif"
        alt="Logo Samuel Dulex"
        class="mx-auto rounded-2xl shadow-glow-accent w-[180px] lcp-image"
        loading="eager"
        decoding="sync"
        fetchpriority="high"
      />
    </div>

    <h1
      class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 tracking-tight hero-title"
    >
      <span class="sr-only">Connecter.</span>
      <span
        class="hero-text-subtle text-pacamara-primary/60 dark:text-white/60 inline-block"
        aria-hidden="true"
      >
        <span class="letter-animate">C</span><span class="letter-animate"
          >o</span
        ><span class="letter-animate">n</span><span class="letter-animate"
          >n</span
        ><span class="letter-animate">e</span><span class="letter-animate"
          >c</span
        ><span class="letter-animate">t</span><span class="letter-animate"
          >e</span
        ><span class="letter-animate">r</span><span class="letter-animate"
          >.</span
        >
      </span>
      <br class="md:hidden" />
      <span class="sr-only">Captiver.</span>
      <span class="text-shimmer inline-block" aria-hidden="true">
        <span class="letter-animate" style="animation-delay: 0.1s">C</span><span
          class="letter-animate"
          style="animation-delay: 0.15s">a</span
        ><span class="letter-animate" style="animation-delay: 0.2s">p</span
        ><span class="letter-animate" style="animation-delay: 0.25s">t</span
        ><span class="letter-animate" style="animation-delay: 0.3s">i</span
        ><span class="letter-animate" style="animation-delay: 0.35s">v</span
        ><span class="letter-animate" style="animation-delay: 0.4s">e</span
        ><span class="letter-animate" style="animation-delay: 0.45s">r</span
        ><span class="letter-animate" style="animation-delay: 0.5s">.</span>
      </span>
    </h1>

    <p
      class="text-xl md:text-2xl text-pacamara-primary dark:text-white max-w-2xl mx-auto mb-10 font-outfit font-light hero-subtitle text-balance"
    >
      L'Art de transformer chaque événement en <span
        class="text-pacamara-accent font-semibold">Histoire</span
      >.
    </p>

    <div
      class="flex flex-col md:flex-row gap-4 justify-center items-center hero-buttons"
    >
      <div class="magnetic-wrap relative z-20">
        <a
          href="/project"
          class="btn-content group relative block px-8 py-4 bg-pacamara-primary dark:bg-white text-white dark:text-pacamara-primary rounded-full font-bold text-lg shadow-lg hover:shadow-glow overflow-hidden"
          id="hero-cta-primary"
        >
          <span class="relative z-10">Voir mes projets</span>
          <div
            class="absolute inset-0 bg-linear-to-r from-pacamara-secondary to-pacamara-accent opacity-0 group-hover:opacity-100 transition-opacity duration-300"
          >
          </div>
        </a>
      </div>

      <div class="magnetic-wrap relative z-10">
        <a
          href="#contact-form"
          class="btn-content block px-8 py-4 bg-pacamara-secondary text-white rounded-full font-bold text-lg shadow-lg hover:shadow-glow hover-lift"
          id="hero-cta-secondary"
        >
          Me contacter
        </a>
      </div>
    </div>
  </div>

  <!-- Infinite Scroll Carousel -->
  <div
    class="w-full mt-16 overflow-hidden hero-carousel touch-carousel"
    id="hero-carousel"
  >
    <div
      class="infinite-scroll py-8 pb-12"
      id="carousel-track"
      style="animation-duration: 120s;"
    >
      {/* Duplicate slides for seamless infinite scroll */}
      {
        allSlides.map((slide, index) => (
          <div
            class="relative w-56 md:w-72 aspect-9-10 flex-none rounded-2xl overflow-hidden shadow-glass mx-3 hover:scale-105 transition-transform duration-500 image-zoom"
            style={`transform: rotate(${(index % 5) * 3 - 6}deg)`}
          >
            <Picture
              src={slide.src}
              width={288}
              height={512}
              widths={[224, 288]}
              sizes="(max-width: 768px) 224px, 288px"
              formats={["avif"]}
              fallbackFormat="avif"
              alt={slide.alt}
              class="object-cover w-full h-full"
              loading={index < 3 ? "eager" : "lazy"}
              decoding="async"
              fetchpriority="low"
              quality={75}
            />
            <div class="absolute inset-0 bg-linear-to-t from-black/40 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300" />
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  /* Letter Animation - GPU-composited */
  @keyframes letter-appear {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .letter-animate {
    display: inline-block;
    opacity: 0;
    animation: letter-appear 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    will-change: transform, opacity;
  }

  .hero-title .letter-animate:nth-child(1) {
    animation-delay: 0.1s;
  }
  .hero-title .letter-animate:nth-child(2) {
    animation-delay: 0.15s;
  }
  .hero-title .letter-animate:nth-child(3) {
    animation-delay: 0.2s;
  }
  .hero-title .letter-animate:nth-child(4) {
    animation-delay: 0.25s;
  }
  .hero-title .letter-animate:nth-child(5) {
    animation-delay: 0.3s;
  }
  .hero-title .letter-animate:nth-child(6) {
    animation-delay: 0.35s;
  }
  .hero-title .letter-animate:nth-child(7) {
    animation-delay: 0.4s;
  }
  .hero-title .letter-animate:nth-child(8) {
    animation-delay: 0.45s;
  }
  .hero-title .letter-animate:nth-child(9) {
    animation-delay: 0.5s;
  }
  .hero-title .letter-animate:nth-child(10) {
    animation-delay: 0.55s;
  }

  /* Hero elements entrance animations */
  /* Note: hero-logo has NO initial opacity:0 to ensure LCP is visible immediately */
  .hero-logo {
    /* Logo is visible immediately for LCP - no animation delay */
  }

  /* ⚡ LCP image - hover effect separated from initial render */
  .lcp-image {
    transition: transform 0.5s ease;
  }
  .lcp-image:hover {
    transform: scale(1.05);
  }

  .hero-subtitle {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.6s forwards;
  }

  .hero-buttons {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.8s forwards;
  }

  .hero-carousel {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 1s forwards;
  }

  @keyframes fade-slide-up {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Gradient mask for carousel edges */
  .hero-carousel {
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }

  /* Touch-friendly carousel on mobile - allow scrolling while keeping animation */
  @media (pointer: coarse) {
    .touch-carousel {
      cursor: grab;
    }

    .touch-carousel:active {
      cursor: grabbing;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .letter-animate {
      opacity: 1;
      animation: none;
      transform: none;
    }
    .hero-logo,
    .hero-subtitle,
    .hero-buttons,
    .hero-carousel {
      opacity: 1;
      animation: none;
    }
  }
</style>

<script>
  /**
   * ⚡ Bolt: Magnetic Button Performance Optimization
   * Refactored to use Wrapper/Target pattern to prevent flickering (mouseleave loops).
   * The wrapper stays static and captures events, while the inner target moves.
   */
  function initMagneticButtons() {
    const wrappers = document.querySelectorAll(
      ".magnetic-wrap:not(.magnetic-initialized)",
    );

    if (wrappers.length === 0) return;

    // cache for rects to avoid layout thrashing
    const wrapperCache = new Map();

    const updateCache = () => {
      wrappers.forEach((wrap) => {
        wrapperCache.set(wrap, wrap.getBoundingClientRect());
      });
    };

    // Initial cache
    updateCache();

    // Update cache on resize/scroll (throttled)
    let resizeTimeout;
    window.addEventListener(
      "resize",
      () => {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateCache, 100);
      },
      { passive: true },
    );

    wrappers.forEach((wrap) => {
      wrap.classList.add("magnetic-initialized");
      const target = wrap.querySelector(".magnetic-content") as HTMLElement;
      if (!target) return;

      const targetStyle = target.style;

      // ⚡ Bolt: Hint browser to pre-composite for transform animations
      target.style.willChange = "transform";
      target.style.transition = "transform 0.2s cubic-bezier(0.23, 1, 0.32, 1)";

      wrap.addEventListener("mousemove", (e: Event) => {
        const mouseEvent = e as MouseEvent;
        // ⚡ Use cached rect of the STATIC wrapper
        const rect = wrapperCache.get(wrap) || wrap.getBoundingClientRect();

        // ⚡ Pre-calculate center offset
        const centerOffsetX = rect.width * 0.5;
        const centerOffsetY = rect.height * 0.5;

        // Calculate distance from center of the wrapper
        const x = (mouseEvent.clientX - rect.left - centerOffsetX) * 0.3; // Increased movement factor slightly
        const y = (mouseEvent.clientY - rect.top - centerOffsetY) * 0.3;

        // ⚡ Move the inner target
        targetStyle.transform = `translate(${x}px, ${y}px)`;
      });

      wrap.addEventListener("mouseleave", () => {
        // ⚡ Reset the inner target
        targetStyle.transform = "translate(0, 0)";
      });
    });
  }

  initMagneticButtons();
  document.addEventListener("astro:page-load", initMagneticButtons);

  /**
   * ⚡ Bolt: Carousel Touch Optimization
   * Added initialization guard and passive listeners to all touch events
   */
  function initCarouselTouch() {
    const carousel = document.getElementById("hero-carousel");
    const track = document.getElementById("carousel-track");

    // ⚡ Early return guards
    if (!carousel || !track) return;
    if (carousel.dataset.touchInitialized === "true") return;
    carousel.dataset.touchInitialized = "true";

    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;

    carousel.addEventListener(
      "touchstart",
      (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        track.style.animationPlayState = "paused";
        const computedStyle = getComputedStyle(track);
        const matrix = new DOMMatrix(computedStyle.transform);
        currentTranslate = matrix.m41;
      },
      { passive: true },
    );

    carousel.addEventListener(
      "touchmove",
      (e) => {
        if (!isDragging) return;
        const x = e.touches[0].clientX;
        const diff = x - startX;
        track.style.transform = `translateX(${currentTranslate + diff}px)`;
      },
      { passive: true },
    );

    // ⚡ Bolt: Added passive: true to touchend for scroll optimization
    carousel.addEventListener(
      "touchend",
      () => {
        isDragging = false;
        track.style.transform = "";
        track.style.animationPlayState = "running";
      },
      { passive: true },
    );
  }

  initCarouselTouch();
  document.addEventListener("astro:page-load", initCarouselTouch);
</script>
