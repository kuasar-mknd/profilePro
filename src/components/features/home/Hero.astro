---
import { getImage } from "astro:assets";
import { limitConcurrency } from "../../../utils/async";
import { getCollection, type CollectionEntry } from "astro:content";
import logo from "../../../assets/logo.avif";
import BackgroundAnimation from "./BackgroundAnimation.astro";

interface Props {
  projects?: CollectionEntry<"project">[];
}

const { projects: initialProjects } = Astro.props;

// Fetch all project images
const projects = initialProjects || (await getCollection("project"));
const projectImages = projects.map((p) => ({
  src: p.data.image,
  alt: p.data.title,
}));

// Shuffle images function
function shuffle(array: any[]) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

const slides = shuffle([...projectImages]).slice(0, 15);

// üöÄ Optimization: Added limitConcurrency to prevent build timeouts/OOM
// and reduced the number of image variants to 2 (mobile/desktop + retina)
// as suggested by memory for Render free tier compatibility.
const optimizedSlides = await limitConcurrency(
  slides,
  async (slide) => {
    const [w288, w576] = await Promise.all([
      getImage({ src: slide.src, width: 288, format: "webp", quality: 80 }),
      getImage({ src: slide.src, width: 576, format: "webp", quality: 80 }),
    ]);

    return {
      alt: slide.alt,
      src: w288.src,
      srcset: `${w288.src} 288w, ${w576.src} 576w`,
      sizes: "(max-width: 768px) 288px, 288px", // Simplified sizes
    };
  },
  3, // Concurrency limit
);

const allSlides = [...optimizedSlides, ...optimizedSlides];

const optimizedLogo = await getImage({ src: logo, width: 360, format: "webp" });
---

<section
  class="relative overflow-hidden min-h-[90vh] flex flex-col justify-center items-center pt-20 pb-10"
>
  <!-- Background Glows -->
  <BackgroundAnimation />

  <div class="container mx-auto px-7 text-center z-10">
    <div class="mb-8 hero-logo">
      <img
        src={optimizedLogo.src}
        alt="Logo Samuel Dulex"
        width="180"
        height="180"
        class="mx-auto rounded-2xl shadow-glow-accent w-[180px] lcp-image"
        loading="eager"
        decoding="sync"
        fetchpriority="high"
      />
    </div>

    <h1
      class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 tracking-tight hero-title"
    >
      <span class="sr-only">Connecter.</span>
      <span
        class="hero-text-subtle text-pacamara-primary/60 dark:text-white/60 inline-block"
        aria-hidden="true"
      >
        <span class="letter-animate">C</span><span class="letter-animate"
          >o</span
        ><span class="letter-animate">n</span><span class="letter-animate"
          >n</span
        ><span class="letter-animate">e</span><span class="letter-animate"
          >c</span
        ><span class="letter-animate">t</span><span class="letter-animate"
          >e</span
        ><span class="letter-animate">r</span><span class="letter-animate"
          >.</span
        >
      </span>
      <br class="md:hidden" />
      <span class="sr-only">Captiver.</span>
      <span class="text-shimmer inline-block" aria-hidden="true">
        <span class="letter-animate delay-100">C</span><span
          class="letter-animate delay-150">a</span
        ><span class="letter-animate delay-200">p</span><span
          class="letter-animate delay-250">t</span
        ><span class="letter-animate delay-300">i</span><span
          class="letter-animate delay-350">v</span
        ><span class="letter-animate delay-400">e</span><span
          class="letter-animate delay-450">r</span
        ><span class="letter-animate delay-500">.</span>
      </span>
    </h1>

    <p
      class="text-xl md:text-2xl text-pacamara-primary dark:text-white max-w-2xl mx-auto mb-6 font-outfit font-light hero-subtitle text-balance"
    >
      L'Art de transformer chaque √©v√©nement en <span
        class="text-pacamara-accent font-semibold">Histoire</span
      >.
    </p>

    <!-- ‚ö° Bolt: Simple services summary -->
    <ul
      class="flex flex-wrap justify-center gap-x-4 gap-y-2 mb-10 text-[10px] md:text-xs font-pacamara-space font-bold uppercase tracking-widest text-pacamara-primary/80 dark:text-white/80 hero-services"
    >
      <li>Production Vid√©o</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>D√©veloppement Web</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>Photographie</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>Strat√©gie Digitale</li>
    </ul>

    <div
      class="flex flex-col md:flex-row gap-4 justify-center items-center hero-buttons"
    >
      <a
        href="/project"
        class="group relative block px-8 py-4 bg-pacamara-primary dark:bg-white text-white dark:text-pacamara-primary rounded-full font-bold text-lg shadow-lg hover:shadow-glow overflow-hidden active:scale-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pacamara-accent"
        id="hero-cta-primary"
      >
        <span class="relative z-10">Voir mes projets</span>
        <div
          class="absolute inset-0 bg-linear-to-r from-pacamara-secondary to-pacamara-accent opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        >
        </div>
      </a>

      <a
        href="#contact-form"
        class="block px-8 py-4 bg-pacamara-secondary text-white rounded-full font-bold text-lg shadow-lg hover:shadow-glow hover-lift active:scale-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pacamara-accent"
        id="hero-cta-secondary"
      >
        Me contacter
      </a>
    </div>
  </div>

  <!-- Infinite Scroll Carousel -->
  <div
    class="w-full mt-16 overflow-hidden hero-carousel touch-carousel contain-layout-paint"
    id="hero-carousel"
  >
    <div class="infinite-scroll py-8 pb-12 duration-120s" id="carousel-track">
      {
        allSlides.map((slide, index) => (
          <div
            class="relative w-56 md:w-72 aspect-9-10 flex-none rounded-2xl overflow-hidden shadow-glass mx-3 hover:scale-105 transition-transform duration-500 image-zoom"
            style={`transform: rotate(${(index % 5) * 3 - 6}deg)`}
          >
            <img
              src={slide.src}
              srcset={slide.srcset}
              sizes={slide.sizes}
              alt={slide.alt}
              width="288"
              height="320"
              class="object-cover w-full h-full"
              loading={index < 3 ? "eager" : "lazy"}
              decoding="async"
              fetchpriority={index < 3 ? "high" : "low"}
            />
            <div class="absolute inset-0 bg-linear-to-t from-black/40 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300" />
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  @keyframes letter-appear {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .letter-animate {
    display: inline-block;
    opacity: 0;
    animation: letter-appear 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  @media (prefers-reduced-motion: no-preference) {
    .letter-animate {
      will-change: transform, opacity;
    }
  }

  .hero-title .letter-animate:nth-child(1) {
    animation-delay: 0.1s;
  }
  .hero-title .letter-animate:nth-child(2) {
    animation-delay: 0.15s;
  }
  .hero-title .letter-animate:nth-child(3) {
    animation-delay: 0.2s;
  }
  .hero-title .letter-animate:nth-child(4) {
    animation-delay: 0.25s;
  }
  .hero-title .letter-animate:nth-child(5) {
    animation-delay: 0.3s;
  }
  .hero-title .letter-animate:nth-child(6) {
    animation-delay: 0.35s;
  }
  .hero-title .letter-animate:nth-child(7) {
    animation-delay: 0.4s;
  }
  .hero-title .letter-animate:nth-child(8) {
    animation-delay: 0.45s;
  }
  .hero-title .letter-animate:nth-child(9) {
    animation-delay: 0.5s;
  }
  .hero-title .letter-animate:nth-child(10) {
    animation-delay: 0.55s;
  }

  .hero-logo {
  }

  .lcp-image {
    transition: transform 0.5s ease;
  }
  .lcp-image:hover {
    transform: scale(1.05);
  }

  .hero-subtitle {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.6s forwards;
  }

  .hero-services {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.7s forwards;
  }

  .hero-buttons {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s forwards;
  }

  .hero-carousel {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 1s forwards;
  }

  @keyframes fade-slide-up {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .hero-carousel {
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }

  @media (pointer: coarse) {
    .touch-carousel {
      cursor: grab;
    }

    .touch-carousel:active {
      cursor: grabbing;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .letter-animate {
      opacity: 1;
      animation: none;
      transform: none;
    }
    .hero-logo,
    .hero-subtitle,
    .hero-buttons,
    .hero-carousel {
      opacity: 1;
      animation: none;
    }
  }
</style>

<script>
  function initCarouselTouch() {
    const carousel = document.getElementById("hero-carousel");
    const track = document.getElementById("carousel-track");

    if (!carousel || !track) return;
    if (carousel.dataset.touchInitialized === "true") return;
    carousel.dataset.touchInitialized = "true";

    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let rafId: number | null = null;
    let lastTouchX = 0;

    carousel.addEventListener(
      "touchstart",
      (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        track.style.animationPlayState = "paused";
        const computedStyle = getComputedStyle(track);
        const matrix = new DOMMatrix(computedStyle.transform);
        currentTranslate = matrix.m41;
      },
      { passive: true },
    );

    carousel.addEventListener(
      "touchmove",
      (e) => {
        if (!isDragging) return;
        lastTouchX = e.touches[0].clientX;

        if (!rafId) {
          rafId = requestAnimationFrame(() => {
            const diff = lastTouchX - startX;
            track.style.transform = `translateX(${currentTranslate + diff}px)`;
            rafId = null;
          });
        }
      },
      { passive: true },
    );

    carousel.addEventListener(
      "touchend",
      () => {
        isDragging = false;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        track.style.transform = "";
        track.style.animationPlayState = "running";
      },
      { passive: true },
    );
  }

  initCarouselTouch();
  document.addEventListener("astro:page-load", initCarouselTouch);

  function initCarouselObserver() {
    const carousel = document.getElementById("hero-carousel");
    const track = document.getElementById("carousel-track");

    if (!carousel || !track) return;
    if (carousel.dataset.observerInitialized === "true") return;
    carousel.dataset.observerInitialized = "true";

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            track.style.animationPlayState = "running";
          } else {
            track.style.animationPlayState = "paused";
          }
        });
      },
      { rootMargin: "200px" },
    );

    observer.observe(carousel);
  }

  initCarouselObserver();
  document.addEventListener("astro:page-load", initCarouselObserver);

  function initHeroCTA() {
    const cta = document.getElementById("hero-cta-secondary");
    const form = document.getElementById("contact-form");
    const nameInput = document.getElementById("name");

    if (!cta || !form) return;
    if (cta.dataset.initialized === "true") return;
    cta.dataset.initialized = "true";

    cta.addEventListener("click", (e) => {
      e.preventDefault();

      const isMobile = window.matchMedia("(pointer: coarse)").matches;

      if (isMobile) {
        form.setAttribute("tabindex", "-1");
        form.focus({ preventScroll: true });
        form.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        if (nameInput) {
          nameInput.focus({ preventScroll: true });
          nameInput.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          form.setAttribute("tabindex", "-1");
          form.focus({ preventScroll: true });
          form.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }
    });
  }

  initHeroCTA();
  document.addEventListener("astro:page-load", initHeroCTA);

  /**
   * ‚ö° Bolt: Animation Cleanup
   * Removes will-change property after entrance animation to free GPU memory.
   */
  function initAnimationCleanup() {
    const title = document.querySelector(".hero-title") as HTMLElement | null;
    if (!title) return;

    if (title.dataset.cleanupInitialized === "true") return;
    title.dataset.cleanupInitialized = "true";

    title.addEventListener("animationend", (e: Event) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains("letter-animate")) {
        target.style.willChange = "auto";
      }
    });
  }

  initAnimationCleanup();
  document.addEventListener("astro:page-load", initAnimationCleanup);
</script>
