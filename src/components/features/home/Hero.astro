---
import { getImage } from "astro:assets";
import { getCollection } from "astro:content";
import logo from "../../../assets/logo.avif";
import BackgroundAnimation from "./BackgroundAnimation.astro";

// Fetch all project images
const projects = await getCollection("project");
const projectImages = projects.map((p) => ({
  src: p.data.image,
  alt: p.data.title,
}));

// Shuffle images function
function shuffle(array: any[]) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

const slides = shuffle([...projectImages]).slice(0, 15);
// ‚ö° Bolt: Optimize carousel images
// Pre-generate optimized WebP assets to avoid using <Picture> (which creates multiple <source> tags).
// Use WebP (98% support) instead of AVIF (93%) to ensure compatibility while maintaining
// the performance benefits of a single <img> tag.
// This reduces DOM nodes in the carousel by ~66% (from ~90 to ~30 nodes).
const optimizedSlides = await Promise.all(
  slides.map(async (slide) => {
    // Generate candidates for srcset matching the original Picture configuration
    const [w224, w288, w448, w576] = await Promise.all([
      getImage({ src: slide.src, width: 224, format: "webp", quality: 80 }),
      getImage({ src: slide.src, width: 288, format: "webp", quality: 80 }),
      getImage({ src: slide.src, width: 448, format: "webp", quality: 80 }),
      getImage({ src: slide.src, width: 576, format: "webp", quality: 80 }),
    ]);

    return {
      alt: slide.alt,
      src: w288.src, // Default src
      srcset: `${w224.src} 224w, ${w288.src} 288w, ${w448.src} 448w, ${w576.src} 576w`,
      sizes: "(max-width: 768px) 224px, 288px",
    };
  }),
);

// ‚ö° Bolt: Duplicate slides for seamless infinite scroll
// Limited to 15 unique items (30 total) to cap DOM nodes and memory usage
const allSlides = [...optimizedSlides, ...optimizedSlides];

// ‚ö° Bolt: Precompute LCP image URL to match Base.astro preload exactly
const optimizedLogo = await getImage({ src: logo, width: 360, format: "avif" });
---

<section
  class="relative overflow-hidden min-h-[90vh] flex flex-col justify-center items-center pt-20 pb-10"
>
  <!-- Background Glows -->
  <BackgroundAnimation />

  <div class="container mx-auto px-7 text-center z-10">
    {/* ‚ö° LCP Image - decoding="sync" ensures immediate display after load */}
    <div class="mb-8 hero-logo">
      {
        /* ‚ö° Bolt: Using standard <img> to match the preloaded asset in Base.astro exactly.
          This prevents double-fetching (preload + responsive candidate mismatch) and guarantees LCP boost.
      */
      }
      <img
        src={optimizedLogo.src}
        alt="Logo Samuel Dulex"
        width="180"
        height="180"
        class="mx-auto rounded-2xl shadow-glow-accent w-[180px] lcp-image"
        loading="eager"
        decoding="sync"
        fetchpriority="high"
      />
    </div>

    <h1
      class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 tracking-tight hero-title"
    >
      <span class="sr-only">Connecter.</span>
      <span
        class="hero-text-subtle text-pacamara-primary/60 dark:text-white/60 inline-block"
        aria-hidden="true"
      >
        <span class="letter-animate">C</span><span class="letter-animate"
          >o</span
        ><span class="letter-animate">n</span><span class="letter-animate"
          >n</span
        ><span class="letter-animate">e</span><span class="letter-animate"
          >c</span
        ><span class="letter-animate">t</span><span class="letter-animate"
          >e</span
        ><span class="letter-animate">r</span><span class="letter-animate"
          >.</span
        >
      </span>
      <br class="md:hidden" />
      <span class="sr-only">Captiver.</span>
      <span class="text-shimmer inline-block" aria-hidden="true">
        <span class="letter-animate delay-100">C</span><span
          class="letter-animate delay-150">a</span
        ><span class="letter-animate delay-200">p</span><span
          class="letter-animate delay-250">t</span
        ><span class="letter-animate delay-300">i</span><span
          class="letter-animate delay-350">v</span
        ><span class="letter-animate delay-400">e</span><span
          class="letter-animate delay-450">r</span
        ><span class="letter-animate delay-500">.</span>
      </span>
    </h1>

    <p
      class="text-xl md:text-2xl text-pacamara-primary dark:text-white max-w-2xl mx-auto mb-6 font-outfit font-light hero-subtitle text-balance"
    >
      L'Art de transformer chaque √©v√©nement en <span
        class="text-pacamara-accent font-semibold">Histoire</span
      >.
    </p>

    <!-- ‚ö° Bolt: Simple services summary -->
    <ul
      class="flex flex-wrap justify-center gap-x-4 gap-y-2 mb-10 text-[10px] md:text-xs font-pacamara-space font-bold uppercase tracking-widest text-pacamara-primary/80 dark:text-white/80 hero-services"
    >
      <li>Production Vid√©o</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>D√©veloppement Web</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>Photographie</li>
      <li class="text-pacamara-accent/30" aria-hidden="true">‚Ä¢</li>
      <li>Strat√©gie Digitale</li>
    </ul>

    <div
      class="flex flex-col md:flex-row gap-4 justify-center items-center hero-buttons"
    >
      <a
        href="/project"
        class="group relative block px-8 py-4 bg-pacamara-primary dark:bg-white text-white dark:text-pacamara-primary rounded-full font-bold text-lg shadow-lg hover:shadow-glow overflow-hidden active:scale-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pacamara-accent"
        id="hero-cta-primary"
      >
        <span class="relative z-10">Voir mes projets</span>
        <div
          class="absolute inset-0 bg-linear-to-r from-pacamara-secondary to-pacamara-accent opacity-0 group-hover:opacity-100 transition-opacity duration-300"
        >
        </div>
      </a>

      <a
        href="#contact-form"
        class="block px-8 py-4 bg-pacamara-secondary text-white rounded-full font-bold text-lg shadow-lg hover:shadow-glow hover-lift active:scale-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-pacamara-accent"
        id="hero-cta-secondary"
      >
        Me contacter
      </a>
    </div>
  </div>

  <!-- Infinite Scroll Carousel -->
  <div
    class="w-full mt-16 overflow-hidden hero-carousel touch-carousel contain-layout-paint"
    id="hero-carousel"
  >
    <div class="infinite-scroll py-8 pb-12 duration-120s" id="carousel-track">
      {/* Duplicate slides for seamless infinite scroll */}
      {
        allSlides.map((slide, index) => (
          <div
            class="relative w-56 md:w-72 aspect-9-10 flex-none rounded-2xl overflow-hidden shadow-glass mx-3 hover:scale-105 transition-transform duration-500 image-zoom"
            style={`transform: rotate(${(index % 5) * 3 - 6}deg)`}
          >
            {/* ‚ö° Bolt: Replaced <Picture> with <img> to reduce DOM nodes during animation */}
            <img
              src={slide.src}
              srcset={slide.srcset}
              sizes={slide.sizes}
              alt={slide.alt}
              width="288"
              height="320"
              class="object-cover w-full h-full"
              loading={index < 3 ? "eager" : "lazy"}
              decoding="async"
              fetchpriority={index < 3 ? "high" : "low"}
            />
            <div class="absolute inset-0 bg-linear-to-t from-black/40 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300" />
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  /* Letter Animation - GPU-composited */
  @keyframes letter-appear {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .letter-animate {
    display: inline-block;
    opacity: 0;
    animation: letter-appear 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    will-change: transform, opacity;
  }

  .hero-title .letter-animate:nth-child(1) {
    animation-delay: 0.1s;
  }
  .hero-title .letter-animate:nth-child(2) {
    animation-delay: 0.15s;
  }
  .hero-title .letter-animate:nth-child(3) {
    animation-delay: 0.2s;
  }
  .hero-title .letter-animate:nth-child(4) {
    animation-delay: 0.25s;
  }
  .hero-title .letter-animate:nth-child(5) {
    animation-delay: 0.3s;
  }
  .hero-title .letter-animate:nth-child(6) {
    animation-delay: 0.35s;
  }
  .hero-title .letter-animate:nth-child(7) {
    animation-delay: 0.4s;
  }
  .hero-title .letter-animate:nth-child(8) {
    animation-delay: 0.45s;
  }
  .hero-title .letter-animate:nth-child(9) {
    animation-delay: 0.5s;
  }
  .hero-title .letter-animate:nth-child(10) {
    animation-delay: 0.55s;
  }

  /* Hero elements entrance animations */
  /* Note: hero-logo has NO initial opacity:0 to ensure LCP is visible immediately */
  .hero-logo {
    /* Logo is visible immediately for LCP - no animation delay */
  }

  /* ‚ö° LCP image - hover effect separated from initial render */
  .lcp-image {
    transition: transform 0.5s ease;
  }
  .lcp-image:hover {
    transform: scale(1.05);
  }

  .hero-subtitle {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.6s forwards;
  }

  .hero-services {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.7s forwards;
  }

  .hero-buttons {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.9s forwards;
  }

  .hero-carousel {
    opacity: 0;
    animation: fade-slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) 1s forwards;
  }

  @keyframes fade-slide-up {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Gradient mask for carousel edges */
  .hero-carousel {
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 10%,
      black 90%,
      transparent 100%
    );
  }

  /* Touch-friendly carousel on mobile - allow scrolling while keeping animation */
  @media (pointer: coarse) {
    .touch-carousel {
      cursor: grab;
    }

    .touch-carousel:active {
      cursor: grabbing;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .letter-animate {
      opacity: 1;
      animation: none;
      transform: none;
    }
    .hero-logo,
    .hero-subtitle,
    .hero-buttons,
    .hero-carousel {
      opacity: 1;
      animation: none;
    }
  }
</style>

<script>
  /**
   * ‚ö° Bolt: Carousel Touch Optimization
   * Added initialization guard and passive listeners to all touch events
   */
  function initCarouselTouch() {
    const carousel = document.getElementById("hero-carousel");
    const track = document.getElementById("carousel-track");

    // ‚ö° Early return guards
    if (!carousel || !track) return;
    if (carousel.dataset.touchInitialized === "true") return;
    carousel.dataset.touchInitialized = "true";

    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let rafId: number | null = null;
    let lastTouchX = 0;

    carousel.addEventListener(
      "touchstart",
      (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        track.style.animationPlayState = "paused";
        const computedStyle = getComputedStyle(track);
        const matrix = new DOMMatrix(computedStyle.transform);
        currentTranslate = matrix.m41;
      },
      { passive: true },
    );

    // ‚ö° Bolt: Use requestAnimationFrame for smooth 60fps tracking
    carousel.addEventListener(
      "touchmove",
      (e) => {
        if (!isDragging) return;
        lastTouchX = e.touches[0].clientX;

        if (!rafId) {
          rafId = requestAnimationFrame(() => {
            const diff = lastTouchX - startX;
            track.style.transform = `translateX(${currentTranslate + diff}px)`;
            rafId = null;
          });
        }
      },
      { passive: true },
    );

    // ‚ö° Bolt: Added passive: true to touchend for scroll optimization
    carousel.addEventListener(
      "touchend",
      () => {
        isDragging = false;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        track.style.transform = "";
        track.style.animationPlayState = "running";
      },
      { passive: true },
    );
  }

  initCarouselTouch();
  document.addEventListener("astro:page-load", initCarouselTouch);

  /**
   * ‚ö° Bolt: Carousel Visibility Optimization
   * Pauses the infinite scroll animation when the carousel is not in the viewport
   * to save GPU and main thread resources.
   */
  function initCarouselObserver() {
    const carousel = document.getElementById("hero-carousel");
    const track = document.getElementById("carousel-track");

    if (!carousel || !track) return;

    // Guard against duplicate observers
    if (carousel.dataset.observerInitialized === "true") return;
    carousel.dataset.observerInitialized = "true";

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            track.style.animationPlayState = "running";
          } else {
            track.style.animationPlayState = "paused";
          }
        });
      },
      { rootMargin: "200px" },
    ); // Pre-load animation slightly before it enters viewport

    observer.observe(carousel);
  }

  initCarouselObserver();
  document.addEventListener("astro:page-load", initCarouselObserver);

  /**
   * üé® Palette: Smart Focus for Contact CTA
   * Smooth scrolls to form and intelligently manages focus:
   * - Desktop: Focuses input for immediate typing
   * - Mobile: Focuses form container to avoid keyboard pop-up while scrolling
   */
  function initHeroCTA() {
    const cta = document.getElementById("hero-cta-secondary");
    const form = document.getElementById("contact-form");
    const nameInput = document.getElementById("name");

    if (!cta || !form) return;

    // Guard against duplicate listeners
    if (cta.dataset.initialized === "true") return;
    cta.dataset.initialized = "true";

    cta.addEventListener("click", (e) => {
      e.preventDefault();

      // Check if device uses coarse pointer (likely touch/mobile)
      const isMobile = window.matchMedia("(pointer: coarse)").matches;

      if (isMobile) {
        // Mobile: Scroll to form container and focus it
        // This brings the form into view without triggering the keyboard
        form.setAttribute("tabindex", "-1");
        form.focus({ preventScroll: true });
        form.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        // Desktop: Focus input directly for immediate typing
        if (nameInput) {
          nameInput.focus({ preventScroll: true }); // Set focus without jump
          nameInput.scrollIntoView({ behavior: "smooth", block: "center" });
        } else {
          // Fallback if input not found
          form.setAttribute("tabindex", "-1");
          form.focus({ preventScroll: true });
          form.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }
    });
  }

  initHeroCTA();
  document.addEventListener("astro:page-load", initHeroCTA);

  /**
   * ‚ö° Bolt: Animation Memory Cleanup
   * Removes will-change from animated elements after entrance animation completes
   * to free up GPU memory (compositor layers).
   */
  function cleanupHeroAnimations() {
    const letters = document.querySelectorAll(".letter-animate");
    if (!letters.length) return;

    // Guard against duplicate execution
    if (letters[0].getAttribute("data-cleaned") === "true") return;

    // Wait for animations to finish (max delay ~0.55s + duration 0.6s + buffer)
    setTimeout(() => {
      letters.forEach((el) => {
        if (el instanceof HTMLElement) {
          el.style.willChange = "auto";
          el.setAttribute("data-cleaned", "true");
        }
      });
    }, 2000);
  }

  cleanupHeroAnimations();
  document.addEventListener("astro:page-load", cleanupHeroAnimations);
</script>
