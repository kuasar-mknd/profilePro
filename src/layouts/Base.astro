---
import SeoHead from "../components/common/SeoHead.astro";
import LocalBusinessSchema from "../components/common/LocalBusinessSchema.astro";
import Header from "../components/common/Header.astro";
import Footer from "../components/common/Footer.astro";
import Lightbox from "../components/ui/Lightbox.astro";
import "../css/style.css";
// Fonts are now manually imported in <head> to allow preloading
// import "@fontsource/inter";
// import "@fontsource/space-grotesk";
// import "@fontsource/outfit";

import { ClientRouter } from "astro:transitions";
import { getImage } from "astro:assets";
import { safeJson } from "../utils/security";
import logo from "../assets/logo.avif";

// Precompute LCP image URL for preloading
const heroLogo = await getImage({ src: logo, width: 360, format: "avif" });

const {
  postData,
  jsonLd,
  noPadding = false,
  lang = "fr",
  noindex = false,
} = Astro.props;
const PUBLIC_CF_ANALYTICS_TOKEN = import.meta.env.PUBLIC_CF_ANALYTICS_TOKEN;

// ‚ö° Bolt: Precompute LCP image for subpages (Project/Blog posts)
let lcpImage: Awaited<ReturnType<typeof getImage>> | null = null;
if (postData?.data?.image) {
  lcpImage = await getImage({
    src: postData.data.image,
    width: 1600,
    format: "avif",
  });
}
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <!-- ‚ö° Preconnect hints FIRST for maximum early connection (190ms+ LCP savings) -->
    <link
      rel="preconnect"
      href="https://static.cloudflareinsights.com"
      crossorigin
    />
    <link rel="dns-prefetch" href="https://static.cloudflareinsights.com" />
    <!-- ‚ö° Bolt: Downgraded non-critical third-parties to dns-prefetch to save connection slots -->
    <link rel="dns-prefetch" href="https://api.websitecarbon.com" />
    <link rel="dns-prefetch" href="https://api.web3forms.com" />
    <link rel="dns-prefetch" href="https://i.ytimg.com" />
    <link rel="dns-prefetch" href="https://www.youtube.com" />
    <link rel="dns-prefetch" href="https://vimeo.com" />
    <link rel="dns-prefetch" href="https://player.vimeo.com" />
    <style>
      @media (prefers-reduced-motion: reduce) {
        :global(html) {
          scroll-behavior: auto !important;
        }
      }
    </style>
    <!-- Font Preloads (Critical Request Chain Optimization) -->
    <link
      rel="preload"
      href="/fonts/space-grotesk-bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
      fetchpriority="high"
    />
    <!-- ‚ö° Bolt: Removed fetchpriority="high" from non-LCP fonts (Light/Regular) -->
    <!-- This reduces network contention, allowing the LCP Image and Heading Font to load faster -->
    <link
      rel="preload"
      href="/fonts/outfit-light.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/outfit-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <!-- ‚ö° Bolt: Added Outfit Bold preload as it's used in Hero buttons (LCP) -->
    <link
      rel="preload"
      href="/fonts/outfit-bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <!-- LCP Image Preload (Hero Logo) - Only on Homepage -->
    {
      Astro.url.pathname === "/" && (
        <link
          rel="preload"
          href={heroLogo.src}
          as="image"
          type="image/avif"
          fetchpriority="high"
        />
      )
    }

    <!-- ‚ö° Bolt: LCP Image Preload (Project/Post Hero) -->
    {
      lcpImage && (
        <link
          rel="preload"
          href={lcpImage.src}
          as="image"
          type="image/avif"
          fetchpriority="high"
        />
      )
    }

    <!-- ‚ö° Bolt: Speculation Rules API for instant navigation -->
    <script
      type="speculationrules"
      is:inline
      set:html={safeJson({
        prerender: [
          {
            source: "document",
            where: {
              href_matches: "/*",
            },
            eagerness: "moderate",
          },
        ],
      })}
    />
    <style is:global>
      /* Manual Font Face Definitions */
      @font-face {
        font-family: "Space Grotesk";
        src: url("/fonts/space-grotesk-bold.woff2") format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Outfit";
        src: url("/fonts/outfit-light.woff2") format("woff2");
        font-weight: 300;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Outfit";
        src: url("/fonts/outfit-regular.woff2") format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "Outfit";
        src: url("/fonts/outfit-bold.woff2") format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
    </style>
    <!-- Critical preconnects - must be early in head for effectiveness -->
    <meta name="theme-color" content="#f8fafc" />
    <script is:inline>
      // Early theme detection to prevent FOUC
      if (
        localStorage.getItem("theme") === "dark" ||
        (!localStorage.getItem("theme") &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      }
    </script>
    <SeoHead postData={postData} jsonLd={jsonLd} noindex={noindex} />
    <LocalBusinessSchema />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/manifest.json" />
    <ClientRouter />
  </head>
  <body
    class="bg-pacamara-white dark:bg-pacamara-dark transition-colors duration-300 min-h-screen flex flex-col relative"
  >
    <!-- Scroll Sentinel for Back to Top visibility -->
    <div
      id="scroll-sentinel"
      class="absolute top-0 w-full h-[300px] pointer-events-none -z-50"
      style="contain: strict;"
      aria-hidden="true"
    >
    </div>

    <!-- üé® Palette: Accessible Skip Links -->
    <div
      class="fixed top-4 left-4 z-[100] flex flex-col gap-2 pointer-events-none"
    >
      <a
        href="#main-content"
        class="sr-only focus:not-sr-only px-6 py-3 bg-white text-pacamara-primary font-bold rounded-full shadow-lg border border-pacamara-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 pointer-events-auto"
      >
        Aller au contenu principal
      </a>
      <a
        href="#main-footer"
        class="sr-only focus:not-sr-only px-6 py-3 bg-white text-pacamara-primary font-bold rounded-full shadow-lg border border-pacamara-secondary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 pointer-events-auto"
      >
        Aller au pied de page
      </a>
    </div>
    <Header />

    <main
      id="main-content"
      class={`grow ${noPadding ? "" : "pt-24"}`}
      transition:animate="fade"
      tabindex="-1"
      style="contain: layout;"
    >
      <slot />
    </main>

    <Footer />

    <!-- Lightbox at body level for proper fixed positioning -->
    <Lightbox />

    <!-- Back to Top Button -->
    <button
      id="back-to-top"
      class="fixed bottom-6 right-6 z-50 w-12 h-12 flex items-center justify-center rounded-full bg-pacamara-secondary/90 text-white shadow-lg hover:bg-pacamara-accent transition-all duration-300 opacity-0 invisible translate-y-4 hover-lift focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 group"
      aria-label="Retour en haut de page"
      title="Retour en haut de page"
      tabindex="-1"
    >
      <!-- üé® Palette: Circular Progress Indicator -->
      <svg
        class="absolute inset-0 w-full h-full -rotate-90 pointer-events-none p-0.5"
        viewBox="0 0 36 36"
        aria-hidden="true"
      >
        <!-- Track -->
        <path
          class="text-white/20"
          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
          fill="none"
          stroke="currentColor"
          stroke-width="3"></path>
        <!-- Progress -->
        <path
          id="scroll-progress-circle"
          class="text-white transition-all duration-100 ease-out"
          stroke-dasharray="100, 100"
          stroke-dashoffset="100"
          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"></path>
      </svg>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="relative z-10 h-5 w-5 transition-transform duration-300 group-hover:-translate-y-0.5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2.5"
          d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
      </svg>
    </button>

    <!-- üé® Palette: Scroll Progress Bar -->
    <div
      id="scroll-progress-bar"
      class="fixed top-0 left-0 right-0 h-1.5 bg-pacamara-accent z-[1000] origin-left scale-x-0 transition-transform duration-100 ease-out pointer-events-none shadow-sm"
      role="progressbar"
      aria-valuemin="0"
      aria-valuemax="100"
      aria-valuenow="0"
      aria-label="Progression de la lecture"
    >
    </div>

    <script>
      /**
       * ‚ö° Bolt: Back to Top Performance Optimization
       * - Implements cleanup pattern to prevent event listener leaks on navigation
       * - Caches layout metrics to avoid layout thrashing in scroll handler
       * - Throttles scroll updates using requestAnimationFrame
       */
      let backToTopObserver: IntersectionObserver | null = null;
      let cleanupScroll: (() => void) | null = null;
      let cleanupBackToTop: (() => void) | null = null;

      function initBackToTop() {
        // ‚ö° Cleanup previous listeners before initializing new ones
        if (cleanupBackToTop) {
          cleanupBackToTop();
          cleanupBackToTop = null;
        }

        const backToTopBtn = document.getElementById("back-to-top");
        const sentinel = document.getElementById("scroll-sentinel");
        const progressCircle = document.getElementById(
          "scroll-progress-circle",
        );
        // üé® Palette: Top Progress Bar
        const progressBar = document.getElementById("scroll-progress-bar");

        // ‚ö° Early return if elements don't exist
        if (!backToTopBtn || !sentinel || !progressCircle || !progressBar)
          return;

        // ‚ö° RAF ID for animation tracking
        let rafId: number | null = null;
        // ‚ö° Bolt: Cache document height to avoid layout thrashing
        let cachedDocHeight = 0;
        let resizeObserver: ResizeObserver | null = null;

        // ‚ö° Clean up previous listeners to prevent stacking on navigation
        if (cleanupScroll) {
          cleanupScroll();
          cleanupScroll = null;
        }

        // ‚ö° Bolt: RAF throttling state
        let ticking = false;

        // ‚ö° Bolt: Efficiently update dimensions only when they change
        const updateDimensions = () => {
          cachedDocHeight =
            document.documentElement.scrollHeight -
            document.documentElement.clientHeight;
        };

        // üé® Palette: Scroll Progress Logic with RAF throttling
        const updateVisuals = () => {
          if (!progressCircle || !progressBar) return;
          const scrollTop = window.scrollY;

          // ‚ö° Bolt: Use cached height instead of querying DOM (prevents reflow)
          const scrollPercent =
            cachedDocHeight > 0 ? Math.min(scrollTop / cachedDocHeight, 1) : 0;
          const draw = scrollPercent * 100;

          // Update Circular Progress
          progressCircle.style.strokeDashoffset = (100 - draw).toString();

          // Update Top Progress Bar (ScaleX is performant)
          progressBar.style.transform = `scaleX(${scrollPercent})`;
          progressBar.setAttribute(
            "aria-valuenow",
            Math.round(draw).toString(),
          );

          ticking = false;
        };

        const onScroll = () => {
          if (!ticking) {
            window.requestAnimationFrame(updateVisuals);
            ticking = true;
          }
        };

        // Update visual state (deferred until button is visible)
        // ‚ö° Bolt: Observe body for size changes (lazy loading, accordion, etc)
        resizeObserver = new ResizeObserver(() => {
          updateDimensions();
          // Update visuals immediately in case scroll pos stayed same but height changed
          window.requestAnimationFrame(updateVisuals);
        });
        resizeObserver.observe(document.documentElement);

        // Initial calculation
        updateDimensions();
        updateVisuals();

        // Register cleanup
        cleanupScroll = () => {
          window.removeEventListener("scroll", onScroll);
          if (resizeObserver) resizeObserver.disconnect();
        };

        // ‚ö° Early return if already initialized
        if (backToTopBtn.dataset.initialized === "true") return;
        backToTopBtn.dataset.initialized = "true";

        // ‚ö° Reuse observer if already created
        if (!backToTopObserver) {
          backToTopObserver = new IntersectionObserver(
            (entries) => {
              const entry = entries[0];
              const btn = document.getElementById("back-to-top");
              if (!btn) return;

              // If sentinel is NOT intersecting (scrolled past), show button
              if (!entry.isIntersecting) {
                btn.classList.remove("opacity-0", "invisible", "translate-y-4");
                btn.classList.add("visible", "translate-y-0");
                btn.setAttribute("tabindex", "0");
                // ‚ö° Bolt: Only listen to scroll when button is visible to save resources
                // NOTE: We now listen continuously for the Top Progress Bar
                // window.addEventListener("scroll", onScroll, { passive: true });
                // onScroll(); // Update visuals immediately
              } else {
                btn.classList.add("opacity-0", "invisible", "translate-y-4");
                btn.classList.remove("visible", "translate-y-0");
                btn.setAttribute("tabindex", "-1");
                // ‚ö° Bolt: Detach listener when button is hidden to save main thread
                // NOTE: We keep listening for the Top Progress Bar
                // window.removeEventListener("scroll", onScroll);
              }
            },
            {
              root: null, // viewport
              threshold: 0,
            },
          );
        }

        backToTopObserver.observe(sentinel);

        // üé® Palette: Always listen to scroll for the Top Progress Bar, not just when BackToTop is visible
        window.addEventListener("scroll", onScroll, { passive: true });

        // Scroll to top action
        const onClick = () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
          const main = document.getElementById("main-content");
          if (main) {
            if (!main.hasAttribute("tabindex")) {
              main.setAttribute("tabindex", "-1");
            }
            main.focus({ preventScroll: true });
          }
        };
        backToTopBtn.addEventListener("click", onClick);

        // ‚ö° Register cleanup
        cleanupBackToTop = () => {
          window.removeEventListener("scroll", onScroll);
          if (resizeObserver) resizeObserver.disconnect();
          if (backToTopObserver) {
            backToTopObserver.disconnect();
            backToTopObserver = null; // ‚ö° Bolt: Ensure fresh observer with correct closure scope
          }
          backToTopBtn.removeEventListener("click", onClick);
          if (rafId) cancelAnimationFrame(rafId);
        };
      }

      // Initialize on load and after view transitions
      document.addEventListener("astro:page-load", initBackToTop);

      // Update theme-color meta tag based on current theme
      function updateThemeColor() {
        const isDark = document.documentElement.classList.contains("dark");
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) {
          meta.setAttribute("content", isDark ? "#0b0f19" : "#f8fafc");
        }
      }

      // ‚ö° Bolt: Theme Color Observer (Singleton Pattern)
      // Moved to module scope to prevent memory leaks from stacking observers
      let themeObserver: MutationObserver | null = null;

      function initThemeObserver() {
        if (themeObserver) return; // Already initialized

        themeObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === "class") {
              updateThemeColor();
            }
          });
        });

        themeObserver.observe(document.documentElement, { attributes: true });
      }

      // Initialize on load
      document.addEventListener("astro:page-load", initThemeObserver);

      // üõ°Ô∏è Sentinel: Prevent Reverse Tabnabbing & üé® Palette: Accessibility
      // Ensures all external links opening in a new tab have rel="noopener noreferrer"
      // and a warning in title/aria-label.
      const warning = " (ouvre un nouvel onglet)";

      function secureLink(link: Element) {
        if (link.tagName !== "A" || link.getAttribute("target") !== "_blank")
          return;

        // üõ°Ô∏è Sentinel: Robustly ensure both noopener and noreferrer are present
        const rel = link.getAttribute("rel") || "";
        const relValues = new Set(rel.split(" ").filter(Boolean));
        relValues.add("noopener");
        relValues.add("noreferrer");
        link.setAttribute("rel", Array.from(relValues).join(" "));

        // Accessibility: Append warning to title
        const title = link.getAttribute("title") || "";
        if (!title.includes(warning.trim())) {
          link.setAttribute("title", title ? title + warning : warning.trim());
        }

        // Accessibility: Append warning to aria-label (only if present)
        const ariaLabel = link.getAttribute("aria-label");
        if (ariaLabel) {
          if (!ariaLabel.includes(warning.trim())) {
            link.setAttribute("aria-label", ariaLabel + warning);
          }
        } else {
          // üé® Palette: If no aria-label, inject SR-only span to preserve accessible name calculation (text + alt)
          if (!link.querySelector(".external-link-warning")) {
            const span = document.createElement("span");
            span.className = "sr-only external-link-warning";
            span.textContent = warning;
            link.appendChild(span);
          }
        }
      }

      function secureLinks() {
        // ‚ö° Bolt: Removed expensive MutationObserver(subtree: true) on body.
        // Links are now secured only on initial load and navigation (astro:page-load),
        // effectively reducing main-thread CPU usage during general interaction.
        // Dynamic components (Footer, etc.) handle their own link security.
        document.querySelectorAll('a[target="_blank"]').forEach(secureLink);
      }

      // Run on load and after view transitions
      document.addEventListener("astro:page-load", secureLinks);
    </script>
    <script>
      /**
       * ‚ö° Bolt: Global Background Animation Optimizer
       * Pauses infinite CSS animations (.floating, .floating-slow) when elements
       * are off-screen to save GPU memory and CPU cycles.
       */
      let animationObserver: IntersectionObserver | null = null;

      function initAnimationOptimizer() {
        // Disconnect previous observer
        if (animationObserver) {
          animationObserver.disconnect();
          animationObserver = null;
        }

        // Select all floating elements
        const animatedElements = document.querySelectorAll(
          ".floating, .floating-slow, .floating-delayed",
        );

        if (animatedElements.length === 0) return;

        animationObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (!entry.isIntersecting) {
                entry.target.classList.add("paused");
              } else {
                entry.target.classList.remove("paused");
              }
            });
          },
          { rootMargin: "200px" }, // Pre-load slightly before viewport
        );

        animatedElements.forEach((el) => animationObserver?.observe(el));
      }

      // Initialize on load and after swaps
      initAnimationOptimizer();
      document.addEventListener("astro:after-swap", initAnimationOptimizer);
    </script>
    <script>
      import { registerSW } from "virtual:pwa-register";

      if ("serviceWorker" in navigator) {
        registerSW({
          immediate: true,
          onNeedRefresh() {
            if (import.meta.env.DEV)
              console.log("‚ö° Bolt PWA: New content available");
          },
          onOfflineReady() {
            if (import.meta.env.DEV)
              console.log("‚ö° Bolt PWA: App ready to work offline");
          },
        });
      }
    </script>
    <!-- Cloudflare Web Analytics -->
    <script
      defer
      is:inline
      src="https://static.cloudflareinsights.com/beacon.min.js"
      data-cf-beacon={safeJson({
        token: PUBLIC_CF_ANALYTICS_TOKEN,
      })}></script>
    <!-- End Cloudflare Web Analytics -->
  </body>
</html>
