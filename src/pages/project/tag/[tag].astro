---
import { getCollection } from "astro:content";
import Base from "../../../layouts/Base.astro";
import Post from "../../../components/features/projects/Post.astro";
import ProjectFilter from "../../../components/features/projects/ProjectFilter.astro";
import ScrollReveal from "../../../components/ui/ScrollReveal.astro";
import Breadcrumbs from "../../../components/ui/Breadcrumbs.astro";
import EmptyState from "../../../components/ui/EmptyState.astro";

export async function getStaticPaths() {
  const allProjects = await getCollection("project");

  // ⚡ Bolt: Replace O(N*M) nested filter with O(N) hash map grouping for SSG performance
  const tagProjectsMap = new Map<string, typeof allProjects>();

  for (const project of allProjects) {
    const projectTags = Array.isArray(project.data.tag)
      ? project.data.tag
      : [project.data.tag];

    for (const tag of projectTags) {
      if (!tagProjectsMap.has(tag)) {
        tagProjectsMap.set(tag, []);
      }
      tagProjectsMap.get(tag)!.push(project);
    }
  }

  const uniqueTags = Array.from(tagProjectsMap.keys());

  return uniqueTags.map((tag) => {
    const filteredProjects = tagProjectsMap.get(tag)!;
    const sortedProjects = filteredProjects.sort(
      (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
    );

    return {
      params: { tag },
      props: { projects: sortedProjects, allTags: uniqueTags },
    };
  });
}

const { tag } = Astro.params;
const { projects, allTags } = Astro.props;
---

<Base>
  <section class="container mx-auto max-w-7xl px-7 pt-10 pb-14">
    <ScrollReveal class="text-center mb-10">
      <Breadcrumbs
        items={[
          { label: "Accueil", href: "/" },
          { label: "Projets", href: "/project" },
          { label: tag },
        ]}
      />
      <h1
        class="text-3xl md:text-5xl font-pacamara-space font-bold mb-6 text-pacamara-dark dark:text-white relative inline-block"
      >
        <span class="text-shimmer">Projets</span>
        <span class="capitalize">{tag}</span>
      </h1>
      <ProjectFilter tags={allTags} activeTag={tag} />
    </ScrollReveal>

    {
      /* ⚡ Bolt: Performance Optimization - content-visibility skips rendering when off-screen */
    }
    <div
      class="flex flex-wrap justify-center gap-8 mb-16 [content-visibility:auto] [contain-intrinsic-size:auto_2000px] contain-layout"
    >
      {
        projects.length === 0 ? (
          <EmptyState message={`Aucun projet trouvé avec le tag "${tag}".`} />
        ) : (
          projects.map((post, index) => (
            <ScrollReveal
              delay={index * 0.1}
              class="w-full md:w-[calc(50%-1rem)]"
            >
              <Post postData={post} num={index} priority={index < 2} />
            </ScrollReveal>
          ))
        )
      }
    </div>
  </section>
</Base>
