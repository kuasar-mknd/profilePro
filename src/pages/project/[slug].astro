---
import { Picture } from "astro:assets";

import Base from "../../layouts/Base.astro";
import AuthorInfo from "../../components/features/projects/AuthorInfo.astro";
import LatestPosts from "../../components/features/projects/LatestPosts.astro";
import PublishDate from "../../components/features/projects/PublishDate.astro";
import Tag from "../../components/ui/Tag.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";

import { Icon } from "astro-icon/components";
import VideoPlayer from "../../components/features/projects/VideoPlayer.astro";
import ImageGallery from "../../components/ui/ImageGallery.astro";

import { getCollection, getEntry } from "astro:content";
import config from "../../config.mjs";

export async function getStaticPaths() {
  const projectEntries = (await getCollection("project")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

  return projectEntries.map((entry, index) => ({
    params: { slug: entry.slug },
    props: {
      entry,
      prevPost:
        index + 1 < projectEntries.length ? projectEntries[index + 1] : null,
      nextPost: index > 0 ? projectEntries[index - 1] : null,
    },
  }));
}
const { entry, prevPost, nextPost } = Astro.props;

// Calculate reading time
const wordCount = entry.body ? entry.body.split(/\s+/g).length : 0;
const readingTime = Math.ceil(wordCount / 200);

const { Content } = await entry.render();
const author = await getEntry(entry.data.author);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": entry.data.type === "video" ? "VideoObject" : "CreativeWork",
  headline: entry.data.title,
  description: entry.data.seoDescription || entry.data.intro,
  image: entry.data.image
    ? new URL(entry.data.image.src, Astro.url).toString()
    : undefined,
  datePublished: entry.data.pubDate.toISOString(),
  author: {
    "@type": "Person",
    name: "Samuel Dulex",
  },
  ...(entry.data.type === "video" && entry.data.videoUrl
    ? {
        contentUrl: entry.data.videoUrl,
        uploadDate: entry.data.pubDate.toISOString(),
        thumbnailUrl: entry.data.image
          ? new URL(entry.data.image.src, Astro.url).toString()
          : undefined,
      }
    : {}),
};
---

<Base postData={entry} jsonLd={jsonLd} noPadding={true}>
  <!-- Scroll Progress Bar -->
  <div
    class="fixed top-0 left-0 w-full h-1 z-50 bg-transparent pointer-events-none"
  >
    <div
      class="h-full bg-pacamara-accent w-0 transition-all duration-100 ease-out"
      id="scroll-progress"
    >
    </div>
  </div>

  <!-- Project Hero Section -->
  <section
    class="relative w-full h-screen min-h-[600px] flex items-end justify-center overflow-hidden pb-32"
  >
    {
      entry.data.image && (
        <div class="absolute inset-0 z-0">
          {/* Masque pour fondre l'image en haut et en bas */}
          <div
            class="relative w-full h-full"
            style="mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 50%, transparent 100%);"
          >
            <Picture
              src={entry.data.image}
              widths={[400, 800, 1200]}
              sizes="100vw"
              formats={["avif"]}
              fallbackFormat="avif"
              alt={entry.data.title}
              width={1200}
              height={600}
              class="w-full h-full object-cover"
              transition:name={`project-image-${entry.slug}`}
            />
            {/* Overlay adaptatif : Blanc en Light Mode, Noir en Dark Mode */}
            <div class="absolute inset-0 bg-linear-to-t from-white/95 via-white/70 to-transparent dark:from-black/90 dark:via-black/50 dark:to-transparent opacity-90" />
          </div>
        </div>
      )
    }

    <div class="relative z-10 container mx-auto px-7 text-center max-w-5xl">
      <div
        class="inline-flex items-center gap-3 mb-6 animate-fade-in opacity-0"
        style="animation-delay: 0.2s;"
      >
        <Tag tag={entry.data.tag} />
        <PublishDate date={entry.data.pubDate} />

        <span class="text-pacamara-primary/60 dark:text-white/60">•</span>
        <span
          class="text-pacamara-primary/60 dark:text-white/60 text-sm font-outfit uppercase tracking-wider"
          >{readingTime} min de lecture</span
        >
      </div>
      <h1
        class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 text-pacamara-dark dark:text-white animate-slide-up opacity-0 leading-tight tracking-tight drop-shadow-sm dark:drop-shadow-lg"
        style="animation-delay: 0.4s;"
      >
        {entry.data.title}
      </h1>
      {
        entry.data.intro && (
          <p
            class="text-xl md:text-2xl text-pacamara-primary/90 dark:text-white/90 max-w-3xl mx-auto animate-slide-up opacity-0 font-light leading-relaxed drop-shadow-sm dark:drop-shadow-md"
            style="animation-delay: 0.5s;"
          >
            {entry.data.intro}
          </p>
        )
      }
    </div>
  </section>

  <article class="container mx-auto max-w-5xl px-7 -mt-32 relative z-10">
    <!-- Video Player -->
    {
      entry.data.type === "video" && entry.data.videoUrl && (
        <div
          class="w-full rounded-3xl overflow-hidden shadow-2xl mb-16 mt-12 animate-slide-up opacity-0 ring-1 ring-white/10"
          style="animation-delay: 0.6s;"
        >
          <VideoPlayer
            videoUrl={entry.data.videoUrl}
            poster={entry.data.image?.src}
          />
        </div>
      )
    }

    <!-- Photo Gallery -->
    {
      entry.data.type === "photo" &&
        entry.data.gallery &&
        entry.data.gallery.length > 0 && (
          <div
            class="w-full mb-16 animate-slide-up opacity-0"
            style="animation-delay: 0.6s;"
          >
            <ImageGallery images={entry.data.gallery} />
          </div>
        )
    }

    <!-- Content -->
    <div
      class="bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-xl rounded-3xl p-8 md:p-16 shadow-glass
            prose lg:prose-xl max-w-none
            prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-dark dark:prose-headings:text-white
            prose-p:text-pacamara-primary/80 dark:prose-p:text-white/80 prose-p:font-outfit prose-p:leading-relaxed
            prose-a:text-pacamara-accent hover:prose-a:text-pacamara-secondary prose-a:transition-colors
            prose-img:rounded-2xl prose-img:shadow-lg
            dark:prose-strong:text-white
            animate-fade-in opacity-0
            border border-white/20 dark:border-white/5"
      style="animation-delay: 0.8s;"
    >
      <div
        class="mb-8 flex items-center gap-2 text-sm text-pacamara-primary/50 dark:text-white/50"
      >
        <a href="/" class="hover:text-pacamara-accent transition-colors"
          >Accueil</a
        >
        <span>/</span>
        <a
          href={`/project/tag/${entry.data.tag}`}
          class="hover:text-pacamara-accent transition-colors capitalize"
          >{entry.data.tag}</a
        >
        <span>/</span>
        <span class="text-pacamara-primary dark:text-white truncate"
          >{entry.data.title}</span
        >
      </div>
      <Content />

      <!-- Share Button & Navigation -->
      <div
        class="mt-12 pt-8 border-t border-pacamara-secondary/10 flex flex-col md:flex-row justify-between items-center gap-6"
      >
        <button
          id="share-btn"
          class="flex items-center gap-2 px-4 py-2 rounded-full bg-pacamara-secondary/5 hover:bg-pacamara-secondary/10 text-pacamara-primary dark:text-white transition-colors cursor-pointer"
        >
          <Icon name="mdi:share-variant" class="w-5 h-5" />
          <span class="font-medium">Partager ce projet</span>
        </button>
      </div>

      <!-- Script for interactions -->
      <script>
        // Reading Progress
        window.addEventListener(
          "scroll",
          () => {
            const winScroll =
              document.body.scrollTop || document.documentElement.scrollTop;
            const height =
              document.documentElement.scrollHeight -
              document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            const progressBar = document.getElementById("scroll-progress");
            if (progressBar) progressBar.style.width = scrolled + "%";
          },
          { passive: true },
        );

        // Share functionality
        const shareBtn = document.getElementById("share-btn");
        if (shareBtn) {
          shareBtn.addEventListener("click", async () => {
            if (navigator.share) {
              try {
                await navigator.share({
                  title: document.title,
                  url: window.location.href,
                });
              } catch (err) {
                console.log("Error sharing:", err);
              }
            } else {
              // Fallback: Copy to clipboard
              navigator.clipboard.writeText(window.location.href);
              const span = shareBtn.querySelector("span");
              if (span) {
                const originalText = span.innerText;
                span.innerText = "Lien copié !";
                setTimeout(() => {
                  span.innerText = originalText;
                }, 2000);
              }
            }
          });
        }
      </script>
    </div>
  </article>

  <!-- Project Navigation -->
  <nav
    class="container mx-auto max-w-5xl px-7 mb-12"
    aria-label="Navigation entre projets"
  >
    <div class="flex flex-col md:flex-row justify-between gap-4">
      {
        nextPost ? (
          <a
            href={`/project/${nextPost.slug}`}
            class="group flex items-center gap-4 p-4 rounded-2xl bg-white dark:bg-pacamara-dark border border-pacamara-secondary/10 hover:border-pacamara-accent/50 transition-all duration-300 w-full md:w-1/2"
          >
            <div class="flex-none">
              <span class="block text-xs text-pacamara-primary/50 dark:text-white/50 mb-1 uppercase tracking-wider">
                Projet précédent
              </span>
              <span class="text-lg font-bold font-pacamara-space text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors line-clamp-1">
                {nextPost.data.title}
              </span>
            </div>
          </a>
        ) : (
          <div class="w-full md:w-1/2" />
        )
      }

      {
        prevPost ? (
          <a
            href={`/project/${prevPost.slug}`}
            class="group flex items-center justify-end gap-4 p-4 rounded-2xl bg-white dark:bg-pacamara-dark border border-pacamara-secondary/10 hover:border-pacamara-accent/50 transition-all duration-300 w-full md:w-1/2 text-right"
          >
            <div class="flex-none">
              <span class="block text-xs text-pacamara-primary/50 dark:text-white/50 mb-1 uppercase tracking-wider">
                Projet suivant
              </span>
              <span class="text-lg font-bold font-pacamara-space text-pacamara-dark dark:text-white group-hover:text-pacamara-accent transition-colors line-clamp-1">
                {prevPost.data.title}
              </span>
            </div>
          </a>
        ) : (
          <div class="w-full md:w-1/2" />
        )
      }
    </div>
  </nav>

  <!-- CTA Section -->
  <div class="container mx-auto max-w-5xl px-7 mt-10 mb-20">
    <div
      class="bg-pacamara-accent/10 dark:bg-pacamara-accent/5 rounded-3xl p-8 md:p-12 text-center border border-pacamara-accent/20"
    >
      <h2
        class="text-3xl md:text-4xl font-pacamara-space font-bold mb-6 text-pacamara-dark dark:text-white"
      >
        Vous avez un projet similaire ?
      </h2>
      <p
        class="text-lg text-pacamara-primary/80 dark:text-white/80 mb-8 max-w-2xl mx-auto"
      >
        Discutons de vos idées et voyons comment nous pouvons collaborer pour
        créer quelque chose d'unique.
      </p>
      <a
        href="#contact-form"
        class="inline-flex items-center gap-2 px-8 py-4 bg-pacamara-accent text-white rounded-full font-bold text-lg shadow-lg hover:shadow-glow hover-lift transition-all duration-300"
      >
        <span>Discuter de votre projet</span>
        <Icon name="mdi:arrow-right" class="w-5 h-5" />
      </a>
    </div>
  </div>

  <!-- Author & Related -->
  <div class="container mx-auto max-w-5xl px-7 mb-20">
    <AuthorInfo authorData={author} />

    <div class="mt-20 pt-10 border-t border-pacamara-secondary/20">
      <h2
        class="text-2xl font-pacamara-space font-bold mb-10 text-center dark:text-white"
      >
        D'autres projets à découvrir
      </h2>
      <LatestPosts postLimit="2" skipPost={entry.data.title} />
    </div>
  </div>
</Base>
