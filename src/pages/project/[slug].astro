---
import { Picture, getImage } from "astro:assets";

import Base from "../../layouts/Base.astro";
import AuthorInfo from "../../components/features/projects/AuthorInfo.astro";
import LatestPosts from "../../components/features/projects/LatestPosts.astro";
import PublishDate from "../../components/features/projects/PublishDate.astro";
import Tag from "../../components/ui/Tag.astro";

import { Icon } from "astro-icon/components";
import VideoPlayer from "../../components/features/projects/VideoPlayer.astro";
import ImageGallery from "../../components/ui/ImageGallery.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";

import { getCollection, getEntry } from "astro:content";
import { sanitizeUrl } from "../../utils/security";

export async function getStaticPaths() {
  const allProjects = await getCollection("project");
  const projectEntries = allProjects.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

  return projectEntries.map((entry, index) => ({
    params: { slug: entry.slug },
    props: {
      entry,
      prevPost:
        index + 1 < projectEntries.length ? projectEntries[index + 1] : null,
      nextPost: index > 0 ? projectEntries[index - 1] : null,
      allProjects,
    },
  }));
}
const { entry, prevPost, nextPost, allProjects } = Astro.props;

// Calculate reading time
const wordCount = entry.body ? entry.body.split(/\s+/g).length : 0;
const readingTime = Math.ceil(wordCount / 200);

const { Content } = await entry.render();
const author = await getEntry(entry.data.author);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": entry.data.type === "video" ? "VideoObject" : "CreativeWork",
  headline: entry.data.title,
  description: entry.data.seoDescription || entry.data.intro,
  image: entry.data.image
    ? new URL(entry.data.image.src, Astro.url).toString()
    : undefined,
  datePublished: entry.data.pubDate.toISOString(),
  author: {
    "@type": "Person",
    name: "Samuel Dulex",
  },
  ...(entry.data.type === "video" && entry.data.videoUrl
    ? {
        contentUrl: entry.data.videoUrl,
        uploadDate: entry.data.pubDate.toISOString(),
        thumbnailUrl: entry.data.image
          ? new URL(entry.data.image.src, Astro.url).toString()
          : undefined,
      }
    : {}),
};

// ‚ö° Bolt: Generate optimized WebP poster for video player
// This prevents serving the original massive image or fetching external provider thumbnails
let optimizedPoster: string | null = null;
if (entry.data.type === "video" && entry.data.image) {
  const img = await getImage({
    src: entry.data.image,
    width: 1280, // HD is sufficient for video poster
    format: "webp",
    quality: 80,
  });
  optimizedPoster = img.src;
}
---

<Base postData={entry} jsonLd={jsonLd} noPadding={true}>
  <!-- Scroll Progress Bar -->
  <div
    class="fixed top-0 left-0 w-full h-1 z-50 bg-transparent pointer-events-none"
  >
    <div
      class="h-full bg-pacamara-accent w-0 transition-all duration-100 ease-out"
      id="scroll-progress"
    >
    </div>
  </div>

  <!-- Project Hero Section -->
  <section
    class="relative w-full h-screen min-h-[600px] flex items-end justify-center overflow-hidden pb-32"
  >
    {
      entry.data.image && (
        <div class="absolute inset-0 z-0">
          {/* Masque pour fondre l'image en haut et en bas */}
          <div class="relative w-full h-full mask-gradient-fade">
            <Picture
              src={entry.data.image}
              widths={[640, 960, 1280, 1600]}
              sizes="100vw"
              formats={["avif", "webp"]}
              fallbackFormat="webp"
              alt={entry.data.title}
              width={1600}
              height={800}
              class="w-full h-full object-cover"
              transition:name={`project-image-${entry.slug}`}
              quality={70}
              loading="eager"
              fetchpriority="high"
            />
            {/* Overlay adaptatif : Blanc en Light Mode, Noir en Dark Mode */}
            <div class="absolute inset-0 bg-linear-to-t from-white/95 via-white/70 to-transparent dark:from-black/90 dark:via-black/50 dark:to-transparent opacity-90" />
          </div>
        </div>
      )
    }

    <div class="relative z-10 container mx-auto px-7 text-center max-w-5xl">
      <div
        class="inline-flex items-center gap-3 mb-6 animate-fade-in opacity-0 delay-200"
      >
        <Tag tag={entry.data.tag} />
        <PublishDate date={entry.data.pubDate} />

        <span
          class="text-pacamara-primary/60 dark:text-white/60"
          aria-hidden="true">‚Ä¢</span
        >
        <span
          class="text-pacamara-primary/60 dark:text-white/60 text-sm font-outfit uppercase tracking-wider"
          >{readingTime} min de lecture</span
        >
      </div>
      <h1
        class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 text-pacamara-dark dark:text-white animate-slide-up opacity-0 leading-tight tracking-tight drop-shadow-sm dark:drop-shadow-lg delay-400"
      >
        {entry.data.title}
      </h1>
      {
        entry.data.intro && (
          <p class="text-xl md:text-2xl text-pacamara-primary/90 dark:text-white/90 max-w-3xl mx-auto animate-slide-up opacity-0 font-light leading-relaxed drop-shadow-sm dark:drop-shadow-md delay-500">
            {entry.data.intro}
          </p>
        )
      }
    </div>
  </section>

  <article class="container mx-auto max-w-5xl px-7 -mt-32 relative z-10">
    <!-- Video Player -->
    {
      entry.data.type === "video" && entry.data.videoUrl && (
        <div class="w-full rounded-3xl overflow-hidden shadow-2xl mb-16 mt-12 animate-slide-up opacity-0 ring-1 ring-white/10 delay-600 [content-visibility:auto] [contain-intrinsic-size:auto_500px]">
          <VideoPlayer
            videoUrl={entry.data.videoUrl}
            poster={optimizedPoster || entry.data.image?.src}
            videoTitle={entry.data.title}
          />
        </div>
      )
    }

    <!-- Photo Gallery -->
    {
      entry.data.type === "photo" &&
        entry.data.gallery &&
        entry.data.gallery.length > 0 && (
          <div class="w-full mb-16 animate-slide-up opacity-0 delay-600 [content-visibility:auto] [contain-intrinsic-size:auto_500px]">
            <ImageGallery images={entry.data.gallery} />
          </div>
        )
    }

    <!-- Content -->
    <div
      class="bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-xl rounded-3xl p-8 md:p-16 shadow-glass
            prose lg:prose-xl max-w-none
            prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-dark dark:prose-headings:text-white
            prose-p:text-pacamara-primary/80 dark:prose-p:text-white/80 prose-p:font-outfit prose-p:leading-relaxed
            prose-a:text-pacamara-accent hover:prose-a:text-pacamara-secondary prose-a:transition-colors
            prose-img:rounded-2xl prose-img:shadow-lg
            dark:prose-strong:text-white
            animate-fade-in opacity-0
            border border-white/20 dark:border-white/5 delay-800
            [content-visibility:auto] [contain-intrinsic-size:auto_800px]"
    >
      <Breadcrumbs
        items={[
          { label: "Accueil", href: "/" },
          { label: "Projets", href: "/project" },
          {
            label: entry.data.tag,
            href: sanitizeUrl(`/project/tag/${entry.data.tag}`),
          },
          { label: entry.data.title },
        ]}
      />
      <Content />

      <!-- Share Button & Navigation -->
      <div
        class="mt-12 pt-8 border-t border-pacamara-secondary/10 flex flex-col md:flex-row justify-between items-center gap-6"
      >
        <!-- üé® Palette: Enhanced Share Button
             Improved feedback, transitions, and accessibility (ARIA live)
        -->
        <button
          id="share-btn"
          class="group relative overflow-hidden rounded-full bg-pacamara-secondary/5 hover:bg-pacamara-secondary/10 dark:text-white transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
          aria-label="Partager ce projet"
        >
          <div
            class="grid grid-cols-1 grid-rows-1 place-items-center px-6 py-3"
          >
            <!-- Normal State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 group-[.copied]:opacity-0 group-[.copied]:translate-y-2"
            >
              <Icon name="mdi:share-variant" class="w-5 h-5" />
              <span class="font-medium">Partager ce projet</span>
            </div>
            <!-- Copied State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 opacity-0 -translate-y-2 group-[.copied]:opacity-100 group-[.copied]:translate-y-0 text-green-600 dark:text-green-400"
              aria-hidden="true"
            >
              <Icon name="mdi:check" class="w-5 h-5" />
              <span class="font-medium">Lien copi√© !</span>
            </div>
          </div>
        </button>
        <!-- Screen reader announcer for better accessibility support -->
        <div id="share-announcer" class="sr-only" aria-live="polite"></div>
        <!-- üé® Palette: Global announcer for code copy feedback -->
        <div id="code-copy-announcer" class="sr-only" aria-live="polite"></div>
      </div>

      <!-- Script for interactions -->
      <script>
        // Reading Progress
        const progressBar = document.getElementById("scroll-progress");

        if (progressBar) {
          let ticking = false;
          // ‚ö° Bolt: Cache document dimensions to avoid layout thrashing
          let cachedDocHeight = 0;
          let resizeObserver: ResizeObserver | null = null;

          const updateDimensions = () => {
            cachedDocHeight =
              document.documentElement.scrollHeight -
              document.documentElement.clientHeight;
          };

          const updateProgress = () => {
            const winScroll =
              document.body.scrollTop || document.documentElement.scrollTop;
            // ‚ö° Bolt: Use cached height instead of querying DOM (prevents reflow)
            const scrolled =
              cachedDocHeight > 0 ? (winScroll / cachedDocHeight) * 100 : 0;
            progressBar.style.width = scrolled + "%";
            ticking = false;
          };

          const onScroll = () => {
            if (!ticking) {
              window.requestAnimationFrame(updateProgress);
              ticking = true;
            }
          };

          window.addEventListener("scroll", onScroll, { passive: true });

          // ‚ö° Bolt: Observe document size changes
          resizeObserver = new ResizeObserver(() => {
            updateDimensions();
            // Update immediately in case resize affected relative scroll pos
            window.requestAnimationFrame(updateProgress);
          });
          resizeObserver.observe(document.documentElement);

          // Initial calculation
          updateDimensions();

          // Cleanup to prevent duplicate listeners on navigation
          document.addEventListener(
            "astro:before-swap",
            () => {
              window.removeEventListener("scroll", onScroll);
              if (resizeObserver) resizeObserver.disconnect();
            },
            { once: true },
          );
        }

        // Share functionality
        const shareBtn = document.getElementById("share-btn");
        const announcer = document.getElementById("share-announcer");

        if (shareBtn) {
          shareBtn.addEventListener("click", async () => {
            if (navigator.share) {
              try {
                await navigator.share({
                  title: document.title,
                  url: window.location.href,
                });
              } catch (err) {
                // üõ°Ô∏è Sentinel: Dev-only logging
                if (import.meta.env.DEV) {
                  // eslint-disable-next-line no-console
                  console.error(
                    "Error sharing:",
                    err instanceof Error ? err.message : "Unknown error",
                  );
                }
              }
            } else {
              // Fallback: Copy to clipboard
              try {
                await navigator.clipboard.writeText(window.location.href);

                // üé® Palette: Visual, Audible, and Haptic Feedback
                // Vibrate for 50ms on mobile devices
                if (navigator.vibrate) navigator.vibrate([50]);

                if (!shareBtn.classList.contains("copied")) {
                  shareBtn.classList.add("copied");

                  // Accessibility update
                  if (announcer) {
                    announcer.textContent = "Lien copi√© dans le presse-papiers";
                  }

                  setTimeout(() => {
                    shareBtn.classList.remove("copied");
                    if (announcer) {
                      announcer.textContent = "";
                    }
                  }, 2000);
                }
              } catch (err) {
                // üõ°Ô∏è Sentinel: Dev-only logging
                if (import.meta.env.DEV) {
                  // eslint-disable-next-line no-console
                  console.error("Failed to copy", err);
                }
              }
            }
          });
        }

        /**
         * üé® Palette: Add copy button to code blocks
         * Wraps code blocks and adds a copy button for better developer experience
         */
        function addCopyButtons() {
          const announcer = document.getElementById("code-copy-announcer");
          document.querySelectorAll(".prose pre").forEach((node) => {
            const pre = node as HTMLElement;
            if (pre.parentElement?.classList.contains("code-wrapper")) return;

            const wrapper = document.createElement("div");
            wrapper.className = "code-wrapper relative group mb-6";
            pre.parentNode?.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);

            const btn = document.createElement("button");
            btn.className =
              "absolute top-2 right-2 p-1.5 rounded-lg bg-white/10 text-white/70 opacity-0 group-hover:opacity-100 transition-all hover:bg-white/20 hover:text-white focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-pacamara-accent backdrop-blur-sm";
            btn.ariaLabel = "Copier le code";
            btn.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

            btn.addEventListener("click", async () => {
              try {
                await navigator.clipboard.writeText(
                  pre.textContent || pre.innerText,
                );
                btn.innerHTML =
                  '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><polyline points="20 6 9 17 4 12"></polyline></svg>';

                // üé® Palette: Announce success to screen readers
                if (announcer) {
                  announcer.textContent = "Code copi√© dans le presse-papiers";
                }

                setTimeout(() => {
                  btn.innerHTML =
                    '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
                  if (announcer) {
                    announcer.textContent = "";
                  }
                }, 2000);
              } catch (err) {
                if (import.meta.env.DEV) {
                  // eslint-disable-next-line no-console
                  console.error("Failed to copy code", err);
                }
              }
            });
            wrapper.appendChild(btn);
          });
        }

        addCopyButtons();
        // Re-run on navigation
        document.addEventListener("astro:after-swap", addCopyButtons);
      </script>
    </div>
  </article>

  <!-- Project Navigation -->
  <nav
    class="container mx-auto max-w-5xl px-7 mb-12 mt-12"
    aria-label="Navigation entre projets"
  >
    <div class="flex flex-col md:flex-row justify-between gap-4">
      {
        nextPost ? (
          <a
            href={sanitizeUrl(`/project/${nextPost.slug}`)}
            class="group flex items-center gap-4 p-4 rounded-2xl bg-white dark:bg-pacamara-dark border border-pacamara-secondary/10 hover:border-pacamara-accent/50 focus-visible:border-pacamara-accent/50 transition-all duration-300 w-full md:w-1/2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
            aria-label={`Projet pr√©c√©dent : ${nextPost.data.title}`}
          >
            <Icon
              name="mdi:arrow-left"
              class="w-8 h-8 text-pacamara-accent/60 group-hover:text-pacamara-accent group-hover:-translate-x-1 group-focus-visible:text-pacamara-accent group-focus-visible:-translate-x-1 transition-all duration-300"
              aria-hidden="true"
            />
            <div class="flex-1 text-left">
              <span class="block text-xs text-pacamara-primary/50 dark:text-white/50 mb-1 uppercase tracking-wider">
                Projet pr√©c√©dent
              </span>
              <span class="text-lg font-bold font-pacamara-space text-pacamara-dark dark:text-white group-hover:text-pacamara-accent group-focus-visible:text-pacamara-accent transition-colors line-clamp-1">
                {nextPost.data.title}
              </span>
            </div>
          </a>
        ) : (
          <div class="w-full md:w-1/2" />
        )
      }

      {
        prevPost ? (
          <a
            href={sanitizeUrl(`/project/${prevPost.slug}`)}
            class="group flex items-center justify-end gap-4 p-4 rounded-2xl bg-white dark:bg-pacamara-dark border border-pacamara-secondary/10 hover:border-pacamara-accent/50 focus-visible:border-pacamara-accent/50 transition-all duration-300 w-full md:w-1/2 text-right focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2"
            aria-label={`Projet suivant : ${prevPost.data.title}`}
          >
            <div class="flex-1 text-right">
              <span class="block text-xs text-pacamara-primary/50 dark:text-white/50 mb-1 uppercase tracking-wider">
                Projet suivant
              </span>
              <span class="text-lg font-bold font-pacamara-space text-pacamara-dark dark:text-white group-hover:text-pacamara-accent group-focus-visible:text-pacamara-accent transition-colors line-clamp-1">
                {prevPost.data.title}
              </span>
            </div>
            <Icon
              name="mdi:arrow-right"
              class="w-8 h-8 text-pacamara-accent/60 group-hover:text-pacamara-accent group-hover:translate-x-1 group-focus-visible:text-pacamara-accent group-focus-visible:translate-x-1 transition-all duration-300"
              aria-hidden="true"
            />
          </a>
        ) : (
          <div class="w-full md:w-1/2" />
        )
      }
    </div>
  </nav>

  <!-- CTA Section -->
  <div class="container mx-auto max-w-5xl px-7 mt-12 mb-20">
    <div
      class="bg-pacamara-accent/10 dark:bg-pacamara-accent/5 rounded-3xl p-8 md:p-12 text-center border border-pacamara-accent/20"
    >
      <h2
        class="text-3xl md:text-4xl font-pacamara-space font-bold mb-6 text-pacamara-dark dark:text-white"
      >
        Vous avez un projet similaire ?
      </h2>
      <p
        class="text-lg text-pacamara-primary/80 dark:text-white/80 mb-8 max-w-2xl mx-auto"
      >
        Discutons de vos id√©es et voyons comment nous pouvons collaborer pour
        cr√©er quelque chose d'unique.
      </p>
      <a
        href="/#cta-section"
        class="inline-flex items-center gap-2 px-8 py-4 bg-pacamara-accent text-white rounded-full font-bold text-lg shadow-lg hover:shadow-glow hover-lift transition-all duration-300"
      >
        <span>Discuter de votre projet</span>
        <Icon name="mdi:arrow-right" class="w-5 h-5" />
      </a>
    </div>
  </div>

  <!-- Author & Related -->
  <div class="container mx-auto max-w-5xl px-7 mb-20">
    <AuthorInfo authorData={author} />

    <div class="mt-20 pt-10 border-t border-pacamara-secondary/20">
      <h2
        class="text-2xl font-pacamara-space font-bold mb-10 text-center dark:text-white"
      >
        D'autres projets √† d√©couvrir
      </h2>
      {/* ‚ö° Bolt: Lazy load footer images to prioritize LCP */}
      <LatestPosts
        postLimit={2}
        skipPost={entry.data.title}
        lazyLoadImages={true}
        allPosts={allProjects}
      />
    </div>
  </div>
</Base>
