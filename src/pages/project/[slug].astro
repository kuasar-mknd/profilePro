---
import { Image } from 'astro:assets'

import Base from "../../layouts/Base.astro";
import AuthorInfo from "../../components/features/projects/AuthorInfo.astro";
import LatestPosts from "../../components/features/projects/LatestPosts.astro";
import PublishDate from "../../components/features/projects/PublishDate.astro";
import Tag from "../../components/ui/Tag.astro";
import Breadcrumbs from "../../components/ui/Breadcrumbs.astro";

import VideoPlayer from "../../components/features/projects/VideoPlayer.astro";
import PhotoGallery from "../../components/features/projects/PhotoGallery.astro";

import { getCollection, getEntry } from "astro:content";
import config from '../../config.mjs';

export async function getStaticPaths() {
  const projectEntries = await getCollection("project");

  return projectEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props;

const { Content } = await entry.render();
const author = await getEntry(entry.data.author);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": entry.data.type === 'video' ? "VideoObject" : "CreativeWork",
  "headline": entry.data.title,
  "description": entry.data.seoDescription || entry.data.intro,
  "image": entry.data.image ? new URL(entry.data.image.src, Astro.url).toString() : undefined,
  "datePublished": entry.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": "Samuel Dulex"
  },
  ...(entry.data.type === 'video' && entry.data.videoUrl ? {
    "contentUrl": entry.data.videoUrl,
    "uploadDate": entry.data.pubDate.toISOString(),
    "thumbnailUrl": entry.data.image ? new URL(entry.data.image.src, Astro.url).toString() : undefined
  } : {})
};
---

<Base postData={entry} jsonLd={jsonLd} noPadding={true}>
    <!-- Project Hero Section -->
    <section class="relative w-full h-screen min-h-[600px] flex items-end justify-center overflow-hidden pb-32">
        {entry.data.image && (
            <div class="absolute inset-0 z-0">
                <!-- Masque pour fondre l'image en haut et en bas -->
                <div class="relative w-full h-full" style="mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 30%, black 50%, transparent 100%);">
                    <Image 
                        src={entry.data.image} 
                        width={1920} 
                        height={1080} 
                        alt="" 
                        class="w-full h-full object-cover"
                        loading="eager"
                        fetchpriority="high"
                    />
                    <!-- Overlay adaptatif : Blanc en Light Mode, Noir en Dark Mode -->
                    <div class="absolute inset-0 bg-gradient-to-t from-white/95 via-white/70 to-transparent dark:from-black/90 dark:via-black/50 dark:to-transparent opacity-90"></div>
                </div>
            </div>
        )}
        
        <div class="relative z-10 container mx-auto px-7 text-center max-w-5xl">
            <div class="inline-flex items-center gap-3 mb-6 animate-fade-in opacity-0" style="animation-delay: 0.2s;">
                <Tag tag={entry.data.tag} />
                <PublishDate date={entry.data.pubDate} />
            </div>
            <h1 class="font-pacamara-space font-bold text-5xl md:text-7xl lg:text-8xl mb-6 text-pacamara-dark dark:text-white animate-slide-up opacity-0 leading-tight tracking-tight drop-shadow-sm dark:drop-shadow-lg" style="animation-delay: 0.4s;">
                {entry.data.title}
            </h1>
            {entry.data.intro && (
                <p class="text-xl md:text-2xl text-pacamara-primary/90 dark:text-white/90 max-w-3xl mx-auto animate-slide-up opacity-0 font-light leading-relaxed drop-shadow-sm dark:drop-shadow-md" style="animation-delay: 0.5s;">
                    {entry.data.intro}
                </p>
            )}
        </div>
    </section>

    <article class="container mx-auto px-7 max-w-screen-lg -mt-32 relative z-20">
        <!-- Video Player -->
        {entry.data.type === 'video' && entry.data.videoUrl && (
            <div class="w-full rounded-3xl overflow-hidden shadow-2xl mb-16 mt-12 animate-slide-up opacity-0 ring-1 ring-white/10" style="animation-delay: 0.6s;">
                <VideoPlayer videoUrl={entry.data.videoUrl} />
            </div>
        )}

        <!-- Photo Gallery -->
        {entry.data.type === 'photo' && entry.data.gallery && entry.data.gallery.length > 0 && (
            <div class="w-full mb-16 animate-slide-up opacity-0" style="animation-delay: 0.6s;">
                <PhotoGallery images={entry.data.gallery} />
            </div>
        )}

        <!-- Content -->
        <div class="
            bg-white/80 dark:bg-pacamara-dark/80 backdrop-blur-xl rounded-3xl p-8 md:p-16 shadow-glass
            prose lg:prose-xl max-w-none
            prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-dark dark:prose-headings:text-white
            prose-p:text-pacamara-primary/80 dark:prose-p:text-white/80 prose-p:font-outfit prose-p:leading-relaxed
            prose-a:text-pacamara-accent hover:prose-a:text-pacamara-secondary prose-a:transition-colors
            prose-img:rounded-2xl prose-img:shadow-lg
            dark:prose-strong:text-white
            animate-fade-in opacity-0
            border border-white/20 dark:border-white/5
        " style="animation-delay: 0.8s;">
            <div class="mb-8 flex items-center gap-2 text-sm text-pacamara-primary/50 dark:text-white/50">
                <a href="/" class="hover:text-pacamara-accent transition-colors">Accueil</a>
                <span>/</span>
                <a href={`/project/tag/${entry.data.tag}`} class="hover:text-pacamara-accent transition-colors capitalize">{entry.data.tag}</a>
                <span>/</span>
                <span class="text-pacamara-primary dark:text-white truncate">{entry.data.title}</span>
            </div>
            <Content />
        </div>
    </article>

    <!-- CTA Section -->
    <section class="container mx-auto px-7 max-w-screen-lg mt-10 mb-20">
        <div class="bg-pacamara-accent/10 dark:bg-pacamara-accent/5 rounded-3xl p-8 md:p-12 text-center border border-pacamara-accent/20">
            <h2 class="text-3xl md:text-4xl font-pacamara-space font-bold mb-6 text-pacamara-dark dark:text-white">Vous avez un projet similaire ?</h2>
            <p class="text-lg text-pacamara-primary/80 dark:text-white/80 mb-8 max-w-2xl mx-auto">
                Discutons de vos idées et voyons comment nous pouvons collaborer pour créer quelque chose d'unique.
            </p>
            <a href="mailto:samuel@edulex.ch" class="inline-block bg-pacamara-accent hover:bg-pacamara-secondary text-white font-bold py-4 px-8 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                Parlons-en
            </a>
        </div>
    </section>

    <!-- Author & Related -->
    <div class="container mx-auto px-7 max-w-screen-lg mb-20">
        <AuthorInfo authorData={author} />
        
        <div class="mt-20 pt-10 border-t border-pacamara-secondary/20">
            <h2 class="text-2xl font-pacamara-space font-bold mb-10 text-center dark:text-white">D'autres projets à découvrir</h2>
            <LatestPosts postLimit=2 skipPost={entry.data.title} />
        </div>
    </div>
</Base>
