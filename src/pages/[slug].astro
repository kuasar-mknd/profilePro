---
import { Image, Picture } from "astro:assets";

import Base from "../layouts/Base.astro";

import { getCollection, getEntry } from "astro:content";

export async function getStaticPaths() {
  const projectEntries = await getCollection("project");

  return projectEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props;

const { Content } = await entry.render();

// Calculate Reading Time
const wordCount = entry.body.split(/\s+/g).length;
const readingTime = Math.ceil(wordCount / 200);
---

<Base postData={entry}>
  <article class="px-7 pt-10 mx-auto w-full">
    <div
      class="mx-auto
      prose lg:prose-xl prose-headings:font-bold prose-headings:text-pacamara-dark prose-headings:mb-3"
    >
      <h1 class="transition-all duration-300 dark:text-white text-balance">
        {entry.data.title}
      </h1>
      <div
        class="flex items-center gap-4 mt-4 text-sm text-pacamara-primary/60 dark:text-white/60 font-outfit"
      >
        <span>⏱️ {readingTime} min de lecture</span>
        <button
          id="share-btn"
          class="flex items-center gap-2 hover:text-pacamara-accent transition-colors duration-300 bg-transparent border-0 cursor-pointer"
          aria-label="Partager cet article"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="w-4 h-4"
          >
            <path
              d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"
            ></path>
          </svg>
          Partager
        </button>
      </div>
    </div>
    {
      entry.data.image && (
        <Picture
          src={entry.data.image}
          widths={[400, 800, 1200]}
          sizes="(max-width: 768px) 100vw, 800px"
          formats={["avif", "webp"]}
          fallbackFormat="webp"
          alt={entry.data.title}
          width={1200}
          height={600}
          loading="eager"
          decoding="sync"
          fetchpriority="high"
          class="block relative mx-auto mt-10 object-cover h-72 md:h-[350px] image-shine rounded-[15px]"
          transition:name={`project-image-${entry.slug}`}
          quality={75}
        />
      )
    }
    <div
      class="lg:px-0 pt-10 mb-5 mx-auto
            prose lg:prose-xl
            prose-headings:transition-all prose-headings:duration-300 prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-accent prose-headings:mb-0 prose-headings:pb-3 prose-headings:mt-6
            prose-p:transition-all prose-p:duration-300 prose-p:text-pacamara-primary/80
            prose-li:transition-all prose-li:duration-300 prose-li:text-pacamara-primary/80
            prose-td:transition-all prose-td:duration-300 prose-td:text-pacamara-primary/80
            prose-a:underline prose-a:font-semibold prose-a:transition-all prose-a:duration-300 prose-a:text-pacamara-accent hover:prose-a:text-pacamara-dark
            prose-strong:transition-all prose-strong:duration-300 prose-strong:font-bold
            prose-hr:transition-all prose-hr:duration-300 prose-hr:border-pacamara-secondary/40
            prose-img:rounded-xl prose-img:mx-auto
            prose-code:transition-all prose-code:duration-300 prose-code:text-pacamara-dark
            dark:prose-headings:text-pacamara-accent dark:prose-p:text-white/70 dark:prose-a:text-white dark:hover:prose-a:text-pacamara-accent dark:prose-strong:text-white dark:prose-li:text-white dark:prose-code:text-white dark:prose-td:text-white/70 dark:prose-hr:border-pacamara-accent/30 dark:prose-tr:border-pacamara-accent/30 dark:prose-thead:border-pacamara-accent/30"
    >
      <Content />
    </div>
  </article>
</Base>

<script>
  const shareBtn = document.getElementById("share-btn");
  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href,
          });
        } catch (err) {
          console.log("Error sharing:", err);
        }
      } else {
        // Fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);
          const originalText = shareBtn.innerHTML;
          shareBtn.innerHTML = "Lien copié !";
          setTimeout(() => {
            shareBtn.innerHTML = originalText;
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
        }
      }
    });
  }
</script>
