---
import Base from "../layouts/Base.astro";
import { getCollection, render } from "astro:content";
import ProjectFilter from "../components/features/projects/ProjectFilter.astro";
import LatestPosts from "../components/features/projects/LatestPosts.astro";
import Tag from "../components/ui/Tag.astro";
import CTASection from "../components/common/CTASection.astro";
import { Icon } from "astro-icon/components";
import Breadcrumbs from "../components/ui/Breadcrumbs.astro";

export async function getStaticPaths() {
  const projects = await getCollection("project");
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

const allProjects = await getCollection("project");
const tags = [...new Set(allProjects.flatMap((p) => [p.data.tag]))].sort();

// Metadata and structured data
const title = `${project.data.title} | Projets | Samuel Dulex`;
const description = project.data.seoDescription || project.data.intro;
const image = project.data.image;
---

<Base {title} {description} {image}>
  <main class="pt-32 pb-20">
    <div class="container mx-auto px-6">
      <Breadcrumbs
        items={[
          { label: "Accueil", href: "/" },
          { label: "Projets", href: "/project" },
          { label: project.data.title, href: `/${project.id}` },
        ]}
      />

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 mt-8">
        {/* Sidebar */}
        <aside class="lg:col-span-3 space-y-8 order-2 lg:order-1">
          <ProjectFilter tags={tags} activeTag={null} />
          <LatestPosts />

          <div
            class="p-6 bg-pacamara-secondary/5 dark:bg-white/5 rounded-2xl border border-pacamara-secondary/10 dark:border-white/10"
          >
            <h3
              class="text-sm font-bold uppercase tracking-wider text-pacamara-primary/40 dark:text-white/40 mb-4"
            >
              Partager ce projet
            </h3>
            <div class="flex gap-4">
              <button
                class="share-btn p-3 bg-white dark:bg-pacamara-dark rounded-xl border border-pacamara-secondary/10 dark:border-white/10 text-pacamara-primary dark:text-white hover:border-pacamara-accent transition-colors group relative"
                title="Partager sur les r√©seaux"
                id="share-project"
                aria-label="Partager ce projet"
              >
                <Icon
                  name="mdi:share-variant"
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                />
                <span id="share-announcer" class="sr-only" aria-live="polite"
                ></span>
              </button>
            </div>
          </div>
        </aside>

        {/* Content */}
        <article class="lg:col-span-9 order-1 lg:order-2">
          <header class="mb-12">
            <div class="flex flex-wrap gap-2 mb-6">
              {[project.data.tag].map((tag) => <Tag {tag} />)}
            </div>
            <h1
              class="text-4xl md:text-6xl font-bold text-pacamara-primary dark:text-white mb-6"
            >
              {project.data.title}
            </h1>
            <p
              class="text-xl text-pacamara-primary/60 dark:text-white/60 leading-relaxed max-w-3xl"
            >
              {project.data.intro}
            </p>
          </header>

          <div
            class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-pacamara-accent prose-img:rounded-3xl shadow-xl"
          >
            <Content />
          </div>
        </article>
      </div>
    </div>
  </main>

  <CTASection />
</Base>

<style>
  .share-btn.copied::after {
    content: "Copi√© !";
    position: absolute;
    top: -2.5rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--color-pacamara-accent);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    opacity: 1;
    transition: opacity 0.2s;
  }
</style>

<script>
  const shareBtn = document.getElementById("share-project");
  const announcer = document.getElementById("share-announcer");

  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            text: "D√©couvrez ce projet sur le portfolio de Samuel Dulex",
            url: window.location.href,
          });
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            // eslint-disable-next-line no-console
            console.error(
              "Error sharing:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      } else {
        // Fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);

          // üé® Palette: Haptic Feedback
          if (navigator.vibrate) navigator.vibrate(50);

          shareBtn.classList.add("copied");
          if (announcer) {
            announcer.textContent = "Lien copi√© dans le presse-papier";
          }

          setTimeout(() => {
            shareBtn.classList.remove("copied");
            if (announcer) {
              announcer.textContent = "";
            }
          }, 2000);
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            // eslint-disable-next-line no-console
            console.error(
              "Failed to copy:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      }
    });
  }
</script>
