---
import { Picture } from "astro:assets";
import { Icon } from "astro-icon/components";

import Base from "../layouts/Base.astro";

import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projectEntries = await getCollection("project");

  return projectEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props;

const { Content } = await entry.render();

// Calculate Reading Time
const wordCount = entry.body.split(/\s+/g).length;
const readingTime = Math.ceil(wordCount / 200);
---

<Base postData={entry}>
  <article class="px-7 pt-10 mx-auto w-full">
    <div
      class="mx-auto
      prose lg:prose-xl prose-headings:font-bold prose-headings:text-pacamara-dark prose-headings:mb-3"
    >
      <h1 class="transition-all duration-300 dark:text-white text-balance">
        {entry.data.title}
      </h1>
      <div
        class="flex items-center gap-4 mt-4 text-sm text-pacamara-primary/60 dark:text-white/60 font-outfit"
      >
        <span>‚è±Ô∏è {readingTime} min de lecture</span>

        <!-- üé® Palette: Enhanced Share Button -->
        <button
          id="share-btn"
          class="group relative overflow-hidden rounded-full bg-transparent hover:bg-pacamara-secondary/5 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 px-3 py-1 -mx-3"
          aria-label="Partager cet article"
          title="Partager cet article"
        >
          <div class="grid grid-cols-1 grid-rows-1 place-items-center">
            <!-- Normal State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 group-[.copied]:opacity-0 group-[.copied]:translate-y-2"
            >
              <Icon name="mdi:share-variant" class="w-4 h-4" />
              <span>Partager</span>
            </div>
            <!-- Copied State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 opacity-0 -translate-y-2 group-[.copied]:opacity-100 group-[.copied]:translate-y-0 text-green-600 dark:text-green-400"
              aria-hidden="true"
            >
              <Icon name="mdi:check" class="w-4 h-4" />
              <span>Copi√© !</span>
            </div>
          </div>
        </button>
        <!-- Screen reader announcer -->
        <div id="share-announcer" class="sr-only" aria-live="polite"></div>
      </div>
    </div>
    {
      entry.data.image && (
        <Picture
          src={entry.data.image}
          widths={[400, 800, 1200]}
          sizes="(max-width: 768px) 100vw, 800px"
          formats={["webp"]}
          fallbackFormat="webp"
          alt={entry.data.title}
          width={1200}
          height={600}
          loading="eager"
          decoding="sync"
          fetchpriority="high"
          class="block relative mx-auto mt-10 object-cover h-72 md:h-[350px] image-shine rounded-[15px]"
          transition:name={`project-image-${entry.slug}`}
          quality={75}
        />
      )
    }
    <div
      class="lg:px-0 pt-10 mb-5 mx-auto
            prose lg:prose-xl
            prose-headings:transition-all prose-headings:duration-300 prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-accent prose-headings:mb-0 prose-headings:pb-3 prose-headings:mt-6
            prose-p:transition-all prose-p:duration-300 prose-p:text-pacamara-primary/80
            prose-li:transition-all prose-li:duration-300 prose-li:text-pacamara-primary/80
            prose-td:transition-all prose-td:duration-300 prose-td:text-pacamara-primary/80
            prose-a:underline prose-a:font-semibold prose-a:transition-all prose-a:duration-300 prose-a:text-pacamara-accent hover:prose-a:text-pacamara-dark
            prose-strong:transition-all prose-strong:duration-300 prose-strong:font-bold
            prose-hr:transition-all prose-hr:duration-300 prose-hr:border-pacamara-secondary/40
            prose-img:rounded-xl prose-img:mx-auto
            prose-code:transition-all prose-code:duration-300 prose-code:text-pacamara-dark
            dark:prose-headings:text-pacamara-accent dark:prose-p:text-white/70 dark:prose-a:text-white dark:hover:prose-a:text-pacamara-accent dark:prose-strong:text-white dark:prose-li:text-white dark:prose-code:text-white dark:prose-td:text-white/70 dark:prose-hr:border-pacamara-accent/30 dark:prose-tr:border-pacamara-accent/30 dark:prose-thead:border-pacamara-accent/30"
    >
      <Content />
    </div>
  </article>
</Base>

<script>
  const shareBtn = document.getElementById("share-btn");
  const announcer = document.getElementById("share-announcer");

  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href,
          });
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            console.error(
              "Error sharing:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      } else {
        // Fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);

          // üé® Palette: Haptic Feedback
          if (navigator.vibrate) navigator.vibrate([50]);

          if (!shareBtn.classList.contains("copied")) {
            shareBtn.classList.add("copied");

            // Accessibility update
            if (announcer) {
              announcer.textContent = "Lien copi√© dans le presse-papiers";
            }

            setTimeout(() => {
              shareBtn.classList.remove("copied");
              if (announcer) {
                announcer.textContent = "";
              }
            }, 2000);
          }
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            console.error(
              "Failed to copy:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      }
    });
  }
</script>
