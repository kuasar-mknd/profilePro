---
import { Picture } from "astro:assets";
import { Icon } from "astro-icon/components";

import Base from "../layouts/Base.astro";
import { getReadingTime } from "../utils/readingTime";

import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projectEntries = await getCollection("project");

  return projectEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props;

const { Content } = await entry.render();

// Calculate Reading Time
const readingTime = getReadingTime(entry.body);
---

<Base postData={entry}>
  <article class="px-7 pt-10 mx-auto w-full">
    <div
      class="mx-auto
      prose lg:prose-xl prose-headings:font-bold prose-headings:text-pacamara-dark prose-headings:mb-3"
    >
      <h1 class="transition-all duration-300 dark:text-white text-balance">
        {entry.data.title}
      </h1>
      <div
        class="flex items-center gap-4 mt-4 text-sm text-pacamara-primary/60 dark:text-white/60 font-outfit"
      >
        <span>‚è±Ô∏è {readingTime} min de lecture</span>

        <!-- üé® Palette: Enhanced Share Button -->
        <button
          id="share-btn"
          class="group relative overflow-hidden rounded-full bg-transparent hover:bg-pacamara-secondary/5 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-pacamara-accent focus-visible:ring-offset-2 px-3 py-1 -mx-3"
          aria-label="Partager cet article"
          title="Partager cet article"
        >
          <div class="grid grid-cols-1 grid-rows-1 place-items-center">
            <!-- Normal State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 group-[.copied]:opacity-0 group-[.copied]:translate-y-2"
            >
              <Icon name="mdi:share-variant" class="w-4 h-4" />
              <span>Partager</span>
            </div>
            <!-- Copied State -->
            <div
              class="col-start-1 row-start-1 flex items-center gap-2 transition-all duration-300 opacity-0 -translate-y-2 group-[.copied]:opacity-100 group-[.copied]:translate-y-0 text-green-600 dark:text-green-400"
              aria-hidden="true"
            >
              <Icon name="mdi:check" class="w-4 h-4" />
              <span>Copi√© !</span>
            </div>
          </div>
        </button>
        <!-- Screen reader announcer -->
        <div id="share-announcer" class="sr-only" aria-live="polite"></div>
        <!-- üé® Palette: Global announcer for code copy feedback -->
        <div id="code-copy-announcer" class="sr-only" aria-live="polite"></div>
      </div>
    </div>
    {
      entry.data.image && (
        <Picture
          src={entry.data.image}
          widths={[400, 800, 1200]}
          sizes="(max-width: 768px) 100vw, 800px"
          formats={["avif", "webp"]}
          fallbackFormat="webp"
          alt={entry.data.title}
          width={1200}
          height={600}
          loading="eager"
          decoding="sync"
          fetchpriority="high"
          class="block relative mx-auto mt-10 object-cover h-72 md:h-[350px] image-shine rounded-[15px]"
          transition:name={`project-image-${entry.slug}`}
          quality={75}
        />
      )
    }
    <div
      class="lg:px-0 pt-10 mb-5 mx-auto
            prose lg:prose-xl
            prose-headings:transition-all prose-headings:duration-300 prose-headings:font-pacamara-space prose-headings:font-bold prose-headings:text-pacamara-accent prose-headings:mb-0 prose-headings:pb-3 prose-headings:mt-6
            prose-p:transition-all prose-p:duration-300 prose-p:text-pacamara-primary/80
            prose-li:transition-all prose-li:duration-300 prose-li:text-pacamara-primary/80
            prose-td:transition-all prose-td:duration-300 prose-td:text-pacamara-primary/80
            prose-a:underline prose-a:font-semibold prose-a:transition-all prose-a:duration-300 prose-a:text-pacamara-accent hover:prose-a:text-pacamara-dark
            prose-strong:transition-all prose-strong:duration-300 prose-strong:font-bold
            prose-hr:transition-all prose-hr:duration-300 prose-hr:border-pacamara-secondary/40
            prose-img:rounded-xl prose-img:mx-auto
            prose-code:transition-all prose-code:duration-300 prose-code:text-pacamara-dark
            dark:prose-headings:text-pacamara-accent dark:prose-p:text-white/70 dark:prose-a:text-white dark:hover:prose-a:text-pacamara-accent dark:prose-strong:text-white dark:prose-li:text-white dark:prose-code:text-white dark:prose-td:text-white/70 dark:prose-hr:border-pacamara-accent/30 dark:prose-tr:border-pacamara-accent/30 dark:prose-thead:border-pacamara-accent/30"
    >
      <Content />
    </div>
  </article>
</Base>

<script>
  const shareBtn = document.getElementById("share-btn");
  const announcer = document.getElementById("share-announcer");

  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href,
          });
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            // eslint-disable-next-line no-console
            console.error(
              "Error sharing:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      } else {
        // Fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);

          // üé® Palette: Haptic Feedback
          if (navigator.vibrate) navigator.vibrate([50]);

          if (!shareBtn.classList.contains("copied")) {
            shareBtn.classList.add("copied");

            // Accessibility update
            if (announcer) {
              announcer.textContent = "Lien copi√© dans le presse-papiers";
            }

            setTimeout(() => {
              shareBtn.classList.remove("copied");
              if (announcer) {
                announcer.textContent = "";
              }
            }, 2000);
          }
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            // eslint-disable-next-line no-console
            console.error(
              "Failed to copy:",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      }
    });
  }

  /**
   * üé® Palette: Add copy button to code blocks
   * Wraps code blocks and adds a copy button for better developer experience
   */
  function addCopyButtons() {
    const announcer = document.getElementById("code-copy-announcer");
    document.querySelectorAll(".prose pre").forEach((node) => {
      const pre = node as HTMLElement;
      if (pre.parentElement?.classList.contains("code-wrapper")) return;

      const wrapper = document.createElement("div");
      wrapper.className = "code-wrapper relative group mb-6";
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      const btn = document.createElement("button");
      btn.className =
        "absolute top-2 right-2 p-1.5 rounded-lg bg-white/10 text-white/70 opacity-0 group-hover:opacity-100 transition-all hover:bg-white/20 hover:text-white focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-pacamara-accent backdrop-blur-sm";
      btn.ariaLabel = "Copier le code";

      // üõ°Ô∏è Sentinel: Safe DOM construction to prevent innerHTML usage
      const createIcon = (isCheck = false) => {
        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg",
        );
        svg.setAttribute("width", "18");
        svg.setAttribute("height", "18");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("fill", "none");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke-linecap", "round");
        svg.setAttribute("stroke-linejoin", "round");

        if (isCheck) {
          svg.setAttribute("class", "text-green-400");
          const polyline = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "polyline",
          );
          polyline.setAttribute("points", "20 6 9 17 4 12");
          svg.appendChild(polyline);
        } else {
          const rect = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "rect",
          );
          rect.setAttribute("x", "9");
          rect.setAttribute("y", "9");
          rect.setAttribute("width", "13");
          rect.setAttribute("height", "13");
          rect.setAttribute("rx", "2");
          rect.setAttribute("ry", "2");
          svg.appendChild(rect);

          const path = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path",
          );
          path.setAttribute(
            "d",
            "M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1",
          );
          svg.appendChild(path);
        }
        return svg;
      };

      btn.appendChild(createIcon(false));

      btn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(pre.textContent || pre.innerText);
          btn.replaceChildren(createIcon(true));

          // üé® Palette: Announce success to screen readers
          if (announcer) {
            announcer.textContent = "Code copi√© dans le presse-papiers";
          }

          setTimeout(() => {
            btn.replaceChildren(createIcon(false));
            if (announcer) {
              announcer.textContent = "";
            }
          }, 2000);
        } catch (err) {
          // üõ°Ô∏è Sentinel: Dev-only logging
          if (import.meta.env.DEV) {
            // eslint-disable-next-line no-console
            console.error(
              "Failed to copy code",
              err instanceof Error ? err.message : "Unknown error",
            );
          }
        }
      });
      wrapper.appendChild(btn);
    });
  }

  addCopyButtons();
  // Re-run on navigation
  document.addEventListener("astro:after-swap", addCopyButtons);
</script>
